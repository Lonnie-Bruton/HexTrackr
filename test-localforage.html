<!DOCTYPE html>
<html>
<head>
    <title>LocalForage Test</title>
    <script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body>
    <h1>LocalForage Test</h1>
    <button onclick="testLocalForage()">Test LocalForage</button>
    <button onclick="testCSVImport()">Test CSV Import</button>
    <div id="output"></div>

    <script>
        // Configure localforage
        localforage.config({
            driver: localforage.INDEXEDDB,
            name: 'hextrackr',
            storeName: 'vulnerabilities'
        });

        async function testLocalForage() {
            const output = document.getElementById('output');
            try {
                // Test basic localforage functionality
                await localforage.setItem('test_key', 'test_value');
                const value = await localforage.getItem('test_key');
                output.innerHTML = `<p>LocalForage Test: ${value === 'test_value' ? 'PASS' : 'FAIL'}</p>`;
            } catch (error) {
                output.innerHTML = `<p>LocalForage Test: ERROR - ${error.message}</p>`;
            }
        }

        async function testCSVImport() {
            const csvData = `age_in_days,asset.id,asset.ipv4_addresses,asset.name,definition.cve,definition.description,definition.family,definition.id,definition.name,definition.plugin_updated,definition.vpr.score,definition.vpr_v2.drivers_cve_id,definition.vpr_v2.score,definition.vulnerability_published,id,port,protocol,resurfaced_date,severity,state,vuln_age,vuln_sla_date
15,host001-guid-1234,192.168.1.100,SW-CORE-01,CVE-2024-1234,"Cisco IOS XE Software Command Injection - Test Description",Cisco,12345,Cisco IOS XE Command Injection,2024-08-15T10:30:00.000Z,7.5,CVE-2024-1234,7.5,2024-08-01T00:00:00.000Z,vuln001,22,TCP,2024-08-10T09:15:00.000Z,High,Open,15,2024-09-10T00:00:00.000Z`;

            const output = document.getElementById('output');
            try {
                // Parse CSV
                const results = Papa.parse(csvData, {
                    header: true,
                    skipEmptyLines: true
                });

                if (results.errors.length > 0) {
                    throw new Error('CSV parsing errors: ' + results.errors.map(e => e.message).join(', '));
                }

                const vulnerabilities = results.data.map((row, index) => ({
                    id: row.id || `vuln_${Date.now()}_${index}`,
                    hostname: row['asset.name'] || '',
                    ip_address: row['asset.ipv4_addresses'] || '',
                    cve_id: row['definition.cve'] || '',
                    description: row['definition.description'] || '',
                    severity: row.severity || '',
                    vpr_score: parseFloat(row['definition.vpr.score']) || 0,
                    state: row.state || '',
                    port: row.port || '',
                    protocol: row.protocol || '',
                    family: row['definition.family'] || '',
                    age_in_days: parseInt(row.age_in_days) || 0,
                    vuln_published: row['definition.vulnerability_published'] || '',
                    plugin_updated: row['definition.plugin_updated'] || ''
                }));

                // Store in localforage
                await localforage.setItem('hextrackr_vuln_data', vulnerabilities);
                
                // Verify storage
                const stored = await localforage.getItem('hextrackr_vuln_data');
                
                output.innerHTML += `<p>CSV Import Test: ${stored && stored.length === vulnerabilities.length ? 'PASS' : 'FAIL'}</p>`;
                output.innerHTML += `<p>Stored ${stored ? stored.length : 0} vulnerabilities</p>`;
                
            } catch (error) {
                output.innerHTML += `<p>CSV Import Test: ERROR - ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>
