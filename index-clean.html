<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HexTrackr - Vulnerability Management Dashboard</title>
    
    <!-- External Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Custom Styles -->
    <link href="styles.css" rel="stylesheet">
    
    <style>
        .hex-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .upload-area {
            transition: all 0.3s ease;
        }
        .upload-area:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .severity-card {
            transition: all 0.3s ease;
        }
        .severity-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.15);
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="hex-gradient text-white shadow-xl">
        <div class="container mx-auto px-6 py-8">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <i class="fas fa-shield-alt text-4xl"></i>
                    <div>
                        <h1 class="text-3xl font-bold">HexTrackr</h1>
                        <p class="text-blue-100">Vulnerability Priority Risk Management</p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <button id="toolsButton" class="inline-flex items-center px-4 py-2 bg-white/10 hover:bg-white/20 text-white rounded-lg transition-all duration-200 backdrop-blur-sm border border-white/20 hover:border-white/30">
                        <i class="fas fa-cog mr-2"></i>
                        Tools
                    </button>
                    
                    <div class="hidden lg:flex space-x-2">
                        <button id="uploadCsvButton" class="btn btn-sm bg-white/20 hover:bg-white/30 text-white border-white/20 hover:border-white/40 transition-all duration-200">
                            <i class="fas fa-upload mr-2"></i>Upload CSV
                        </button>
                        <a href="tickets.html" class="btn btn-sm bg-white/20 hover:bg-white/30 text-white border-white/20 hover:border-white/40 transition-all duration-200">
                            <i class="fas fa-ticket-alt mr-2"></i>Tickets
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Upload Area -->
            <div class="mt-8">
                <div class="upload-area border-2 border-dashed border-white/30 rounded-lg p-8 text-center hover:border-white/50 hover:bg-white/5 transition-all duration-200 cursor-pointer" id="uploadArea">
                    <div class="max-w-md mx-auto">
                        <div class="mb-4">
                            <i class="fas fa-cloud-upload-alt text-6xl text-white/70"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-white mb-2">Drop CSV files here</h3>
                        <p class="text-white/80 mb-4">or click to select files</p>
                        
                        <input type="file" id="fileInput" class="hidden" accept=".csv" multiple>
                        <button id="selectFileButton" class="inline-flex items-center px-6 py-3 bg-white text-blue-600 font-medium rounded-lg hover:bg-blue-50 transition-colors duration-200 shadow-md hover:shadow-lg">
                            <i class="fas fa-folder-open mr-2"></i>
                            Select Files
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-8">
        <!-- Statistics Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Critical -->
            <div id="criticalCard" class="severity-card bg-white rounded-xl shadow-lg border-l-4 border-red-500 hover:shadow-xl cursor-pointer group" data-severity="critical">
                <div class="p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-red-600 text-sm font-medium uppercase tracking-wider">Critical VPR</p>
                            <h2 class="text-3xl font-bold text-red-600" id="criticalValue">0.0</h2>
                        </div>
                        <div class="bg-red-100 p-3 rounded-full group-hover:bg-red-200 transition-colors duration-200">
                            <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- High -->
            <div id="highCard" class="severity-card bg-white rounded-xl shadow-lg border-l-4 border-orange-500 hover:shadow-xl cursor-pointer group" data-severity="high">
                <div class="p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-orange-600 text-sm font-medium uppercase tracking-wider">High VPR</p>
                            <h2 class="text-3xl font-bold text-orange-600" id="highValue">0.0</h2>
                        </div>
                        <div class="bg-orange-100 p-3 rounded-full group-hover:bg-orange-200 transition-colors duration-200">
                            <i class="fas fa-fire text-orange-600 text-xl"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Medium -->
            <div id="mediumCard" class="severity-card bg-white rounded-xl shadow-lg border-l-4 border-yellow-500 hover:shadow-xl cursor-pointer group" data-severity="medium">
                <div class="p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-yellow-600 text-sm font-medium uppercase tracking-wider">Medium VPR</p>
                            <h2 class="text-3xl font-bold text-yellow-600" id="mediumValue">0.0</h2>
                        </div>
                        <div class="bg-yellow-100 p-3 rounded-full group-hover:bg-yellow-200 transition-colors duration-200">
                            <i class="fas fa-shield-alt text-yellow-600 text-xl"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Low -->
            <div id="lowCard" class="severity-card bg-white rounded-xl shadow-lg border-l-4 border-green-500 hover:shadow-xl cursor-pointer group" data-severity="low">
                <div class="p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-green-600 text-sm font-medium uppercase tracking-wider">Low VPR</p>
                            <h2 class="text-3xl font-bold text-green-600" id="lowValue">0.0</h2>
                        </div>
                        <div class="bg-green-100 p-3 rounded-full group-hover:bg-green-200 transition-colors duration-200">
                            <i class="fas fa-check-shield text-green-600 text-xl"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Status -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-semibold text-gray-800">Data Status</h3>
                    <p id="dataStatus" class="text-gray-600 mt-1">No data loaded. Please upload a CSV file.</p>
                </div>
                <div class="flex space-x-3">
                    <button id="refreshButton" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh
                    </button>
                    <button id="exportButton" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors duration-200">
                        <i class="fas fa-download mr-2"></i>Export
                    </button>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-800">Vulnerability Data</h3>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hostname</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CVE</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Severity</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">VPR Score</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Definition</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                                <i class="fas fa-database text-4xl mb-2 block"></i>
                                No data available. Upload a CSV file to get started.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Toast Container -->
    <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <!-- JavaScript -->
    <script>
        // Global state
        let vulnData = [];
        let currentStats = {
            critical: 0,
            high: 0,
            medium: 0,
            low: 0,
            total: 0
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('HexTrackr Dashboard initializing...');
            initializeApp();
        });

        function initializeApp() {
            setupEventListeners();
            loadExistingData();
            updateDisplay();
            showToast('HexTrackr Dashboard ready', 'success');
        }

        function setupEventListeners() {
            // File input handlers
            const fileInput = document.getElementById('fileInput');
            const uploadArea = document.getElementById('uploadArea');
            const selectFileButton = document.getElementById('selectFileButton');
            const uploadCsvButton = document.getElementById('uploadCsvButton');

            // File selection
            selectFileButton?.addEventListener('click', () => fileInput?.click());
            uploadCsvButton?.addEventListener('click', () => fileInput?.click());
            
            // File input change
            fileInput?.addEventListener('change', handleFileUpload);

            // Drag and drop
            uploadArea?.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('border-white/50', 'bg-white/10');
            });

            uploadArea?.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('border-white/50', 'bg-white/10');
            });

            uploadArea?.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('border-white/50', 'bg-white/10');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    processFiles(files);
                }
            });

            uploadArea?.addEventListener('click', () => fileInput?.click());

            // Other buttons
            document.getElementById('refreshButton')?.addEventListener('click', refreshData);
            document.getElementById('exportButton')?.addEventListener('click', exportData);
        }

        function handleFileUpload(event) {
            const files = event.target.files;
            if (files.length > 0) {
                processFiles(files);
            }
        }

        function processFiles(files) {
            Array.from(files).forEach(file => {
                if (file.type === 'text/csv' || file.name.endsWith('.csv')) {
                    processCSVFile(file);
                } else {
                    showToast(`File ${file.name} is not a CSV file`, 'error');
                }
            });
        }

        function processCSVFile(file) {
            showToast(`Processing ${file.name}...`, 'info');

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    if (results.errors.length > 0) {
                        console.warn('CSV parsing warnings:', results.errors);
                    }
                    
                    const newData = processVulnerabilityData(results.data, file.name);
                    if (newData.length > 0) {
                        vulnData = [...vulnData, ...newData];
                        storeData();
                        updateDisplay();
                        showToast(`Successfully processed ${newData.length} vulnerabilities from ${file.name}`, 'success');
                    } else {
                        showToast(`No valid vulnerability data found in ${file.name}`, 'warning');
                    }
                },
                error: function(error) {
                    console.error('CSV parsing error:', error);
                    showToast(`Error processing ${file.name}: ${error.message}`, 'error');
                }
            });
        }

        function processVulnerabilityData(data, fileName) {
            return data.map((row, index) => {
                // Extract VPR score from various possible fields
                const vprScore = parseFloat(
                    row['definition.vpr.score'] || 
                    row['vpr.score'] || 
                    row['vprScore'] || 
                    row['VPR Score'] || 
                    0
                );

                // Map severity
                let severity = row.severity || row.Severity || 'Unknown';
                if (severity.toLowerCase().includes('critical')) severity = 'Critical';
                else if (severity.toLowerCase().includes('high')) severity = 'High';
                else if (severity.toLowerCase().includes('medium')) severity = 'Medium';
                else if (severity.toLowerCase().includes('low')) severity = 'Low';

                return {
                    id: `${fileName}_${index}`,
                    hostname: row.hostname || row.Hostname || row.asset || row.Asset || 'Unknown',
                    cve: row.cve || row.CVE || row['definition.id'] || 'N/A',
                    severity: severity,
                    vprScore: vprScore,
                    definition: row.definition || row.Definition || row['definition.name'] || 'N/A',
                    source: fileName,
                    importDate: new Date().toISOString()
                };
            }).filter(vuln => vuln.hostname !== 'Unknown' && vuln.vprScore > 0);
        }

        function calculateStatistics() {
            const stats = {
                critical: 0,
                high: 0,
                medium: 0,
                low: 0,
                total: vulnData.length
            };

            vulnData.forEach(vuln => {
                switch (vuln.severity) {
                    case 'Critical':
                        stats.critical += vuln.vprScore;
                        break;
                    case 'High':
                        stats.high += vuln.vprScore;
                        break;
                    case 'Medium':
                        stats.medium += vuln.vprScore;
                        break;
                    case 'Low':
                        stats.low += vuln.vprScore;
                        break;
                }
            });

            return stats;
        }

        function updateDisplay() {
            currentStats = calculateStatistics();
            updateStatCards();
            updateDataTable();
            updateDataStatus();
        }

        function updateStatCards() {
            document.getElementById('criticalValue').textContent = currentStats.critical.toFixed(1);
            document.getElementById('highValue').textContent = currentStats.high.toFixed(1);
            document.getElementById('mediumValue').textContent = currentStats.medium.toFixed(1);
            document.getElementById('lowValue').textContent = currentStats.low.toFixed(1);
        }

        function updateDataTable() {
            const tbody = document.getElementById('dataTableBody');
            if (!tbody) return;

            if (vulnData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                            <i class="fas fa-database text-4xl mb-2 block"></i>
                            No data available. Upload a CSV file to get started.
                        </td>
                    </tr>
                `;
                return;
            }

            // Show first 50 rows
            const displayData = vulnData.slice(0, 50);
            tbody.innerHTML = displayData.map(vuln => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${vuln.hostname}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${vuln.cve}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs font-medium rounded-full ${getSeverityBadgeClass(vuln.severity)}">
                            ${vuln.severity}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${vuln.vprScore.toFixed(1)}</td>
                    <td class="px-6 py-4 text-sm text-gray-900 max-w-xs truncate" title="${vuln.definition}">${vuln.definition}</td>
                </tr>
            `).join('');
        }

        function getSeverityBadgeClass(severity) {
            switch (severity) {
                case 'Critical': return 'bg-red-100 text-red-800';
                case 'High': return 'bg-orange-100 text-orange-800';
                case 'Medium': return 'bg-yellow-100 text-yellow-800';
                case 'Low': return 'bg-green-100 text-green-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function updateDataStatus() {
            const statusElement = document.getElementById('dataStatus');
            if (!statusElement) return;

            if (vulnData.length === 0) {
                statusElement.textContent = 'No data loaded. Please upload a CSV file.';
            } else {
                statusElement.textContent = `${vulnData.length} vulnerabilities loaded. Total VPR: ${(currentStats.critical + currentStats.high + currentStats.medium + currentStats.low).toFixed(1)}`;
            }
        }

        function storeData() {
            try {
                localStorage.setItem('vulnData', JSON.stringify(vulnData));
                localStorage.setItem('lastUpdate', new Date().toISOString());
            } catch (error) {
                console.warn('Could not save data to localStorage:', error);
                showToast('Warning: Data could not be saved to browser storage', 'warning');
            }
        }

        function loadExistingData() {
            try {
                const saved = localStorage.getItem('vulnData');
                if (saved) {
                    vulnData = JSON.parse(saved);
                    console.log(`Loaded ${vulnData.length} vulnerabilities from storage`);
                }
            } catch (error) {
                console.warn('Could not load existing data:', error);
                vulnData = [];
            }
        }

        function refreshData() {
            showToast('Refreshing data...', 'info');
            updateDisplay();
            showToast('Data refreshed', 'success');
        }

        function exportData() {
            if (vulnData.length === 0) {
                showToast('No data to export', 'warning');
                return;
            }

            try {
                const csv = Papa.unparse(vulnData);
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `hextrackr_export_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                
                URL.revokeObjectURL(url);
                showToast('Data exported successfully', 'success');
            } catch (error) {
                console.error('Export error:', error);
                showToast('Export failed', 'error');
            }
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            if (!container) return;

            const toast = document.createElement('div');
            toast.className = `px-6 py-4 rounded-lg shadow-lg text-white transform transition-all duration-300 translate-x-full opacity-0 ${getToastClass(type)}`;
            toast.innerHTML = `
                <div class="flex items-center justify-between">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white/80 hover:text-white">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;

            container.appendChild(toast);

            // Animate in
            setTimeout(() => {
                toast.classList.remove('translate-x-full', 'opacity-0');
            }, 10);

            // Auto remove after 5 seconds
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.classList.add('translate-x-full', 'opacity-0');
                    setTimeout(() => toast.remove(), 300);
                }
            }, 5000);
        }

        function getToastClass(type) {
            switch (type) {
                case 'success': return 'bg-green-600';
                case 'error': return 'bg-red-600';
                case 'warning': return 'bg-yellow-600';
                default: return 'bg-blue-600';
            }
        }
    </script>
</body>
</html>
