{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://stacktrackr.dev/schemas/event-log.json",
  "title": "StackTrackr Event Log Entry",
  "description": "Individual event log entry for memory vault operations",
  "type": "object",
  "required": ["event_id", "type", "agent_id", "timestamp", "provenance"],
  "properties": {
    "event_id": {
      "type": "string",
      "pattern": "^\\d+_[a-zA-Z0-9_-]+$",
      "description": "Unique event identifier with timestamp and agent"
    },
    "type": {
      "type": "string",
      "enum": [
        "memory_update",
        "lease_acquired", 
        "lease_released",
        "conflict_resolved",
        "schema_validation",
        "backup_created",
        "rollback_performed"
      ],
      "description": "Type of event"
    },
    "agent_id": {
      "type": "string",
      "pattern": "^[a-zA-Z0-9_-]+$",
      "description": "ID of the agent performing the operation"
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO timestamp of the event"
    },
    "base_hash": {
      "type": "string",
      "pattern": "^[a-f0-9]{64}$",
      "description": "SHA256 hash of the base snapshot"
    },
    "head_hash_before": {
      "type": "string",
      "pattern": "^[a-f0-9]{64}$",
      "description": "SHA256 hash before changes"
    },
    "head_hash_after": {
      "type": "string",
      "pattern": "^[a-f0-9]{64}$",
      "description": "SHA256 hash after changes"
    },
    "patch": {
      "type": "array",
      "description": "JSON Patch operations applied",
      "items": {
        "type": "object",
        "required": ["op", "path"],
        "properties": {
          "op": {
            "type": "string",
            "enum": ["add", "remove", "replace", "move", "copy", "test"]
          },
          "path": {
            "type": "string",
            "pattern": "^/"
          },
          "value": {
            "description": "Value for add/replace operations"
          },
          "from": {
            "type": "string",
            "pattern": "^/",
            "description": "Source path for move/copy operations"
          }
        }
      }
    },
    "patch_size": {
      "type": "integer",
      "minimum": 0,
      "description": "Number of operations in the patch"
    },
    "provenance": {
      "type": "object",
      "required": ["source", "confidence", "method"],
      "properties": {
        "source": {
          "type": "string",
          "description": "Source of the changes (e.g., 'user_input', 'ai_analysis', 'automated_sync')"
        },
        "confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Agent's confidence in the changes (0.0 to 1.0)"
        },
        "justification": {
          "type": "string",
          "description": "Human-readable explanation of why changes were made"
        },
        "method": {
          "type": "string",
          "enum": ["checkin", "merge", "rollback", "sync", "migration"],
          "description": "Method used to apply changes"
        },
        "review_required": {
          "type": "boolean",
          "description": "Whether changes require human review"
        }
      }
    },
    "risk": {
      "type": "string",
      "enum": ["low", "medium", "high", "critical"],
      "description": "Risk level of the changes"
    },
    "requires_review": {
      "type": "boolean",
      "description": "Whether the changes require review"
    },
    "validation_results": {
      "type": "object",
      "properties": {
        "schema_valid": {"type": "boolean"},
        "warnings": {
          "type": "array",
          "items": {"type": "string"}
        },
        "errors": {
          "type": "array", 
          "items": {"type": "string"}
        }
      }
    },
    "performance_metrics": {
      "type": "object",
      "properties": {
        "operation_duration_ms": {"type": "number"},
        "memory_snapshot_size_bytes": {"type": "integer"},
        "patch_application_ms": {"type": "number"}
      }
    },
    "conflict_resolution": {
      "type": "object",
      "description": "Details of conflict resolution if applicable",
      "properties": {
        "strategy": {
          "type": "string",
          "enum": ["three_way_merge", "force_overwrite", "manual_resolution"]
        },
        "conflicts_detected": {"type": "integer"},
        "conflicts_resolved": {"type": "integer"},
        "manual_intervention": {"type": "boolean"}
      }
    }
  },
  "additionalProperties": false
}
