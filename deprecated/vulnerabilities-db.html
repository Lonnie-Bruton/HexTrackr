<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HexTrackr - Vulnerability Management (Database)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/ag-grid-community@30.2.0/styles/ag-grid.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/ag-grid-community@30.2.0/styles/ag-theme-alpine.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="tickets.html">
                <i class="fas fa-shield-alt"></i> HexTrackr
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="tickets.html"><i class="fas fa-ticket-alt"></i> Tickets</a>
                <a class="nav-link active" href="vulnerabilities-db.html"><i class="fas fa-bug"></i> Vulnerabilities</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Vulnerability Statistics -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card border-danger">
                    <div class="card-body text-center">
                        <h1 class="display-4 text-danger" id="criticalCount">0</h1>
                        <p class="text-muted">CRITICAL</p>
                        <small class="text-success">
                            <i class="fas fa-chart-line"></i> 
                            <span id="criticalChange">+0%</span> VPR 9.0-10.0
                        </small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-warning">
                    <div class="card-body text-center">
                        <h1 class="display-4 text-warning" id="highCount">0</h1>
                        <p class="text-muted">HIGH</p>
                        <small class="text-success">
                            <i class="fas fa-chart-line"></i> 
                            <span id="highChange">+0%</span> VPR 7.0-8.9
                        </small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-info">
                    <div class="card-body text-center">
                        <h1 class="display-4 text-info" id="mediumCount">0</h1>
                        <p class="text-muted">MEDIUM</p>
                        <small class="text-success">
                            <i class="fas fa-chart-line"></i> 
                            <span id="mediumChange">+0%</span> VPR 4.0-6.9
                        </small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-success">
                    <div class="card-body text-center">
                        <h1 class="display-4 text-success" id="lowCount">0</h1>
                        <p class="text-muted">LOW</p>
                        <small class="text-success">
                            <i class="fas fa-chart-line"></i> 
                            <span id="lowChange">+0%</span> VPR 0.1-3.9
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Actions and Search -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control" id="searchInput" placeholder="Search vulnerabilities, CVEs, or hostnames...">
                    <select class="form-select" id="severityFilter" style="max-width: 200px;">
                        <option value="">All Severities</option>
                        <option value="Critical">Critical</option>
                        <option value="High">High</option>
                        <option value="Medium">Medium</option>
                        <option value="Low">Low</option>
                    </select>
                </div>
            </div>
            <div class="col-md-4 text-end">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-secondary" id="settingsBtn">
                        <i class="fas fa-cog"></i> Settings
                    </button>
                    <button type="button" class="btn btn-primary" id="importBtn">
                        <i class="fas fa-upload"></i> Import CSV
                    </button>
                </div>
            </div>
        </div>

        <!-- Vulnerability Data Grid -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-database me-2"></i>
                            <span>Vulnerability Data (Database-Powered)</span>
                        </div>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-primary active" id="tableViewBtn">
                                <i class="fas fa-table"></i> Table
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div id="vulnerabilityGrid" class="ag-theme-alpine" style="height: 500px;"></div>
                        
                        <!-- Pagination -->
                        <div class="d-flex justify-content-between align-items-center p-3 border-top">
                            <div class="text-muted">
                                <span id="paginationInfo">Showing 0-0 of 0 vulnerabilities</span>
                            </div>
                            <nav>
                                <ul class="pagination pagination-sm mb-0" id="pagination">
                                    <!-- Pagination buttons will be inserted here -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div class="modal fade" id="importModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Import Vulnerability Data</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="importForm" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="csvFile" class="form-label">CSV File</label>
                            <input type="file" class="form-control" id="csvFile" name="csvFile" accept=".csv" required>
                            <div class="form-text">Supports Cisco, Tenable, Qualys, and other standard vulnerability scanner formats</div>
                        </div>
                        <div class="mb-3">
                            <label for="vendor" class="form-label">Vendor/Source</label>
                            <select class="form-select" id="vendor" name="vendor">
                                <option value="cisco">Cisco PSIRT</option>
                                <option value="tenable">Tenable.io</option>
                                <option value="qualys">Qualys VMDR</option>
                                <option value="rapid7">Rapid7</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="progress mb-3" style="display: none;" id="importProgress">
                            <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>Database Import:</strong> Large files are now processed server-side for better performance and reliability.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="importConfirm">Import</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal fade" id="settingsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Settings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="list-group">
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">Clear All Data</h6>
                                <button class="btn btn-danger btn-sm" id="clearDataBtn">
                                    <i class="fas fa-trash"></i> Clear
                                </button>
                            </div>
                            <p class="mb-1">Remove all imported vulnerability data and import history.</p>
                        </div>
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">Import History</h6>
                                <button class="btn btn-info btn-sm" id="viewImportsBtn">
                                    <i class="fas fa-history"></i> View
                                </button>
                            </div>
                            <p class="mb-1">View details of all CSV imports and processing statistics.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <h5 id="loadingText">Processing data...</h5>
                    <p class="text-muted mb-0" id="loadingSubtext">Please wait while we process your request.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community@30.2.0/dist/ag-grid-community.min.js"></script>
    <script>
        // Database-powered vulnerability management
        class VulnerabilityManagerDB {
            constructor() {
                this.apiBase = '/api';
                this.currentPage = 1;
                this.pageSize = 50;
                this.currentSearch = '';
                this.currentSeverity = '';
                this.gridApi = null;
                this.init();
            }

            init() {
                this.setupEventHandlers();
                this.setupGrid();
                this.loadStats();
                this.loadData();
            }

            setupEventHandlers() {
                // Import functionality
                document.getElementById('importBtn').addEventListener('click', () => {
                    new bootstrap.Modal(document.getElementById('importModal')).show();
                });

                document.getElementById('importConfirm').addEventListener('click', () => {
                    this.importData();
                });

                // Settings
                document.getElementById('settingsBtn').addEventListener('click', () => {
                    new bootstrap.Modal(document.getElementById('settingsModal')).show();
                });

                document.getElementById('clearDataBtn').addEventListener('click', () => {
                    this.clearData();
                });

                // Search and filtering
                document.getElementById('searchInput').addEventListener('input', (e) => {
                    this.currentSearch = e.target.value;
                    this.currentPage = 1;
                    this.loadData();
                });

                document.getElementById('severityFilter').addEventListener('change', (e) => {
                    this.currentSeverity = e.target.value;
                    this.currentPage = 1;
                    this.loadData();
                });
            }

            setupGrid() {
                const columnDefs = [
                    { field: 'hostname', headerName: 'Hostname', sortable: true, filter: true, width: 150 },
                    { field: 'cve', headerName: 'CVE', sortable: true, filter: true, width: 140 },
                    { 
                        field: 'severity', 
                        headerName: 'Severity', 
                        sortable: true, 
                        width: 100,
                        cellStyle: (params) => {
                            const severity = params.value?.toLowerCase();
                            if (severity === 'critical') return { color: '#dc3545', fontWeight: 'bold' };
                            if (severity === 'high') return { color: '#fd7e14', fontWeight: 'bold' };
                            if (severity === 'medium') return { color: '#0dcaf0', fontWeight: 'bold' };
                            if (severity === 'low') return { color: '#198754', fontWeight: 'bold' };
                            return {};
                        }
                    },
                    { field: 'vpr_score', headerName: 'VPR Score', sortable: true, width: 100, type: 'numericColumn' },
                    { field: 'plugin_name', headerName: 'Plugin Name', sortable: true, flex: 1 },
                    { field: 'first_seen', headerName: 'First Seen', sortable: true, width: 120 },
                    { field: 'last_seen', headerName: 'Last Seen', sortable: true, width: 120 }
                ];

                const gridOptions = {
                    columnDefs: columnDefs,
                    defaultColDef: {
                        resizable: true,
                        sortable: true,
                        filter: false // We handle filtering server-side
                    },
                    suppressPaginationPanel: true, // We handle pagination manually
                    domLayout: 'normal'
                };

                this.gridApi = agGrid.createGrid(document.getElementById('vulnerabilityGrid'), gridOptions);
            }

            async loadStats() {
                try {
                    const response = await fetch(`${this.apiBase}/vulnerabilities/stats`);
                    const stats = await response.json();
                    
                    // Reset counts
                    document.getElementById('criticalCount').textContent = '0';
                    document.getElementById('highCount').textContent = '0';
                    document.getElementById('mediumCount').textContent = '0';
                    document.getElementById('lowCount').textContent = '0';

                    // Update counts based on API response
                    stats.forEach(stat => {
                        const severity = stat.severity?.toLowerCase();
                        if (severity === 'critical') {
                            document.getElementById('criticalCount').textContent = stat.count;
                        } else if (severity === 'high') {
                            document.getElementById('highCount').textContent = stat.count;
                        } else if (severity === 'medium') {
                            document.getElementById('mediumCount').textContent = stat.count;
                        } else if (severity === 'low') {
                            document.getElementById('lowCount').textContent = stat.count;
                        }
                    });
                } catch (error) {
                    console.error('Error loading stats:', error);
                }
            }

            async loadData() {
                try {
                    const params = new URLSearchParams({
                        page: this.currentPage,
                        limit: this.pageSize,
                        search: this.currentSearch,
                        severity: this.currentSeverity
                    });

                    const response = await fetch(`${this.apiBase}/vulnerabilities?${params}`);
                    const result = await response.json();

                    // Update grid
                    this.gridApi.setGridOption('rowData', result.data || []);
                    
                    // Update pagination
                    this.updatePagination(result.pagination);
                    
                } catch (error) {
                    console.error('Error loading data:', error);
                    this.gridApi.setGridOption('rowData', []);
                }
            }

            updatePagination(pagination) {
                if (!pagination) return;

                const info = `Showing ${((pagination.page - 1) * pagination.limit) + 1}-${Math.min(pagination.page * pagination.limit, pagination.total)} of ${pagination.total} vulnerabilities`;
                document.getElementById('paginationInfo').textContent = info;

                const paginationEl = document.getElementById('pagination');
                paginationEl.innerHTML = '';

                // Previous button
                const prevLi = document.createElement('li');
                prevLi.className = `page-item ${pagination.page <= 1 ? 'disabled' : ''}`;
                prevLi.innerHTML = `<a class="page-link" href="#" data-page="${pagination.page - 1}">Previous</a>`;
                paginationEl.appendChild(prevLi);

                // Page numbers
                const startPage = Math.max(1, pagination.page - 2);
                const endPage = Math.min(pagination.pages, pagination.page + 2);

                for (let i = startPage; i <= endPage; i++) {
                    const li = document.createElement('li');
                    li.className = `page-item ${i === pagination.page ? 'active' : ''}`;
                    li.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
                    paginationEl.appendChild(li);
                }

                // Next button
                const nextLi = document.createElement('li');
                nextLi.className = `page-item ${pagination.page >= pagination.pages ? 'disabled' : ''}`;
                nextLi.innerHTML = `<a class="page-link" href="#" data-page="${pagination.page + 1}">Next</a>`;
                paginationEl.appendChild(nextLi);

                // Add click handlers
                paginationEl.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (e.target.hasAttribute('data-page')) {
                        const newPage = parseInt(e.target.getAttribute('data-page'));
                        if (newPage >= 1 && newPage <= pagination.pages && newPage !== this.currentPage) {
                            this.currentPage = newPage;
                            this.loadData();
                        }
                    }
                });
            }

            async importData() {
                const fileInput = document.getElementById('csvFile');
                const vendorSelect = document.getElementById('vendor');
                
                if (!fileInput.files[0]) {
                    alert('Please select a CSV file');
                    return;
                }

                const formData = new FormData();
                formData.append('csvFile', fileInput.files[0]);
                formData.append('vendor', vendorSelect.value);

                // Show loading
                this.showLoading('Importing CSV data...', 'Processing vulnerability data from file');
                
                // Hide import modal
                bootstrap.Modal.getInstance(document.getElementById('importModal')).hide();

                try {
                    const response = await fetch(`${this.apiBase}/vulnerabilities/import`, {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        this.hideLoading();
                        alert(`Successfully imported ${result.rowsProcessed} vulnerabilities from ${result.filename}`);
                        
                        // Reset form
                        document.getElementById('importForm').reset();
                        
                        // Refresh data
                        this.loadStats();
                        this.loadData();
                    } else {
                        throw new Error(result.error || 'Import failed');
                    }
                } catch (error) {
                    this.hideLoading();
                    alert('Import failed: ' + error.message);
                    console.error('Import error:', error);
                }
            }

            async clearData() {
                if (!confirm('Are you sure you want to clear all vulnerability data? This action cannot be undone.')) {
                    return;
                }

                this.showLoading('Clearing data...', 'Removing all vulnerability records');

                try {
                    const response = await fetch(`${this.apiBase}/vulnerabilities/clear`, {
                        method: 'DELETE'
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        this.hideLoading();
                        
                        // Hide settings modal
                        bootstrap.Modal.getInstance(document.getElementById('settingsModal')).hide();
                        
                        // Refresh data
                        this.loadStats();
                        this.loadData();
                        
                        alert('All vulnerability data has been cleared successfully');
                    } else {
                        throw new Error(result.error || 'Clear operation failed');
                    }
                } catch (error) {
                    this.hideLoading();
                    alert('Clear failed: ' + error.message);
                    console.error('Clear error:', error);
                }
            }

            showLoading(title = 'Loading...', subtitle = 'Please wait...') {
                document.getElementById('loadingText').textContent = title;
                document.getElementById('loadingSubtext').textContent = subtitle;
                new bootstrap.Modal(document.getElementById('loadingModal')).show();
            }

            hideLoading() {
                const modal = bootstrap.Modal.getInstance(document.getElementById('loadingModal'));
                if (modal) {
                    modal.hide();
                }
                // Ensure modal backdrop is removed
                setTimeout(() => {
                    document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
                        backdrop.remove();
                    });
                    document.body.classList.remove('modal-open');
                    document.body.style.removeProperty('overflow');
                    document.body.style.removeProperty('padding-right');
                }, 300);
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            new VulnerabilityManagerDB();
        });
    </script>
</body>
</html>
