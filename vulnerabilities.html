<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HexTrackr - Modern Vulnerability Management</title>
    
    <!-- Tabler.io CSS Framework -->
    <link href="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta17/dist/css/tabler.min.css" rel="stylesheet">
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- AG Grid CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/styles/ag-grid.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/styles/ag-theme-alpine.css">
    
    <!-- Chart.js for mini-charts - using local files -->
    <!-- Chart.js CSS is embedded in the library -->
    
    <style>
        /* Ultrawide Screen Layout Constraints - Center Content */
        .page {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .page-wrapper {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .page-wrapper .container-xl {
            max-width: 100%;
            margin: 0 auto;
        }
        
        /* Progressive width constraints for different screen sizes */
        @media (min-width: 1600px) {
            .page-wrapper {
                max-width: 1300px;
            }
        }
        
        @media (min-width: 2000px) {
            .page-wrapper {
                max-width: 1200px;
            }
        }
        
        @media (min-width: 2560px) {
            .page-wrapper {
                max-width: 1400px; /* Allow a bit more room on very large displays */
            }
        }

        /* Enhanced HexTrackr Styles for Tabler.io Integration */
        :root {
            --hextrackr-primary: #206bc4;
            --hextrackr-secondary: #6c757d;
            --hextrackr-success: #2fb344;
            --hextrackr-warning: #f76707;
            --hextrackr-danger: #d63384;
            --hextrackr-info: #0dcaf0;
        }

        /* VPR Mini-Cards for Device and Vulnerability Cards */
        .vpr-mini-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
            margin-top: auto;
            padding-top: 1rem;
        }

        .vpr-mini-card {
            background: var(--tblr-bg-surface);
            border: 1px solid var(--tblr-border-color);
            border-radius: var(--tblr-border-radius);
            padding: 0.75rem 0.5rem;
            text-align: center;
            transition: all 0.2s ease;
            position: relative;
            min-height: 5rem;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .vpr-mini-card:hover {
            border-color: var(--hextrackr-primary);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(32, 107, 196, 0.15);
        }

        .vpr-mini-card.critical {
            border-left: 3px solid var(--tblr-red);
        }

        .vpr-mini-card.high {
            border-left: 3px solid var(--tblr-orange);
        }

        .vpr-mini-card.medium {
            border-left: 3px solid var(--tblr-yellow);
        }

        .vpr-mini-card.low {
            border-left: 3px solid var(--tblr-green);
        }

        .vpr-mini-card .vpr-count {
            font-size: 1.25rem;
            font-weight: 600;
            line-height: 1;
            margin-bottom: 0.25rem;
        }

        .vpr-mini-card .vpr-label {
            font-size: 0.75rem;
            color: var(--tblr-muted);
            text-transform: uppercase;
            letter-spacing: 0.025em;
            margin-bottom: 0.25rem;
        }

        .vpr-mini-card .vpr-sum {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--hextrackr-primary);
        }

        /* Card Action Areas */
        .card-actions {
            margin-top: auto;
            padding-top: 1rem;
        }

        .card-actions .btn {
            width: 100%;
        }

        /* Device Card Enhancements */
        .device-card {
            transition: all 0.3s ease;
            border: 1px solid var(--tblr-border-color);
            min-height: 320px;
            display: flex;
            flex-direction: column;
        }

        .device-card .card-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
        }

        .device-card:hover {
            border-color: var(--hextrackr-primary);
            box-shadow: 0 4px 12px rgba(32, 107, 196, 0.15);
            transform: translateY(-2px);
        }

        .device-hostname {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--hextrackr-primary);
            margin-bottom: 1rem;
            min-height: 2.2rem;
            display: flex;
            align-items: center;
        }

        .device-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: var(--tblr-bg-surface-secondary);
            border-radius: var(--tblr-border-radius);
        }

        .device-total-vpr {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--hextrackr-danger);
        }

        /* Vulnerability Card Enhancements */
        .vulnerability-card {
            transition: all 0.3s ease;
            border: 1px solid var(--tblr-border-color);
            min-height: 380px;
            display: flex;
            flex-direction: column;
        }

        .vulnerability-card .card-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
        }

        .vulnerability-card:hover {
            border-color: var(--hextrackr-primary);
            box-shadow: 0 4px 12px rgba(32, 107, 196, 0.15);
            transform: translateY(-2px);
        }

        .vulnerability-card[style*="cursor: pointer"]:hover {
            background-color: var(--tblr-bg-surface-secondary);
        }

        /* Enhanced Modal Styling */
        .modal-blur {
            backdrop-filter: blur(8px);
        }

        .modal-blur .modal-content {
            border: none;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        .modal-header {
            border-bottom: 1px solid var(--tblr-border-color);
            background: linear-gradient(135deg, var(--tblr-bg-surface) 0%, var(--tblr-bg-surface-secondary) 100%);
        }

        .modal-footer {
            border-top: 1px solid var(--tblr-border-color);
            background: var(--tblr-bg-surface-secondary);
        }

        .vulnerability-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--tblr-dark);
            margin-bottom: 1rem;
            line-height: 1.4;
            min-height: 2.8rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            line-clamp: 2;
            overflow: hidden;
        }

        .vulnerability-cve {
            font-size: 0.875rem;
            color: var(--hextrackr-primary);
            text-decoration: none;
            font-weight: 500;
        }

        .vulnerability-cve:hover {
            color: var(--hextrackr-danger);
            text-decoration: underline;
        }

        .vulnerability-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 1rem 0;
            padding: 0.75rem;
            background: var(--tblr-bg-surface-secondary);
            border-radius: var(--tblr-border-radius);
            min-height: 4rem;
        }

        .vulnerability-vpr {
            font-size: 1.25rem;
            font-weight: 700;
        }

        /* Drag and Drop Enhancements */
        .sortable-ghost {
            opacity: 0.5;
            transform: rotate(2deg);
        }

        .sortable-chosen {
            transform: scale(1.02);
            box-shadow: 0 8px 25px rgba(32, 107, 196, 0.25);
        }

        .sortable-drag {
            transform: rotate(-2deg);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.2);
        }

        /* View Switcher Enhancements */
        .btn-group .btn-check:checked + .btn-outline-primary {
            background-color: var(--hextrackr-primary);
            border-color: var(--hextrackr-primary);
        }

        /* Chart Enhancements */
        .mini-chart {
            height: 40px;
            width: 100%;
        }

        /* Animation Utilities */
        .fade-in {
            animation: fadeIn 0.6s ease forwards;
        }

        .slide-up {
            animation: slideUp 0.5s ease forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Enhanced Badge Styles */
        .severity-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-weight: 600;
        }

        .severity-critical { background-color: var(--tblr-red); color: white; }
        .severity-high { background-color: var(--tblr-orange); color: white; }
        .severity-medium { background-color: var(--tblr-yellow); color: black; }
        .severity-low { background-color: var(--tblr-green); color: white; }

        /* Loading States */
        .loading-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Legacy Styles for Existing Components */
        .chart-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            padding: 2rem;
            margin-bottom: 2rem;
            min-height: 400px;
        }

        .workspace-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .workspace-header {
            background: linear-gradient(135deg, var(--hextrackr-primary) 0%, #3b82f6 100%);
            color: white;
            padding: 1.5rem;
            border: none;
        }

        .workspace-body {
            padding: 0;
            min-height: 600px;
        }

        .view-switcher {
            background: white;
            border-radius: 8px;
            padding: 0.5rem;
            margin-bottom: 1rem;
        }

        .view-btn {
            background: transparent;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            transition: all 0.2s ease;
            color: var(--hextrackr-secondary);
        }

        .view-btn.active {
            background: var(--hextrackr-primary);
            color: white;
            box-shadow: 0 1px 3px rgba(32, 107, 196, 0.3);
        }

        .ag-theme-alpine {
            --ag-alpine-active-color: var(--hextrackr-primary);
            --ag-header-background-color: #f8fafc;
            --ag-header-foreground-color: #1f2937;
            --ag-border-color: #e2e8f0;
        }

        .device-card, .vuln-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
            transition: all 0.2s ease;
            border: 1px solid #e2e8f0;
        }

        .device-card:hover, .vuln-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            border-color: var(--hextrackr-primary);
        }

        .severity-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .severity-critical {
            background-color: #fef2f2;
            color: var(--hextrackr-danger);
            border: 1px solid #fecaca;
        }

        .severity-high {
            background-color: #fffbeb;
            color: var(--hextrackr-warning);
            border: 1px solid #fed7aa;
        }

        .severity-medium {
            background-color: #eff6ff;
            color: var(--hextrackr-info);
            border: 1px solid #bfdbfe;
        }

        .severity-low {
            background-color: #f0fdf4;
            color: var(--hextrackr-success);
            border: 1px solid #bbf7d0;
        }

        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }

        .progress-modern {
            height: 8px;
            border-radius: 4px;
            background-color: #e2e8f0;
            overflow: hidden;
        }

        .progress-modern .progress-bar {
            background: linear-gradient(90deg, var(--hextrackr-primary) 0%, #3b82f6 100%);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .loading-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* Animation delays for staggered entrance effects */
        .animate-delay-1 { animation-delay: 0.1s; }
        .animate-delay-2 { animation-delay: 0.2s; }
        .animate-delay-3 { animation-delay: 0.3s; }
        .animate-delay-4 { animation-delay: 0.4s; }
        .animate-delay-5 { animation-delay: 0.5s; }
        .animate-delay-6 { animation-delay: 0.6s; }

        /* Fixed height containers */
        .chart-height { height: 350px; }
        .grid-height { height: 600px; }
        .device-grid-height { height: 400px; }
        .hidden-input { display: none; }
        .progress-init { width: 0%; }
    </style>
</head>
<body>
    <!-- Tabler.io Header -->
    <header class="navbar navbar-expand-md d-print-none" data-bs-theme="dark">
        <div class="container-xl">
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar-menu" aria-controls="navbar-menu" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <h1 class="navbar-brand navbar-brand-autodark d-none-navbar-horizontal pe-0 pe-md-3">
                <a href="tickets.html">
                    <i class="fas fa-shield-alt me-2 text-primary"></i>
                    HexTrackr
                </a>
            </h1>
            <div class="navbar-nav flex-row order-md-last">
                <div class="d-none d-md-flex">
                    <a href="#" class="nav-link px-0 hide-theme-dark" title="Enable dark mode" data-bs-toggle="tooltip" data-bs-placement="bottom">
                        <i class="fas fa-moon"></i>
                    </a>
                    <a href="#" class="nav-link px-0 hide-theme-light" title="Enable light mode" data-bs-toggle="tooltip" data-bs-placement="bottom">
                        <i class="fas fa-sun"></i>
                    </a>
                </div>
                <div class="nav-item dropdown">
                    <a href="#" class="nav-link d-flex lh-1 text-reset p-0" data-bs-toggle="dropdown" aria-label="Open user menu">
                        <span class="avatar avatar-sm" style="background-image: url(https://ui-avatars.com/api/?name=HT&background=206bc4&color=fff)"></span>
                        <div class="d-none d-xl-block ps-2">
                            <div>HexTrackr User</div>
                            <div class="mt-1 small text-muted">Vulnerability Manager</div>
                        </div>
                    </a>
                    <div class="dropdown-menu dropdown-menu-end dropdown-menu-arrow">
                        <a href="#" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#settingsModal">
                            <i class="fas fa-cog me-2"></i>Settings
                        </a>
                        <div class="dropdown-divider"></div>
                        <a href="#" class="dropdown-item" id="importCsvBtn">
                            <i class="fas fa-upload me-2"></i>Import CSV Data
                        </a>
                    </div>
                </div>
            </div>
            <div class="collapse navbar-collapse" id="navbar-menu">
                <div class="d-flex flex-column flex-md-row flex-fill align-items-stretch align-items-md-center">
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a class="nav-link" href="tickets.html">
                                <span class="nav-link-icon d-md-none d-lg-inline-block">
                                    <i class="fas fa-ticket-alt"></i>
                                </span>
                                <span class="nav-link-title">Tickets</span>
                            </a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="vulnerabilities.html">
                                <span class="nav-link-icon d-md-none d-lg-inline-block">
                                    <i class="fas fa-bug"></i>
                                </span>
                                <span class="nav-link-title">Vulnerabilities</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </header>

    <!-- Tabler.io Page Wrapper -->
    <div class="page">
        <div class="page-wrapper">
            <!-- Page header -->
            <div class="page-header d-print-none">
                <div class="container-xl">
                    <div class="row g-2 align-items-center">
                        <div class="col">
                            <h2 class="page-title">
                                <i class="fas fa-shield-virus me-2 text-primary"></i>
                                Vulnerability Management Dashboard
                            </h2>
                            <div class="page-pretitle">
                                Modern security vulnerability tracking and analysis
                            </div>
                        </div>
                        <!-- Header actions removed - functionality moved to user dropdown menu -->
                    </div>
                </div>
            </div>
            
            <!-- Page body -->
            <div class="page-body">
                <div class="container-xl">
                    <!-- VPR Statistics Cards -->
                    <div class="row row-deck row-cards mb-4">
                        <div class="col-sm-6 col-lg-3">
                            <div class="card card-sm">
                                <div class="card-body">
                                    <div class="row align-items-center">
                                        <div class="col-auto">
                                            <span class="bg-red text-white avatar">
                                                <i class="fas fa-exclamation-triangle"></i>
                                            </span>
                                        </div>
                                        <div class="col">
                                            <div class="font-weight-medium" id="criticalCount">0</div>
                                            <div class="text-muted">Critical (9.0-10.0)</div>
                                        </div>
                                        <div class="col-auto">
                                            <div class="text-red" id="criticalTrend">
                                                <i class="fas fa-trending-up"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6 col-lg-3">
                            <div class="card card-sm">
                                <div class="card-body">
                                    <div class="row align-items-center">
                                        <div class="col-auto">
                                            <span class="bg-orange text-white avatar">
                                                <i class="fas fa-exclamation"></i>
                                            </span>
                                        </div>
                                        <div class="col">
                                            <div class="font-weight-medium" id="highCount">0</div>
                                            <div class="text-muted">High (7.0-8.9)</div>
                                        </div>
                                        <div class="col-auto">
                                            <div class="text-orange" id="highTrend">
                                                <i class="fas fa-trending-up"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6 col-lg-3">
                            <div class="card card-sm">
                                <div class="card-body">
                                    <div class="row align-items-center">
                                        <div class="col-auto">
                                            <span class="bg-yellow text-white avatar">
                                                <i class="fas fa-minus"></i>
                                            </span>
                                        </div>
                                        <div class="col">
                                            <div class="font-weight-medium" id="mediumCount">0</div>
                                            <div class="text-muted">Medium (4.0-6.9)</div>
                                        </div>
                                        <div class="col-auto">
                                            <div class="text-yellow" id="mediumTrend">
                                                <i class="fas fa-trending-up"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6 col-lg-3">
                            <div class="card card-sm">
                                <div class="card-body">
                                    <div class="row align-items-center">
                                        <div class="col-auto">
                                            <span class="bg-green text-white avatar">
                                                <i class="fas fa-info"></i>
                                            </span>
                                        </div>
                                        <div class="col">
                                            <div class="font-weight-medium" id="lowCount">0</div>
                                            <div class="text-muted">Low (0.1-3.9)</div>
                                        </div>
                                        <div class="col-auto">
                                            <div class="text-green" id="lowTrend">
                                                <i class="fas fa-trending-down"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>
                    
                    <!-- Search and Filters Section -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="row g-2">
                                <div class="col-md-8">
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="fas fa-search"></i>
                                        </span>
                                        <input type="text" class="form-control" id="searchInput" 
                                               placeholder="Search vulnerabilities, CVEs, or hostnames..." 
                                               autocomplete="off">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <select class="form-select" id="severityFilter" aria-label="Filter by severity">
                                                <option value="">All Severities</option>
                                                <option value="Critical">Critical</option>
                                                <option value="High">High</option>
                                                <option value="Medium">Medium</option>
                                                <option value="Low">Low</option>
                                            </select>
                                        </div>
                                        <div class="col-6">
                                            <div class="d-flex gap-2">
                                                <button class="btn btn-outline-primary" id="exportBtn">
                                                    <i class="fas fa-download me-1"></i>Export
                                                </button>
                                                <button class="btn btn-outline-secondary" id="refreshBtn" title="Refresh data">
                                                    <i class="fas fa-sync-alt"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Historical Chart Section -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-chart-line me-2 text-primary"></i>
                                Historical VPR Trends (Last 14 Days)
                            </h3>
                        </div>
                        <div class="card-body">
                            <div id="historicalChart" style="height: 300px;"></div>
                        </div>
                    </div>

                    <!-- Main Workspace Card -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-database me-2"></i>
                                Vulnerability Data Workspace
                            </h3>
                            <div class="card-actions">
                                <div class="btn-group" role="group" aria-label="View switcher">
                                    <input type="radio" class="btn-check" name="view-options" id="view-table" autocomplete="off" checked>
                                    <label class="btn btn-outline-primary" for="view-table" data-view="table">
                                        <i class="fas fa-table me-1"></i>Table
                                    </label>
                                    
                                    <input type="radio" class="btn-check" name="view-options" id="view-devices" autocomplete="off">
                                    <label class="btn btn-outline-primary" for="view-devices" data-view="devices">
                                        <i class="fas fa-server me-1"></i>Devices
                                    </label>
                                    
                                    <input type="radio" class="btn-check" name="view-options" id="view-vulnerabilities" autocomplete="off">
                                    <label class="btn btn-outline-primary" for="view-vulnerabilities" data-view="vulnerabilities">
                                        <i class="fas fa-bug me-1"></i>Vulnerabilities
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <!-- Table View -->
                            <div id="tableView" class="view-content">
                                <div id="vulnGrid" class="ag-theme-alpine" style="height: 600px; width: 100%;"></div>
                            </div>
                            
                            <!-- Device Cards View -->
                            <div id="devicesView" class="view-content d-none">
                                <div class="p-3">
                                    <div class="row row-cards" id="deviceCards">
                                        <!-- Device cards will be populated here -->
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Vulnerability Cards View -->
                            <div id="vulnerabilitiesView" class="view-content d-none">
                                <div class="p-3">
                                    <div class="row row-cards" id="vulnerabilityCards">
                                        <!-- Vulnerability cards will be populated here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Device Details Modal with Tabler.io Styling -->
    <div class="modal modal-blur fade" id="deviceModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-server me-2 text-primary"></i>
                        Device Security Overview
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <!-- Device Summary Card -->
                        <div class="col-lg-4">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h3 class="card-title">
                                        <i class="fas fa-info-circle me-2"></i>
                                        Device Information
                                    </h3>
                                </div>
                                <div class="card-body">
                                    <div id="deviceInfo" class="space-y-3">
                                        <!-- Device info will be populated here -->
                                    </div>
                                    
                                    <!-- VPR Summary Mini-Cards -->
                                    <div class="mt-4">
                                        <h4 class="h6 mb-3">VPR Risk Breakdown</h4>
                                        <div class="row g-2" id="deviceVprSummary">
                                            <!-- VPR mini-cards will be populated here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Vulnerabilities Grid -->
                        <div class="col-lg-8">
                            <div class="card h-100">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h3 class="card-title">
                                        <i class="fas fa-bug me-2"></i>
                                        Active Vulnerabilities
                                    </h3>
                                    <div class="card-actions">
                                        <button class="btn btn-outline-primary btn-sm" id="exportDeviceData">
                                            <i class="fas fa-download me-1"></i>
                                            Export
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body p-0">
                                    <div id="deviceVulnGrid" class="ag-theme-alpine" style="height: 500px; width: 100%;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Close
                    </button>
                    <button type="button" class="btn btn-primary" id="generateDeviceReport">
                        <i class="fas fa-file-pdf me-2"></i>
                        Generate Report
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal fade" id="settingsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-cog me-2"></i>
                        Settings
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close settings modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-12">
                            <h6>API Configuration</h6>
                            <div class="mb-3">
                                <label for="ciscoClientId" class="form-label">Cisco PSIRT Client ID</label>
                                <input type="text" class="form-control" id="ciscoClientId" placeholder="Enter client ID">
                            </div>
                            <div class="mb-3">
                                <label for="ciscoClientSecret" class="form-label">Cisco PSIRT Client Secret</label>
                                <input type="password" class="form-control" id="ciscoClientSecret" placeholder="Enter client secret">
                            </div>
                            <div class="mb-3">
                                <label for="tenableApiKey" class="form-label">Tenable Access Key</label>
                                <input type="text" class="form-control" id="tenableApiKey" placeholder="Enter access key">
                            </div>
                            <div class="mb-3">
                                <label for="tenableSecretKey" class="form-label">Tenable Secret Key</label>
                                <input type="password" class="form-control" id="tenableSecretKey" placeholder="Enter secret key">
                            </div>
                            <div class="mb-3">
                                <button type="button" class="btn btn-outline-primary" onclick="vulnManager.fetchTenableHistoricalData()">
                                    <i class="fas fa-download me-2"></i>Fetch Historical VPR Data
                                </button>
                                <small class="form-text text-muted d-block mt-1">
                                    Retrieves historical VPR score data from Tenable for trending analysis.
                                </small>
                            </div>
                            <div class="mb-3">
                                <label for="qualysApiKey" class="form-label">Qualys API Key</label>
                                <input type="text" class="form-control" id="qualysApiKey" placeholder="Enter API key">
                            </div>
                            
                            <hr class="my-4">
                            
                            <h6 class="text-danger">Data Management</h6>
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>Warning:</strong> This action cannot be undone.
                            </div>
                            <div class="mb-3">
                                <button type="button" class="btn btn-danger" id="clearDataBtn">
                                    <i class="fas fa-trash me-2"></i>
                                    Clear All Vulnerability Data
                                </button>
                                <small class="form-text text-muted d-block mt-1">
                                    This will remove all imported vulnerability data and historical statistics.
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveSettings">Save Settings</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Vulnerability Details Modal with Tabler.io Styling -->
    <div class="modal modal-blur fade" id="vulnerabilityModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-bug me-2"></i>
                        Vulnerability Details
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <!-- Vulnerability Information -->
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">
                                        <i class="fas fa-info-circle me-2"></i>
                                        Vulnerability Information
                                    </h6>
                                </div>
                                <div class="card-body" id="vulnerabilityInfo">
                                    <!-- Populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- VPR and Risk Summary -->
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">
                                        <i class="fas fa-chart-line me-2"></i>
                                        Risk Analysis
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row" id="vulnerabilityRiskSummary">
                                        <!-- Populated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Affected Assets -->
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h6 class="card-title mb-0">
                                        <i class="fas fa-server me-2"></i>
                                        Affected Assets
                                    </h6>
                                    <span class="badge bg-secondary" id="affectedAssetsCount">0 assets</span>
                                </div>
                                <div class="card-body">
                                    <div id="vulnerabilityAssetsGrid" style="height: 300px; width: 100%;" class="ag-theme-alpine"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>
                        Close
                    </button>
                    <button type="button" class="btn btn-primary" onclick="vulnManager.exportVulnerabilityReport()">
                        <i class="fas fa-download me-2"></i>
                        Export Report
                    </button>
                    <button type="button" class="btn btn-danger" onclick="vulnManager.generateVulnerabilityPDF()">
                        <i class="fas fa-file-pdf me-2"></i>
                        Generate PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Vulnerability Modal -->
    <div class="modal fade" id="editVulnModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-edit me-2"></i>Edit Vulnerability
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editVulnForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editHostname" class="form-label">Hostname</label>
                                    <input type="text" class="form-control" id="editHostname" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editIpAddress" class="form-label">IP Address</label>
                                    <input type="text" class="form-control" id="editIpAddress" 
                                           pattern="^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$"
                                           title="Please enter a valid IP address">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editSeverity" class="form-label">Severity</label>
                                    <select class="form-select" id="editSeverity">
                                        <option value="Critical">Critical</option>
                                        <option value="High">High</option>
                                        <option value="Medium">Medium</option>
                                        <option value="Low">Low</option>
                                        <option value="Info">Info</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editState" class="form-label">State</label>
                                    <select class="form-select" id="editState">
                                        <option value="open">Open</option>
                                        <option value="resolved">Resolved</option>
                                        <option value="verified">Verified</option>
                                        <option value="closed">Closed</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editNotes" class="form-label">Notes</label>
                            <textarea class="form-control" id="editNotes" rows="4" 
                                      placeholder="Add any notes or comments about this vulnerability..."></textarea>
                        </div>
                        <input type="hidden" id="editVulnId">
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveVulnEdit">
                        <i class="fas fa-save me-2"></i>Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center">
                    <div class="loading-spinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                    <h5 class="mt-3" id="loadingMessage">Processing data...</h5>
                    <div class="progress-modern mt-3">
                        <div class="progress-bar progress-init" role="progressbar" id="loadingProgress" aria-label="Loading progress"></div>
                    </div>
                    <small class="text-muted" id="loadingDetails">Please wait...</small>
                </div>
            </div>
        </div>
    </div>

    <!-- File Input (Hidden) -->
    <input type="file" id="csvFileInput" accept=".csv" class="hidden-input">

    <!-- External Libraries -->
    <!-- Tabler.io JS -->
    <script src="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta17/dist/js/tabler.min.js"></script>
    
    <!-- Chart.js for mini-charts - using local file -->
    <script src="scripts/chart.min.js"></script>
    
    <!-- SortableJS for drag and drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    
    <!-- AG Grid Community -->
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/dist/ag-grid-community.min.js"></script>
    
    <!-- ApexCharts -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts@3.44.0/dist/apexcharts.min.js"></script>
    
    <!-- PapaParse for CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <!-- AG Grid Responsive Configuration - Embedded -->
    <script>
        /**
         * Debounce function to limit the rate at which a function gets called.
         * This is crucial for performance on events that fire rapidly, like window resize.
         * @param {Function} func - The function to debounce.
         * @param {number} delay - The debounce delay in milliseconds.
         * @returns {Function} The debounced function.
         */
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }

        /**
         * Creates and returns the complete AG Grid configuration object.
         * @param {object} componentContext - The 'this' context of the calling component (e.g., ModernVulnManager)
         *                                    to access its methods and properties like `gridApi`.
         * @returns {GridOptions} A complete AG Grid `gridOptions` object.
         */
        function createVulnerabilityGridOptions(componentContext) {
            // Column definitions with optimized responsive width management
            const isDesktop = window.innerWidth >= 1200;
            const isTablet = window.innerWidth >= 768 && window.innerWidth < 1200;
            const isMobile = window.innerWidth < 768;
            
            const columnDefs = [
                {
                    headerName: 'Last Seen',
                    field: 'last_seen',
                    sortable: true,
                    filter: 'agDateColumnFilter',
                    width: isDesktop ? 120 : isTablet ? 100 : 80,
                    minWidth: 80,
                    maxWidth: 130,
                    cellRenderer: (params) => params.value ? new Date(params.value).toLocaleDateString() : '-',
                    hide: isMobile,
                },
                {
                    headerName: 'Hostname',
                    field: 'hostname',
                    sortable: true,
                    filter: true,
                    width: isDesktop ? 180 : isTablet ? 140 : 120,
                    minWidth: 100,
                    maxWidth: 200,
                    cellRenderer: (params) => {
                        const hostname = params.value || '-';
                        return `<a href="#" class="fw-bold text-primary text-decoration-none" onclick="vulnManager.viewDeviceDetails('${hostname}')">${hostname}</a>`;
                    }
                },
                {
                    headerName: 'IP Address',
                    field: 'ip_address',
                    sortable: true,
                    filter: true,
                    width: isDesktop ? 140 : 120,
                    minWidth: 100,
                    maxWidth: 150,
                    hide: isMobile,
                },
                {
                    headerName: 'Severity',
                    field: 'severity',
                    sortable: true,
                    filter: true,
                    width: isDesktop ? 110 : isTablet ? 100 : 90,
                    minWidth: 80,
                    maxWidth: 120,
                    cellRenderer: (params) => {
                        const severity = params.value || 'Low';
                        const className = `severity-${severity.toLowerCase()}`;
                        return `<span class="severity-badge ${className}">${severity}</span>`;
                    }
                },
                {
                    headerName: 'CVE',
                    field: 'cve',
                    sortable: true,
                    filter: true,
                    width: isDesktop ? 150 : isTablet ? 130 : 110,
                    minWidth: 90,
                    maxWidth: 160,
                    hide: isMobile,
                    cellRenderer: (params) => {
                        if (params.value && params.value.startsWith('CVE-')) {
                            return `<a href="#" class="text-decoration-none" onclick="vulnManager.lookupCVE('${params.value}')">${params.value}</a>`;
                        }
                        return params.value || '-';
                    }
                },
                {
                    headerName: 'Vendor',
                    field: 'vendor',
                    sortable: true,
                    filter: true,
                    width: isDesktop ? 120 : 100,
                    minWidth: 80,
                    maxWidth: 140,
                    hide: !isDesktop,
                },
                {
                    headerName: isMobile ? 'Description' : 'Vulnerability Description',
                    field: 'plugin_name',
                    sortable: true,
                    filter: true,
                    flex: 1,
                    minWidth: isMobile ? 200 : isTablet ? 250 : 300,
                    maxWidth: 600,
                    wrapText: true,
                    autoHeight: true,
                    cellRenderer: (params) => params.value || '-',
                },
                {
                    headerName: 'VPR',
                    field: 'vpr_score',
                    sortable: true,
                    filter: 'agNumberColumnFilter',
                    width: isDesktop ? 90 : isTablet ? 80 : 70,
                    minWidth: 60,
                    maxWidth: 100,
                    cellRenderer: (params) => {
                        const score = parseFloat(params.value) || 0;
                        let className = 'severity-low';
                        if (score >= 9.0) className = 'severity-critical';
                        else if (score >= 7.0) className = 'severity-high';
                        else if (score >= 4.0) className = 'severity-medium';
                        return `<span class="severity-badge ${className}">${score.toFixed(1)}</span>`;
                    }
                }
            ];

            const gridOptions = {
                columnDefs: columnDefs,
                rowData: [],
                defaultColDef: {
                    resizable: true,
                    sortable: true,
                    filter: true,
                    wrapHeaderText: true,
                    autoHeaderHeight: true,
                },
                animateRows: true,
                rowSelection: 'multiple',
                suppressRowClickSelection: true,
                pagination: true,
                paginationPageSize: 50,
                paginationPageSizeSelector: [25, 50, 100, 200],
                suppressColumnVirtualisation: true,
                suppressHorizontalScroll: false,
                
                onGridReady: (params) => {
                    // Responsive column management on resize
                    window.addEventListener('resize', debounce(() => {
                        if (componentContext.gridApi) {
                            // Auto-size columns to fit viewport
                            componentContext.gridApi.sizeColumnsToFit();
                            
                            // Update column visibility based on screen size
                            updateColumnVisibility(params.api);
                        }
                    }, 200));
                    
                    // Initial column fitting
                    setTimeout(() => {
                        if (componentContext.gridApi) {
                            componentContext.gridApi.sizeColumnsToFit();
                        }
                    }, 100);
                },

                onFirstDataRendered: (params) => {
                    if (componentContext.gridApi) {
                        // Auto-size all columns to fit content and viewport
                        componentContext.gridApi.sizeColumnsToFit();
                        updateColumnVisibility(params.api);
                    }
                },

                onGridSizeChanged: (params) => {
                    // Auto-fit columns when grid container changes size
                    if (params.api) {
                        params.api.sizeColumnsToFit();
                        updateColumnVisibility(params.api);
                    }
                },
            };

            // Helper function to update column visibility based on screen size
            function updateColumnVisibility(api) {
                const gridWidth = window.innerWidth;
                const breakpoints = { small: 768, large: 1200 };
                
                const allColumns = api.getColumns();
                if (!allColumns) return;

                const columnsToShow = [];
                const columnsToHide = [];

                allColumns.forEach(column => {
                    const colId = column.getColId();
                    switch (colId) {
                        case 'last_seen':
                            gridWidth < breakpoints.small ? columnsToHide.push(colId) : columnsToShow.push(colId);
                            break;
                        case 'ip_address':
                        case 'cve':
                            gridWidth < breakpoints.small ? columnsToHide.push(colId) : columnsToShow.push(colId);
                            break;
                        case 'vendor':
                            gridWidth < breakpoints.large ? columnsToHide.push(colId) : columnsToShow.push(colId);
                            break;
                        default:
                            columnsToShow.push(colId);
                            break;
                    }
                });

                api.setColumnsVisible(columnsToShow, true);
                api.setColumnsVisible(columnsToHide, false);
            }

            return gridOptions;
        }
    </script>

    <script>
        // Modern Vulnerability Management System
        class ModernVulnManager {
            constructor() {
                this.vulnerabilities = [];
                this.filteredVulnerabilities = [];
                this.devices = [];
                this.currentView = 'table';
                this.gridApi = null;
                this.chart = null;
                this.historicalData = [];
                this.statistics = {};
                this.uniqueAssets = new Set();
                this.apiBase = '/api';
                
                this.setupEventListeners();
                this.initializeGrid();
                this.initializeChart();
                this.loadData();
            }

            setupEventListeners() {
                // Import CSV
                document.getElementById('importCsvBtn').addEventListener('click', () => {
                    document.getElementById('csvFileInput').click();
                });

                document.getElementById('csvFileInput').addEventListener('change', (e) => {
                    this.handleCsvImport(e);
                });

                // Search and filters
                document.getElementById('searchInput').addEventListener('input', (e) => {
                    this.filterData();
                });

                document.getElementById('severityFilter').addEventListener('change', (e) => {
                    this.filterData();
                });

                // View switcher for Tabler.io button group
                document.querySelectorAll('[data-view]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const view = e.target.dataset.view || e.target.closest('[data-view]').dataset.view;
                        if (view) {
                            this.switchView(view);
                        }
                    });
                });

                // Export button
                document.getElementById('exportBtn').addEventListener('click', () => {
                    this.exportData();
                });

                // Refresh button
                document.getElementById('refreshBtn').addEventListener('click', () => {
                    this.refreshData();
                });

                // Settings
                document.getElementById('saveSettings').addEventListener('click', () => {
                    this.saveSettings();
                });

                // Save vulnerability edit
                document.getElementById('saveVulnEdit').addEventListener('click', () => {
                    this.saveVulnerabilityChanges();
                });

                // Clear data button
                document.getElementById('clearDataBtn').addEventListener('click', () => {
                    this.showClearDataConfirmation();
                });

                // Device modal export buttons
                document.getElementById('exportDeviceData').addEventListener('click', () => {
                    this.exportDeviceData();
                });

                document.getElementById('generateDeviceReport').addEventListener('click', () => {
                    this.generateDeviceReport();
                });
            }

            initializeGrid() {
                // Create the grid options using the new responsive configuration function
                // We pass `this` so the config can access `this.gridApi`
                const gridOptions = createVulnerabilityGridOptions(this);

                const gridDiv = document.getElementById('vulnGrid');
                
                // Clean up any previous grid instance to prevent memory leaks
                if (this.gridApi) {
                    this.gridApi.destroy();
                }

                // Create the new grid using the modern AG Grid API
                this.gridApi = agGrid.createGrid(gridDiv, gridOptions);
            }

            initializeChart() {
                const options = {
                    series: [{
                        name: 'Critical',
                        data: []
                    }, {
                        name: 'High',
                        data: []
                    }, {
                        name: 'Medium',
                        data: []
                    }, {
                        name: 'Low',
                        data: []
                    }],
                    chart: {
                        height: 300,
                        type: 'line',
                        zoom: {
                            enabled: true,
                            type: 'x'
                        },
                        selection: {
                            enabled: true
                        },
                        toolbar: {
                            show: true
                        },
                        animations: {
                            enabled: true,
                            easing: 'easeinout',
                            speed: 800
                        }
                    },
                    dataLabels: {
                        enabled: false
                    },
                    stroke: {
                        curve: 'smooth',
                        width: 3
                    },
                    colors: ['#dc2626', '#d97706', '#0284c7', '#059669'],
                    title: {
                        text: 'Vulnerability Trends Over Time (Defaulted to Last 14 Days)',
                        align: 'left',
                        style: {
                            fontSize: '16px',
                            fontWeight: '600'
                        }
                    },
                    grid: {
                        borderColor: '#e2e8f0',
                        strokeDashArray: 5
                    },
                    markers: {
                        size: 6,
                        strokeWidth: 2,
                        hover: {
                            size: 8
                        }
                    },
                    xaxis: {
                        type: 'datetime',
                        labels: {
                            format: 'MMM dd'
                        }
                    },
                    yaxis: {
                        title: {
                            text: 'Number of Vulnerabilities'
                        },
                        min: 0
                    },
                    legend: {
                        position: 'top',
                        horizontalAlign: 'right',
                        markers: {
                            width: 8,
                            height: 8,
                            radius: 4
                        }
                    },
                    tooltip: {
                        shared: true,
                        intersect: false,
                        y: {
                            formatter: function (val) {
                                return val + " vulnerabilities";
                            }
                        }
                    }
                };

                this.chart = new ApexCharts(document.getElementById('historicalChart'), options);
                this.chart.render();
            }

            async handleCsvImport(event) {
                const file = event.target.files[0];
                if (!file) return;

                // Check file size (warn if over 10MB)
                if (file.size > 10 * 1024 * 1024) {
                    if (!confirm(`This file is ${Math.round(file.size / (1024 * 1024))}MB. Large files will be processed server-side for better performance. Continue?`)) {
                        event.target.value = ''; // Clear the input
                        return;
                    }
                }

                this.showLoading('Uploading CSV file...');

                try {
                    // Prepare form data for upload
                    const formData = new FormData();
                    formData.append('csvFile', file);
                    formData.append('vendor', 'cisco'); // Default to cisco, could be made configurable

                    // Upload to database API
                    const response = await fetch(`${this.apiBase}/vulnerabilities/import`, {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Import failed');
                    }

                    this.showLoading('Processing data...');
                    const result = await response.json();

                    this.showLoading('Updating display...');
                    await this.loadData();

                    this.hideLoading();
                    this.showToast(`CSV import completed! Imported ${result.rowsProcessed.toLocaleString()} vulnerabilities from ${result.filename}.`, 'success');

                    // Clear the file input for next use
                    event.target.value = '';
                } catch (error) {
                    this.hideLoading();
                    console.error('Error importing CSV:', error);
                    this.showToast('Error importing CSV: ' + error.message, 'danger');
                    event.target.value = '';
                }
            }

            calculateSeverity(vprScore) {
                if (vprScore >= 9.0) return 'Critical';
                if (vprScore >= 7.0) return 'High';
                if (vprScore >= 4.0) return 'Medium';
                return 'Low';
            }

            async loadData() {
                try {
                    // Load vulnerabilities from database API
                    const response = await fetch(`${this.apiBase}/vulnerabilities?limit=10000`);
                    if (response.ok) {
                        const result = await response.json();
                        this.vulnerabilities = result.data || [];
                    } else {
                        this.vulnerabilities = [];
                    }
                    
                    // Load historical trending data for chart
                    const trendsResponse = await fetch(`${this.apiBase}/vulnerabilities/trends`);
                    if (trendsResponse.ok) {
                        this.historicalData = await trendsResponse.json();
                    } else {
                        this.historicalData = [];
                    }
                    
                    this.processDevices();
                    this.loadStatistics(); // Load statistics from API
                    this.updateChart();
                    this.filterData();
                } catch (error) {
                    console.error('Error loading data:', error);
                    this.showToast('Error loading data from database', 'danger');
                }
            }

            processDevices() {
                const deviceMap = new Map();
                
                this.vulnerabilities.forEach(vuln => {
                    if (!deviceMap.has(vuln.hostname)) {
                        deviceMap.set(vuln.hostname, {
                            hostname: vuln.hostname,
                            vulnerabilities: [],
                            criticalCount: 0,
                            highCount: 0,
                            mediumCount: 0,
                            lowCount: 0,
                            criticalVPR: 0,
                            highVPR: 0,
                            mediumVPR: 0,
                            lowVPR: 0,
                            totalCount: 0,
                            totalVPR: 0
                        });
                    }
                    
                    const device = deviceMap.get(vuln.hostname);
                    device.vulnerabilities.push(vuln);
                    device.totalCount++;
                    
                    const vprScore = vuln.vpr_score || 0;
                    device.totalVPR += vprScore;
                    
                    switch (vuln.severity) {
                        case 'Critical': 
                            device.criticalCount++; 
                            device.criticalVPR += vprScore;
                            break;
                        case 'High': 
                            device.highCount++; 
                            device.highVPR += vprScore;
                            break;
                        case 'Medium': 
                            device.mediumCount++; 
                            device.mediumVPR += vprScore;
                            break;
                        case 'Low': 
                            device.lowCount++; 
                            device.lowVPR += vprScore;
                            break;
                    }
                });
                
                this.devices = Array.from(deviceMap.values());
            }

            async loadStatistics() {
                try {
                    const response = await fetch(`${this.apiBase}/vulnerabilities/stats`);
                    if (response.ok) {
                        const stats = await response.json();
                        this.statistics = stats.reduce((acc, stat) => {
                            acc[stat.severity.toLowerCase()] = {
                                count: stat.count,
                                total_vpr: stat.total_vpr || 0,
                                avg_vpr: stat.avg_vpr || 0
                            };
                            return acc;
                        }, {});
                        this.updateStatisticsDisplay();
                    }
                } catch (error) {
                    console.error('Error loading statistics:', error);
                }
            }

            updateStatisticsDisplay() {
                // Update counts and VPR totals from API statistics
                ['critical', 'high', 'medium', 'low', 'info'].forEach(severity => {
                    const stat = this.statistics[severity];
                    if (stat) {
                        // Try new style elements first
                        const countEl = document.getElementById(`${severity}-count`);
                        const vprEl = document.getElementById(`${severity}-vpr`);
                        
                        if (countEl) {
                            countEl.textContent = stat.count;
                        } else {
                            // Fallback to old style
                            const legacyEl = document.getElementById(`${severity}Count`);
                            if (legacyEl) legacyEl.textContent = stat.count;
                        }
                        
                        if (vprEl) {
                            vprEl.textContent = stat.total_vpr.toFixed(1);
                        }
                    }
                });
                
                // Calculate totals
                const totalVulns = Object.values(this.statistics).reduce((sum, stat) => sum + stat.count, 0);
                const totalVulnsEl = document.getElementById('total-vulns');
                if (totalVulnsEl) {
                    totalVulnsEl.textContent = totalVulns;
                }
                
                // Update percentages
                const total = totalVulns;
                if (total > 0) {
                    ['critical', 'high', 'medium', 'low', 'info'].forEach(severity => {
                        const stat = this.statistics[severity];
                        if (stat) {
                            const percentageEl = document.querySelector(`.severity-${severity} .percentage`);
                            if (percentageEl) {
                                percentageEl.textContent = `${((stat.count / total) * 100).toFixed(1)}%`;
                            }
                        }
                    });
                }
            }

            updateTrendIndicators(currentStats) {
                // Use historical trending data if available
                if (this.historicalData && this.historicalData.length > 0) {
                    const latest = this.historicalData[this.historicalData.length - 1];
                    const previous = this.historicalData.length > 1 ? this.historicalData[this.historicalData.length - 2] : latest;
                    
                    const trends = {
                        critical: this.calculateTrend(previous.critical_vpr || 0, latest.critical_vpr || 0),
                        high: this.calculateTrend(previous.high_vpr || 0, latest.high_vpr || 0),
                        medium: this.calculateTrend(previous.medium_vpr || 0, latest.medium_vpr || 0),
                        low: this.calculateTrend(previous.low_vpr || 0, latest.low_vpr || 0)
                    };
                    
                    Object.keys(trends).forEach(severity => {
                        const element = document.getElementById(`${severity}Trend`);
                        if (element) {
                            const trend = trends[severity];
                            element.className = `trend-indicator trend-${trend.direction}`;
                            element.innerHTML = `<i class="fas fa-arrow-${trend.direction === 'up' ? 'up' : 'down'} me-1"></i>${trend.direction === 'up' ? '+' : ''}${trend.percentage}%`;
                        }
                    });
                } else {
                    // Fallback to simplified trend calculation
                    const trends = {
                        critical: Math.random() > 0.5 ? 'up' : 'down',
                        high: Math.random() > 0.5 ? 'up' : 'down',
                        medium: Math.random() > 0.5 ? 'up' : 'down',
                        low: Math.random() > 0.5 ? 'up' : 'down'
                    };

                    Object.keys(trends).forEach(severity => {
                        const element = document.getElementById(`${severity}Trend`);
                        if (element) {
                            const isUp = trends[severity] === 'up';
                            const percentage = Math.floor(Math.random() * 20) + 1;
                            
                            element.className = `trend-indicator trend-${trends[severity]}`;
                            element.innerHTML = `<i class="fas fa-arrow-${isUp ? 'up' : 'down'} me-1"></i>${isUp ? '+' : '-'}${percentage}%`;
                        }
                    });
                }
            }

            calculateTrend(previous, current) {
                if (previous === 0 && current === 0) {
                    return { direction: 'stable', percentage: '0' };
                }
                if (previous === 0) {
                    return { direction: 'up', percentage: '100' };
                }
                
                const percentChange = ((current - previous) / previous) * 100;
                if (Math.abs(percentChange) < 1) {
                    return { direction: 'stable', percentage: '0' };
                }
                
                return {
                    direction: percentChange > 0 ? 'up' : 'down',
                    percentage: Math.abs(percentChange).toFixed(1)
                };
            }

            updateChart() {
                if (!this.chart || this.historicalData.length === 0) return;

                const series = ['Critical', 'High', 'Medium', 'Low'].map((severity, index) => ({
                    name: severity,
                    data: this.historicalData.map(point => ({
                        x: new Date(point.date).getTime(),
                        y: point[severity]
                    }))
                }));

                this.chart.updateSeries(series);

                // Set default zoom to last 14 days
                if (this.historicalData.length > 0) {
                    const today = new Date();
                    const fourteenDaysAgo = new Date(today.getTime() - (14 * 24 * 60 * 60 * 1000));
                    
                    this.chart.zoomX(fourteenDaysAgo.getTime(), today.getTime());
                }
            }

            filterData() {
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const severityFilter = document.getElementById('severityFilter').value;

                this.filteredVulnerabilities = this.vulnerabilities.filter(vuln => {
                    const matchesSearch = !searchTerm || 
                        vuln.hostname.toLowerCase().includes(searchTerm) ||
                        vuln.cve.toLowerCase().includes(searchTerm) ||
                        vuln.plugin_name.toLowerCase().includes(searchTerm);
                    
                    const matchesSeverity = !severityFilter || vuln.severity === severityFilter;
                    
                    return matchesSearch && matchesSeverity;
                });

                if (this.gridApi) {
                    // Use the new AG Grid v31+ API
                    this.gridApi.setGridOption('rowData', this.filteredVulnerabilities);
                }

                this.updateCurrentView();
            }

            switchView(viewType) {
                // Update active radio button
                const radioButton = document.getElementById(`view-${viewType}`);
                if (radioButton) {
                    radioButton.checked = true;
                }

                // Hide all views
                document.querySelectorAll('.view-content').forEach(view => {
                    view.classList.add('d-none');
                });

                // Show selected view
                document.getElementById(`${viewType}View`).classList.remove('d-none');
                
                this.currentView = viewType;
                this.updateCurrentView();
            }

            updateCurrentView() {
                switch (this.currentView) {
                    case 'table':
                        if (this.gridApi) {
                            this.gridApi.setRowData(this.filteredVulnerabilities);
                        }
                        break;
                    case 'devices':
                        this.renderDeviceCards();
                        break;
                    case 'vulnerabilities':
                        this.renderVulnerabilityCards();
                        break;
                }
            }

            renderDeviceCards() {
                const container = document.getElementById('deviceCards');
                const filteredDevices = this.devices.filter(device => {
                    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                    return !searchTerm || device.hostname.toLowerCase().includes(searchTerm);
                });

                container.innerHTML = filteredDevices.map(device => {
                    // Calculate VPR sums for each criticality
                    const criticalVPR = device.criticalVPR || 0;
                    const highVPR = device.highVPR || 0;
                    const mediumVPR = device.mediumVPR || 0;
                    const lowVPR = device.lowVPR || 0;
                    const totalVPR = criticalVPR + highVPR + mediumVPR + lowVPR;

                    return `
                    <div class="col-lg-4 col-md-6 mb-3 fade-in">
                        <div class="card device-card">
                            <div class="card-body">
                                <div class="device-hostname">
                                    <i class="fas fa-server me-2 text-primary"></i>
                                    ${device.hostname}
                                </div>
                                
                                <div class="device-stats">
                                    <div>
                                        <div class="text-muted small">Total Vulnerabilities</div>
                                        <div class="fw-bold">${device.totalCount}</div>
                                    </div>
                                    <div class="text-end">
                                        <div class="text-muted small">Total VPR</div>
                                        <div class="device-total-vpr">${totalVPR.toFixed(1)}</div>
                                    </div>
                                </div>

                                <div class="vpr-mini-cards">
                                    <div class="vpr-mini-card critical">
                                        <div class="vpr-count text-red">${device.criticalCount}</div>
                                        <div class="vpr-label">Critical</div>
                                        <div class="vpr-sum">${criticalVPR.toFixed(1)}</div>
                                    </div>
                                    <div class="vpr-mini-card high">
                                        <div class="vpr-count text-orange">${device.highCount}</div>
                                        <div class="vpr-label">High</div>
                                        <div class="vpr-sum">${highVPR.toFixed(1)}</div>
                                    </div>
                                    <div class="vpr-mini-card medium">
                                        <div class="vpr-count text-yellow">${device.mediumCount}</div>
                                        <div class="vpr-label">Medium</div>
                                        <div class="vpr-sum">${mediumVPR.toFixed(1)}</div>
                                    </div>
                                    <div class="vpr-mini-card low">
                                        <div class="vpr-count text-green">${device.lowCount}</div>
                                        <div class="vpr-label">Low</div>
                                        <div class="vpr-sum">${lowVPR.toFixed(1)}</div>
                                    </div>
                                </div>

                                <div class="card-actions">
                                    <button class="btn btn-primary" 
                                            onclick="vulnManager.viewDeviceDetails('${device.hostname}')">
                                        <i class="fas fa-eye me-1"></i>View Device Details
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `}).join('');

                // Initialize drag and drop for device cards
                if (window.Sortable) {
                    new Sortable(container, {
                        animation: 150,
                        ghostClass: 'sortable-ghost',
                        chosenClass: 'sortable-chosen',
                        dragClass: 'sortable-drag'
                    });
                }
            }

            renderVulnerabilityCards() {
                const container = document.getElementById('vulnerabilityCards');
                const groupedVulns = this.groupVulnerabilitiesByCVE();

                container.innerHTML = Object.entries(groupedVulns).map(([cve, vulns]) => {
                    // Calculate VPR sums for each criticality within this vulnerability
                    const criticalVulns = vulns.filter(v => v.severity === 'Critical');
                    const highVulns = vulns.filter(v => v.severity === 'High');
                    const mediumVulns = vulns.filter(v => v.severity === 'Medium');
                    const lowVulns = vulns.filter(v => v.severity === 'Low');
                    
                    const criticalVPR = criticalVulns.reduce((sum, v) => sum + (v.vpr_score || 0), 0);
                    const highVPR = highVulns.reduce((sum, v) => sum + (v.vpr_score || 0), 0);
                    const mediumVPR = mediumVulns.reduce((sum, v) => sum + (v.vpr_score || 0), 0);
                    const lowVPR = lowVulns.reduce((sum, v) => sum + (v.vpr_score || 0), 0);
                    const totalVPR = criticalVPR + highVPR + mediumVPR + lowVPR;

                    const primaryVuln = vulns[0];
                    const description = primaryVuln.description || primaryVuln.plugin_name || 'No description available';

                    return `
                    <div class="col-lg-6 col-xl-4 mb-3 fade-in">
                        <div class="card vulnerability-card" style="cursor: pointer;" onclick="vulnManager.viewVulnerabilityDetails(${JSON.stringify(primaryVuln).replace(/"/g, '&quot;')})">
                            <div class="card-body">
                                <div class="vulnerability-title">
                                    ${description.substring(0, 100)}${description.length > 100 ? '...' : ''}
                                </div>
                                
                                <div class="vulnerability-meta">
                                    <div>
                                        ${cve && cve.startsWith('CVE-') ? `
                                            <a href="#" class="vulnerability-cve" 
                                               onclick="event.stopPropagation(); vulnManager.lookupCVE('${cve}');">
                                                ${cve}
                                            </a>
                                        ` : `
                                            <span class="text-muted">Plugin ${primaryVuln.plugin_id}</span>
                                        `}
                                    </div>
                                    <div class="text-end">
                                        <div class="vulnerability-vpr text-primary">
                                            ${totalVPR.toFixed(1)}
                                        </div>
                                        <div class="text-muted small">Total VPR</div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <span class="badge severity-${primaryVuln.severity.toLowerCase()}">
                                        ${primaryVuln.severity}
                                    </span>
                                    <span class="text-muted ms-2">
                                        <i class="fas fa-server me-1"></i>
                                        ${vulns.length} device${vulns.length !== 1 ? 's' : ''}
                                    </span>
                                </div>

                                <div class="vpr-mini-cards">
                                    <div class="vpr-mini-card critical">
                                        <div class="vpr-count text-red">${criticalVulns.length}</div>
                                        <div class="vpr-label">Critical</div>
                                        <div class="vpr-sum">${criticalVPR.toFixed(1)}</div>
                                    </div>
                                    <div class="vpr-mini-card high">
                                        <div class="vpr-count text-orange">${highVulns.length}</div>
                                        <div class="vpr-label">High</div>
                                        <div class="vpr-sum">${highVPR.toFixed(1)}</div>
                                    </div>
                                    <div class="vpr-mini-card medium">
                                        <div class="vpr-count text-yellow">${mediumVulns.length}</div>
                                        <div class="vpr-label">Medium</div>
                                        <div class="vpr-sum">${mediumVPR.toFixed(1)}</div>
                                    </div>
                                    <div class="vpr-mini-card low">
                                        <div class="vpr-count text-green">${lowVulns.length}</div>
                                        <div class="vpr-label">Low</div>
                                        <div class="vpr-sum">${lowVPR.toFixed(1)}</div>
                                    </div>
                                </div>

                                ${cve && cve.startsWith('CVE-') ? `
                                    <div class="card-actions">
                                        <button class="btn btn-outline-primary" 
                                                onclick="event.stopPropagation(); vulnManager.lookupCVE('${cve}')">
                                            <i class="fas fa-external-link-alt me-1"></i>Lookup CVE Details
                                        </button>
                                    </div>
                                ` : `
                                    <div class="card-actions">
                                        <div class="text-muted text-center py-2">
                                            <small>Click for details</small>
                                        </div>
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                `}).join('');

                // Initialize drag and drop for vulnerability cards
                if (window.Sortable) {
                    new Sortable(container, {
                        animation: 150,
                        ghostClass: 'sortable-ghost',
                        chosenClass: 'sortable-chosen',
                        dragClass: 'sortable-drag'
                    });
                }
            }

            groupVulnerabilitiesByCVE() {
                const grouped = {};
                this.filteredVulnerabilities.forEach(vuln => {
                    const key = vuln.cve || `plugin_${vuln.plugin_id}`;
                    if (!grouped[key]) {
                        grouped[key] = [];
                    }
                    grouped[key].push(vuln);
                });
                return grouped;
            }

            viewDeviceDetails(hostname) {
                const device = this.devices.find(d => d.hostname === hostname);
                if (!device) return;

                // Populate enhanced device info
                document.getElementById('deviceInfo').innerHTML = `
                    <div class="mb-3">
                        <div class="row">
                            <div class="col-sm-4 text-muted">Hostname:</div>
                            <div class="col-sm-8 fw-bold">${device.hostname}</div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="row">
                            <div class="col-sm-4 text-muted">Total Risks:</div>
                            <div class="col-sm-8">
                                <span class="badge bg-secondary">${device.totalCount} vulnerabilities</span>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="row">
                            <div class="col-sm-4 text-muted">Total VPR:</div>
                            <div class="col-sm-8">
                                <span class="h5 text-danger fw-bold">${(device.totalVPR || 0).toFixed(1)}</span>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="row">
                            <div class="col-sm-4 text-muted">Risk Level:</div>
                            <div class="col-sm-8">
                                ${device.criticalCount > 0 ? '<span class="badge bg-red">Critical Risk</span>' :
                                  device.highCount > 5 ? '<span class="badge bg-orange">High Risk</span>' :
                                  device.mediumCount > 10 ? '<span class="badge bg-yellow">Medium Risk</span>' :
                                  '<span class="badge bg-green">Low Risk</span>'}
                            </div>
                        </div>
                    </div>
                `;

                // Populate VPR summary mini-cards
                document.getElementById('deviceVprSummary').innerHTML = `
                    <div class="col-6">
                        <div class="card card-sm">
                            <div class="card-body text-center">
                                <div class="text-red h3 mb-1">${device.criticalCount}</div>
                                <div class="text-muted small">Critical</div>
                                <div class="text-red fw-bold">${(device.criticalVPR || 0).toFixed(1)}</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card card-sm">
                            <div class="card-body text-center">
                                <div class="text-orange h3 mb-1">${device.highCount}</div>
                                <div class="text-muted small">High</div>
                                <div class="text-orange fw-bold">${(device.highVPR || 0).toFixed(1)}</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card card-sm">
                            <div class="card-body text-center">
                                <div class="text-yellow h3 mb-1">${device.mediumCount}</div>
                                <div class="text-muted small">Medium</div>
                                <div class="text-yellow fw-bold">${(device.mediumVPR || 0).toFixed(1)}</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card card-sm">
                            <div class="card-body text-center">
                                <div class="text-green h3 mb-1">${device.lowCount}</div>
                                <div class="text-muted small">Low</div>
                                <div class="text-green fw-bold">${(device.lowVPR || 0).toFixed(1)}</div>
                            </div>
                        </div>
                    </div>
                `;

                // Initialize enhanced device vulnerability grid
                const deviceGridDiv = document.getElementById('deviceVulnGrid');
                deviceGridDiv.innerHTML = '';

                const deviceColumnDefs = [
                    { 
                        headerName: 'CVE', 
                        field: 'cve', 
                        width: 140,
                        cellRenderer: (params) => {
                            const cve = params.value;
                            if (cve && cve.startsWith('CVE-')) {
                                return `<a href="#" class="text-primary text-decoration-none" onclick="vulnManager.lookupCVE('${cve}')">${cve}</a>`;
                            }
                            return cve || 'N/A';
                        }
                    },
                    { 
                        headerName: 'VPR', 
                        field: 'vpr_score', 
                        width: 80,
                        cellRenderer: (params) => {
                            const score = params.value || 0;
                            const color = score >= 9 ? 'text-danger' : score >= 7 ? 'text-warning' : score >= 4 ? 'text-info' : 'text-success';
                            return `<span class="${color} fw-bold">${score.toFixed(1)}</span>`;
                        }
                    },
                    { 
                        headerName: 'Severity', 
                        field: 'severity', 
                        width: 100,
                        cellRenderer: (params) => {
                            const severity = params.value || 'Low';
                            const className = `severity-${severity.toLowerCase()}`;
                            return `<span class="severity-badge ${className}">${severity}</span>`;
                        }
                    },
                    { headerName: 'Plugin Name', field: 'plugin_name', flex: 1 },
                    { 
                        headerName: 'First Seen', 
                        field: 'first_seen', 
                        width: 120,
                        cellRenderer: (params) => {
                            return params.value ? new Date(params.value).toLocaleDateString() : 'N/A';
                        }
                    }
                ];

                const deviceGridOptions = {
                    columnDefs: deviceColumnDefs,
                    rowData: device.vulnerabilities,
                    defaultColDef: {
                        resizable: true,
                        sortable: true,
                        filter: true
                    },
                    pagination: true,
                    paginationPageSize: 25,
                    animateRows: true
                };

                new agGrid.Grid(deviceGridDiv, deviceGridOptions);

                // Show enhanced modal
                const modal = new bootstrap.Modal(document.getElementById('deviceModal'));
                modal.show();
            }

            viewVulnerabilityDetails(vulnerability) {
                if (!vulnerability) return;

                // Populate enhanced vulnerability info
                document.getElementById('vulnerabilityInfo').innerHTML = `
                    <div class="mb-3">
                        <div class="row">
                            <div class="col-sm-4 text-muted">CVE ID:</div>
                            <div class="col-sm-8">
                                <a href="#" class="text-primary text-decoration-none fw-bold" 
                                   onclick="vulnManager.lookupCVE('${vulnerability.cve}')">${vulnerability.cve}</a>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="row">
                            <div class="col-sm-4 text-muted">Plugin Name:</div>
                            <div class="col-sm-8 fw-bold">${vulnerability.plugin_name || 'N/A'}</div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="row">
                            <div class="col-sm-4 text-muted">Description:</div>
                            <div class="col-sm-8">${vulnerability.description || vulnerability.plugin_name || 'No description available'}</div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="row">
                            <div class="col-sm-4 text-muted">Solution:</div>
                            <div class="col-sm-8">${vulnerability.solution || 'No solution provided'}</div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="row">
                            <div class="col-sm-4 text-muted">First Seen:</div>
                            <div class="col-sm-8">${vulnerability.first_seen ? new Date(vulnerability.first_seen).toLocaleDateString() : 'N/A'}</div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="row">
                            <div class="col-sm-4 text-muted">Port:</div>
                            <div class="col-sm-8">
                                <span class="badge bg-secondary">${vulnerability.port || 'N/A'}</span>
                            </div>
                        </div>
                    </div>
                `;

                // Populate risk analysis
                const vprScore = vulnerability.vpr_score || 0;
                const severity = vulnerability.severity || 'Low';
                const severityColor = severity === 'Critical' ? 'red' : 
                                    severity === 'High' ? 'orange' : 
                                    severity === 'Medium' ? 'yellow' : 'green';
                
                document.getElementById('vulnerabilityRiskSummary').innerHTML = `
                    <div class="col-6">
                        <div class="card card-sm">
                            <div class="card-body text-center">
                                <div class="text-${vprScore >= 9 ? 'red' : vprScore >= 7 ? 'orange' : vprScore >= 4 ? 'yellow' : 'green'} h2 mb-1">${vprScore.toFixed(1)}</div>
                                <div class="text-muted small">VPR Score</div>
                                <div class="text-muted small mt-1">
                                    ${vprScore >= 9 ? 'Critical Risk' : vprScore >= 7 ? 'High Risk' : vprScore >= 4 ? 'Medium Risk' : 'Low Risk'}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card card-sm">
                            <div class="card-body text-center">
                                <div class="text-${severityColor} h3 mb-1">${severity}</div>
                                <div class="text-muted small">Severity</div>
                                <div class="text-muted small mt-1">CVSS Based</div>
                            </div>
                        </div>
                    </div>
                `;

                // Find all assets affected by this CVE
                const affectedAssets = this.vulnerabilities.filter(v => v.cve === vulnerability.cve);
                document.getElementById('affectedAssetsCount').textContent = `${affectedAssets.length} assets`;

                // Initialize affected assets grid
                const assetsGridDiv = document.getElementById('vulnerabilityAssetsGrid');
                assetsGridDiv.innerHTML = '';

                const assetsColumnDefs = [
                    { 
                        headerName: 'Hostname', 
                        field: 'hostname', 
                        width: 200,
                        cellRenderer: (params) => {
                            const hostname = params.value;
                            return `<a href="#" class="text-primary text-decoration-none fw-bold" onclick="vulnManager.viewDeviceDetails('${hostname}')">${hostname}</a>`;
                        }
                    },
                    { 
                        headerName: 'Port', 
                        field: 'port', 
                        width: 100,
                        cellRenderer: (params) => {
                            return `<span class="badge bg-secondary">${params.value || 'N/A'}</span>`;
                        }
                    },
                    { 
                        headerName: 'First Seen', 
                        field: 'first_seen', 
                        width: 150,
                        cellRenderer: (params) => {
                            return params.value ? new Date(params.value).toLocaleDateString() : 'N/A';
                        }
                    },
                    { 
                        headerName: 'Last Seen', 
                        field: 'last_seen', 
                        width: 150,
                        cellRenderer: (params) => {
                            return params.value ? new Date(params.value).toLocaleDateString() : 'N/A';
                        }
                    },
                    { headerName: 'Plugin Output', field: 'plugin_output', flex: 1 }
                ];

                const assetsGridOptions = {
                    columnDefs: assetsColumnDefs,
                    rowData: affectedAssets,
                    defaultColDef: {
                        resizable: true,
                        sortable: true,
                        filter: true
                    },
                    pagination: true,
                    paginationPageSize: 15,
                    animateRows: true
                };

                new agGrid.Grid(assetsGridDiv, assetsGridOptions);

                // Show enhanced vulnerability modal
                const modal = new bootstrap.Modal(document.getElementById('vulnerabilityModal'));
                modal.show();
            }

            async lookupCVE(cveId) {
                // Handle multiple CVEs separated by commas or spaces
                const cveIds = cveId.includes(',') ? cveId.split(',').map(id => id.trim()) 
                                                   : cveId.includes(' ') ? cveId.split(' ').filter(id => id.startsWith('CVE-'))
                                                   : [cveId.trim()];

                // Check if we have Cisco API credentials for comprehensive lookup
                const ciscoClientId = localStorage.getItem('cisco_client_id');
                const ciscoClientSecret = localStorage.getItem('cisco_client_secret');

                if (ciscoClientId && ciscoClientSecret && cveIds.length === 1) {
                    // Use Cisco API for single CVE comprehensive lookup
                    await this.lookupCVEWithCiscoAPI(cveIds[0], ciscoClientId, ciscoClientSecret);
                } else {
                    // Use external CVE database in popup windows (supports multiple CVEs)
                    this.openCVEPopups(cveIds);
                }
            }

            async lookupCVEWithCiscoAPI(cveId, clientId, clientSecret) {
                try {
                    this.showLoading(`Looking up ${cveId} via Cisco PSIRT...`);
                    
                    // Get Cisco access token
                    const tokenResponse = await fetch('https://id.cisco.com/oauth2/default/v1/token', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'Authorization': 'Basic ' + btoa(`${clientId}:${clientSecret}`)
                        },
                        body: 'grant_type=client_credentials'
                    });

                    if (tokenResponse.ok) {
                        const tokenData = await tokenResponse.json();
                        
                        // Query Cisco PSIRT API
                        const psirtResponse = await fetch(`https://api.cisco.com/security/advisories/cve/${cveId}`, {
                            headers: {
                                'Authorization': `Bearer ${tokenData.access_token}`,
                                'Accept': 'application/json'
                            }
                        });

                        this.hideLoading();

                        if (psirtResponse.ok) {
                            const data = await psirtResponse.json();
                            this.displayCVEInfo(cveId, data);
                        } else {
                            this.showToast(`No Cisco advisory found for ${cveId}. Opening external lookup...`, 'warning');
                            this.openCVEPopups([cveId]);
                        }
                    } else {
                        this.hideLoading();
                        this.showToast('Failed to authenticate with Cisco API. Using external lookup...', 'warning');
                        this.openCVEPopups([cveId]);
                    }
                } catch (error) {
                    this.hideLoading();
                    this.showToast('Error with Cisco API. Using external lookup...', 'warning');
                    this.openCVEPopups([cveId]);
                }
            }

            openCVEPopups(cveIds) {
                if (!Array.isArray(cveIds) || cveIds.length === 0) {
                    this.showToast('No valid CVE IDs found', 'warning');
                    return;
                }

                let successCount = 0;
                let blockedCount = 0;

                cveIds.forEach((cveId, index) => {
                    if (!cveId.startsWith('CVE-')) {
                        return; // Skip invalid CVE format
                    }

                    // Stagger popup opening to avoid browser blocking
                    setTimeout(() => {
                        const popup = window.open(
                            `https://cve.mitre.org/cgi-bin/cvename.cgi?name=${cveId.trim()}`, 
                            `CVE_Lookup_${cveId.replace(/[^a-zA-Z0-9]/g, '_')}`,
                            'width=1200,height=800,scrollbars=yes,resizable=yes,menubar=no,toolbar=no,location=yes,status=yes,top=50,left=' + (100 + index * 50)
                        );
                        
                        if (popup) {
                            popup.focus();
                            successCount++;
                        } else {
                            blockedCount++;
                        }

                        // Show summary message after last popup attempt
                        if (index === cveIds.length - 1) {
                            setTimeout(() => {
                                if (blockedCount > 0) {
                                    this.showToast(`${successCount} CVE lookup(s) opened. ${blockedCount} popup(s) blocked. Please allow popups for full CVE lookups.`, 'warning');
                                } else if (successCount > 0) {
                                    this.showToast(`${successCount} CVE lookup(s) opened successfully`, 'success');
                                }
                            }, 100);
                        }
                    }, index * 200); // 200ms delay between popups
                });
            }

            displayCVEInfo(cveId, data) {
                // Display CVE information in a modal or alert
                let message = `CVE Information for ${cveId}:\n\n`;
                if (data.advisories && data.advisories.length > 0) {
                    const advisory = data.advisories[0];
                    message += `Title: ${advisory.advisoryTitle}\n`;
                    message += `Severity: ${advisory.sir}\n`;
                    message += `CVSSv3 Score: ${advisory.cvssBaseScore}\n`;
                    message += `Publication Date: ${advisory.publicationUrl}\n`;
                }
                alert(message);
            }

            exportData() {
                const dataToExport = this.filteredVulnerabilities;
                const csv = Papa.unparse(dataToExport);
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `vulnerabilities_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                this.showToast('Data exported successfully!', 'success');
            }

            async refreshData() {
                this.showLoading('Refreshing data...');
                await new Promise(resolve => setTimeout(resolve, 1000)); // Simulate refresh
                await this.loadData();
                this.hideLoading();
                this.showToast('Data refreshed successfully!', 'success');
            }

            saveSettings() {
                const settings = {
                    cisco_client_id: document.getElementById('ciscoClientId').value,
                    cisco_client_secret: document.getElementById('ciscoClientSecret').value,
                    tenable_api_key: document.getElementById('tenableApiKey').value,
                    tenable_secret_key: document.getElementById('tenableSecretKey').value,
                    qualys_api_key: document.getElementById('qualysApiKey').value
                };

                Object.entries(settings).forEach(([key, value]) => {
                    if (value) {
                        localStorage.setItem(key, value);
                    }
                });

                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('settingsModal'));
                modal.hide();

                this.showToast('Settings saved successfully!', 'success');
            }

            // Fetch historical VPR data from Tenable
            async fetchTenableHistoricalData() {
                const tenableApiKey = localStorage.getItem('tenable_api_key');
                const tenableSecretKey = localStorage.getItem('tenable_secret_key');
                
                if (!tenableApiKey || !tenableSecretKey) {
                    this.showToast('Tenable API credentials not configured', 'warning');
                    return;
                }
                
                try {
                    this.showLoading('Fetching historical VPR data from Tenable...');
                    
                    const response = await fetch(`${this.apiBase}/tenable/historical-vpr`, {
                        headers: {
                            'X-Tenable-Api-Key': tenableApiKey,
                            'X-Tenable-Secret-Key': tenableSecretKey
                        }
                    });
                    
                    this.hideLoading();
                    
                    if (response.ok) {
                        const data = await response.json();
                        this.showToast(`Fetched ${data.count} historical VPR records`, 'success');
                        
                        // Refresh the charts with new historical data
                        await this.loadData();
                    } else {
                        const error = await response.json();
                        this.showToast('Failed to fetch Tenable data: ' + error.error, 'danger');
                    }
                } catch (error) {
                    this.hideLoading();
                    this.showToast('Error fetching Tenable data: ' + error.message, 'danger');
                }
            }

            showClearDataConfirmation() {
                if (confirm('Are you sure you want to clear all vulnerability data? This action cannot be undone.')) {
                    this.clearAllData();
                }
            }

            async clearAllData() {
                try {
                    this.showLoading('Clearing all data...');
                    
                    // Clear data using database API
                    const response = await fetch(`${this.apiBase}/vulnerabilities/clear`, {
                        method: 'DELETE'
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Clear operation failed');
                    }

                    this.showLoading('Updating display...');
                    
                    // Reload data from database
                    await this.loadData();
                    
                    this.hideLoading();
                    
                    // Close settings modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('settingsModal'));
                    if (modal) {
                        modal.hide();
                    }
                    
                    this.showToast('All vulnerability data cleared successfully!', 'success');
                } catch (error) {
                    this.hideLoading();
                    console.error('Error clearing data:', error);
                    this.showToast('Error clearing data: ' + error.message, 'danger');
                }
            }

            showLoading(message) {
                this.hideLoading(); // Clean up any existing toasts
                
                const toastHtml = `
                    <div class="toast show position-fixed top-0 end-0 m-3" id="progressToast" style="z-index: 9999;">
                        <div class="toast-header bg-primary text-white">
                            <div class="spinner-border spinner-border-sm me-2" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <strong class="me-auto">Processing</strong>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
                        </div>
                        <div class="toast-body">${message}</div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', toastHtml);
                
                // Auto-hide after 10 seconds as safety net
                setTimeout(() => this.hideLoading(), 10000);
            }

            hideLoading() {
                const toast = document.getElementById('progressToast');
                if (toast) {
                    toast.remove();
                }
                
                // Also clean up any modal leftovers (just in case)
                document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
                document.body.classList.remove('modal-open');
                document.body.style.removeProperty('overflow');
                document.body.style.removeProperty('padding-right');
            }

            showToast(message, type) {
                // Create toast element dynamically
                const toastContainer = document.getElementById('toastContainer') || this.createToastContainer();
                const toastId = 'toast_' + Date.now();
                
                const toastHtml = `
                    <div class="toast align-items-center text-bg-${type} border-0" role="alert" id="${toastId}">
                        <div class="d-flex">
                            <div class="toast-body">${message}</div>
                            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                        </div>
                    </div>
                `;
                
                toastContainer.insertAdjacentHTML('beforeend', toastHtml);
                
                const toastElement = document.getElementById(toastId);
                const toast = new bootstrap.Toast(toastElement);
                toast.show();
                
                // Remove toast after it's hidden
                toastElement.addEventListener('hidden.bs.toast', () => {
                    toastElement.remove();
                });
            }

            createToastContainer() {
                const container = document.createElement('div');
                container.id = 'toastContainer';
                container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
                container.style.zIndex = '9999';
                document.body.appendChild(container);
                return container;
            }

            // Edit vulnerability
            editVulnerability(id) {
                // Find the vulnerability by ID or row index
                const vuln = this.vulnerabilities[id] || this.filteredVulnerabilities[id];
                if (!vuln) {
                    this.showToast('Vulnerability not found', 'danger');
                    return;
                }

                // Populate the edit form
                document.getElementById('editVulnId').value = id;
                document.getElementById('editHostname').value = vuln.hostname || '';
                document.getElementById('editIpAddress').value = vuln.ip_address || '';
                document.getElementById('editSeverity').value = vuln.severity || '';
                document.getElementById('editState').value = vuln.state || 'open';
                document.getElementById('editNotes').value = vuln.notes || '';

                // Show the modal
                const modal = new bootstrap.Modal(document.getElementById('editVulnModal'));
                modal.show();
            }

            // Save vulnerability changes
            async saveVulnerabilityChanges() {
                const id = document.getElementById('editVulnId').value;
                const formData = {
                    hostname: document.getElementById('editHostname').value,
                    ip_address: document.getElementById('editIpAddress').value,
                    severity: document.getElementById('editSeverity').value,
                    state: document.getElementById('editState').value,
                    notes: document.getElementById('editNotes').value
                };

                try {
                    const response = await fetch(`${this.apiBase}/vulnerabilities/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });

                    if (response.ok) {
                        this.showToast('Vulnerability updated successfully!', 'success');
                        await this.loadData(); // Refresh the data
                        bootstrap.Modal.getInstance(document.getElementById('editVulnModal')).hide();
                    } else {
                        this.showToast('Failed to update vulnerability', 'danger');
                    }
                } catch (error) {
                    this.showToast('Error updating vulnerability: ' + error.message, 'danger');
                }
            }

            // Delete vulnerability
            async deleteVulnerability(id) {
                if (!confirm('Are you sure you want to delete this vulnerability? This action cannot be undone.')) {
                    return;
                }

                try {
                    const response = await fetch(`${this.apiBase}/vulnerabilities/${id}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        this.showToast('Vulnerability deleted successfully!', 'success');
                        await this.loadData(); // Refresh the data
                    } else {
                        this.showToast('Failed to delete vulnerability', 'danger');
                    }
                } catch (error) {
                    this.showToast('Error deleting vulnerability: ' + error.message, 'danger');
                }
            }

            // Refresh single vulnerability
            async refreshVulnerability(id) {
                const vuln = this.vulnerabilities[id] || this.filteredVulnerabilities[id];
                if (!vuln) {
                    this.showToast('Vulnerability not found', 'danger');
                    return;
                }

                this.showToast('Refreshing vulnerability data...', 'info');
                
                // Simulate refresh - in production, this would re-scan the specific vulnerability
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                this.showToast('Vulnerability data refreshed!', 'success');
            }

            // Enhanced Export Functions for Phase 2
            exportDeviceReport(hostname) {
                const device = this.devices.find(d => d.hostname === hostname);
                if (!device) return;

                const csvData = device.vulnerabilities.map(vuln => ({
                    'Device': hostname,
                    'CVE': vuln.cve || 'N/A',
                    'VPR Score': vuln.vpr_score || 0,
                    'Severity': vuln.severity,
                    'Plugin Name': vuln.plugin_name,
                    'Port': vuln.port || 'N/A',
                    'First Seen': vuln.first_seen ? new Date(vuln.first_seen).toLocaleDateString() : 'N/A',
                    'Last Seen': vuln.last_seen ? new Date(vuln.last_seen).toLocaleDateString() : 'N/A'
                }));

                const csv = Papa.unparse(csvData);
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `device_${hostname}_vulnerabilities_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                this.showToast(`Device report exported for ${hostname}`, 'success');
            }

            exportVulnerabilityReport() {
                // Get the currently displayed vulnerability in the modal
                const modal = document.getElementById('vulnerabilityModal');
                if (!modal.classList.contains('show')) return;

                // Extract vulnerability info from the modal
                const vulnTitle = modal.querySelector('.modal-title').textContent;
                const vulnInfo = modal.querySelector('#vulnerabilityInfo').innerHTML;
                
                // Create a simple report
                const reportContent = `
                    ${vulnTitle}\n
                    Generated: ${new Date().toLocaleString()}\n
                    ${vulnInfo.replace(/<[^>]*>/g, '').replace(/&nbsp;/g, ' ')}\n
                `;

                const blob = new Blob([reportContent], { type: 'text/plain;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `vulnerability_report_${new Date().toISOString().split('T')[0]}.txt`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                this.showToast('Vulnerability report exported', 'success');
            }

            generateDevicePDF(hostname) {
                // Placeholder for PDF generation - would integrate with jsPDF
                this.showToast('PDF generation feature coming soon!', 'info');
            }

            generateVulnerabilityPDF() {
                // Placeholder for vulnerability PDF generation
                this.showToast('PDF generation feature coming soon!', 'info');
            }

            // New Device Modal Export Functions (Sprint 3.1.4)
            exportDeviceData() {
                // Get current device data from the modal
                const modal = document.getElementById('deviceModal');
                if (!modal.classList.contains('show')) {
                    this.showToast('No device modal is currently open', 'warning');
                    return;
                }

                // Extract device hostname from modal title or data
                const modalTitle = modal.querySelector('.modal-title').textContent;
                const hostname = modalTitle.replace('Device Security Overview', '').replace(/[^a-zA-Z0-9.-]/g, '').trim();
                
                // Find the device data
                const device = this.devices.find(d => d.hostname.includes(hostname) || hostname.includes(d.hostname));
                if (!device) {
                    this.showToast('Could not find device data for export', 'error');
                    return;
                }

                // Prepare comprehensive device export data
                const deviceSummary = {
                    'Device Hostname': device.hostname,
                    'Total Vulnerabilities': device.vulnerabilities.length,
                    'Critical VPR': (device.criticalVPR || 0).toFixed(1),
                    'High VPR': (device.highVPR || 0).toFixed(1),
                    'Medium VPR': (device.mediumVPR || 0).toFixed(1),
                    'Low VPR': (device.lowVPR || 0).toFixed(1),
                    'Total VPR': (device.totalVPR || 0).toFixed(1),
                    'Export Date': new Date().toLocaleString(),
                    'Generated By': 'HexTrackr Vulnerability Management System'
                };

                const vulnerabilityData = device.vulnerabilities.map(vuln => ({
                    'CVE': vuln.cve || 'N/A',
                    'VPR Score': vuln.vpr_score || 0,
                    'Severity': vuln.severity || 'Low',
                    'Plugin Name': vuln.plugin_name || 'Unknown',
                    'Description': vuln.description || vuln.plugin_name || 'No description',
                    'Solution': vuln.solution || 'No solution provided',
                    'Port': vuln.port || 'N/A',
                    'Protocol': vuln.protocol || 'N/A',
                    'First Seen': vuln.first_seen ? new Date(vuln.first_seen).toLocaleDateString() : 'N/A',
                    'Last Seen': vuln.last_seen ? new Date(vuln.last_seen).toLocaleDateString() : 'N/A',
                    'Plugin Output': vuln.plugin_output || 'No output available'
                }));

                // Create multi-sheet CSV-like format
                let csvContent = '';
                
                // Device Summary Section
                csvContent += 'DEVICE SECURITY OVERVIEW\\n';
                csvContent += '========================\\n\\n';
                Object.entries(deviceSummary).forEach(([key, value]) => {
                    csvContent += `${key},${value}\\n`;
                });
                
                csvContent += '\\n\\nVULNERABILITY DETAILS\\n';
                csvContent += '====================\\n\\n';
                
                // Vulnerability Details Section
                csvContent += Papa.unparse(vulnerabilityData);

                // Export the data
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `device_${device.hostname}_comprehensive_report_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                this.showToast(`Comprehensive device data exported for ${device.hostname}`, 'success');
            }

            generateDeviceReport() {
                // Get current device data from the modal
                const modal = document.getElementById('deviceModal');
                if (!modal.classList.contains('show')) {
                    this.showToast('No device modal is currently open', 'warning');
                    return;
                }

                // Extract device hostname from modal title
                const modalTitle = modal.querySelector('.modal-title').textContent;
                const hostname = modalTitle.replace('Device Security Overview', '').replace(/[^a-zA-Z0-9.-]/g, '').trim();
                
                // Find the device data
                const device = this.devices.find(d => d.hostname.includes(hostname) || hostname.includes(d.hostname));
                if (!device) {
                    this.showToast('Could not find device data for report generation', 'error');
                    return;
                }

                // Generate HTML report
                const reportHtml = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Device Security Report - ${device.hostname}</title>
                    <link href="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta17/dist/css/tabler.min.css" rel="stylesheet">
                    <style>
                        body { font-family: 'Segoe UI', sans-serif; margin: 20px; }
                        .report-header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #206bc4; padding-bottom: 20px; }
                        .summary-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 30px; }
                        .stat-card { background: #f8fafc; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #e2e8f0; }
                        .vuln-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        .vuln-table th, .vuln-table td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; }
                        .vuln-table th { background: #206bc4; color: white; }
                        .severity-critical { color: #dc3545; font-weight: bold; }
                        .severity-high { color: #fd7e14; font-weight: bold; }
                        .severity-medium { color: #ffc107; font-weight: bold; }
                        .severity-low { color: #198754; font-weight: bold; }
                        .footer { margin-top: 40px; text-align: center; color: #6c757d; font-size: 0.9em; }
                    </style>
                </head>
                <body>
                    <div class="report-header">
                        <h1>🛡️ Device Security Report</h1>
                        <h2>${device.hostname}</h2>
                        <p>Generated on ${new Date().toLocaleString()} by HexTrackr</p>
                    </div>

                    <div class="summary-stats">
                        <div class="stat-card">
                            <h3 class="severity-critical">${device.criticalCount || 0}</h3>
                            <p>Critical<br>VPR: ${(device.criticalVPR || 0).toFixed(1)}</p>
                        </div>
                        <div class="stat-card">
                            <h3 class="severity-high">${device.highCount || 0}</h3>
                            <p>High<br>VPR: ${(device.highVPR || 0).toFixed(1)}</p>
                        </div>
                        <div class="stat-card">
                            <h3 class="severity-medium">${device.mediumCount || 0}</h3>
                            <p>Medium<br>VPR: ${(device.mediumVPR || 0).toFixed(1)}</p>
                        </div>
                        <div class="stat-card">
                            <h3 class="severity-low">${device.lowCount || 0}</h3>
                            <p>Low<br>VPR: ${(device.lowVPR || 0).toFixed(1)}</p>
                        </div>
                    </div>

                    <h3>📊 Total Risk Score: ${(device.totalVPR || 0).toFixed(1)} VPR</h3>

                    <table class="vuln-table">
                        <thead>
                            <tr>
                                <th>CVE</th>
                                <th>VPR Score</th>
                                <th>Severity</th>
                                <th>Plugin Name</th>
                                <th>Port</th>
                                <th>First Seen</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${device.vulnerabilities.map(vuln => `
                                <tr>
                                    <td>${vuln.cve || 'N/A'}</td>
                                    <td><strong>${vuln.vpr_score || 0}</strong></td>
                                    <td class="severity-${(vuln.severity || 'low').toLowerCase()}">${vuln.severity || 'Low'}</td>
                                    <td>${vuln.plugin_name || 'Unknown'}</td>
                                    <td>${vuln.port || 'N/A'}</td>
                                    <td>${vuln.first_seen ? new Date(vuln.first_seen).toLocaleDateString() : 'N/A'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>

                    <div class="footer">
                        <p>This report contains ${device.vulnerabilities.length} vulnerabilities detected for ${device.hostname}</p>
                        <p>Generated by HexTrackr Vulnerability Management System</p>
                    </div>
                </body>
                </html>
                `;

                // Create and download HTML report
                const blob = new Blob([reportHtml], { type: 'text/html;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `device_${device.hostname}_security_report_${new Date().toISOString().split('T')[0]}.html`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                this.showToast(`HTML security report generated for ${device.hostname}`, 'success');
            }
        }

        // Initialize the application
        let vulnManager;
        document.addEventListener('DOMContentLoaded', () => {
            vulnManager = new ModernVulnManager();
            
            // Load saved settings
            const savedSettings = {
                cisco_client_id: localStorage.getItem('cisco_client_id') || '',
                cisco_client_secret: localStorage.getItem('cisco_client_secret') || '',
                tenable_api_key: localStorage.getItem('tenable_api_key') || '',
                tenable_secret_key: localStorage.getItem('tenable_secret_key') || '',
                qualys_api_key: localStorage.getItem('qualys_api_key') || ''
            };

            Object.entries(savedSettings).forEach(([key, value]) => {
                const element = document.getElementById(key.replace(/_([a-z])/g, (match, letter) => letter.toUpperCase()));
                if (element) {
                    element.value = value;
                }
            });
        });
    </script>
</body>
</html>
