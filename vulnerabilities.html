<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VulnTrackr - Vulnerability Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        /* Modern Light Theme */
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: #2d3748;
        }

        .app-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.06);
        }

        .main-container {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            margin: 20px auto;
            padding: 30px;
        }

        /* Severity Cards - Modern Clean Design */
        .severity-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 1px solid rgba(0, 0, 0, 0.05);
            border-radius: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
        }

        .severity-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--severity-color);
        }

        .severity-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .severity-card.critical::before { background: linear-gradient(135deg, #ff6b6b, #ee5a24); }
        .severity-card.high::before { background: linear-gradient(135deg, #ffa726, #ff9800); }
        .severity-card.medium::before { background: linear-gradient(135deg, #42a5f5, #2196f3); }
        .severity-card.low::before { background: linear-gradient(135deg, #66bb6a, #4caf50); }

        .severity-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #1a202c;
            margin: 0;
        }

        .severity-label {
            color: #718096;
            font-weight: 500;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Upload Area */
        .upload-area {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 16px;
            border: 2px dashed rgba(255, 255, 255, 0.3);
            padding: 3rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: rgba(255, 255, 255, 0.8);
            transform: scale(1.02);
        }

        .upload-area.dragover {
            border-color: #4facfe;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        /* Asset and Vulnerability Cards */
        .asset-card, .vuln-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 1px solid rgba(0, 0, 0, 0.05);
            border-radius: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            position: relative;
        }

        .asset-card:hover, .vuln-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12);
            border-color: rgba(102, 126, 234, 0.3);
        }

        .severity-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .severity-critical .severity-indicator { background: #ff6b6b; }
        .severity-high .severity-indicator { background: #ffa726; }
        .severity-medium .severity-indicator { background: #42a5f5; }
        .severity-low .severity-indicator { background: #66bb6a; }

        /* Buttons */
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 12px;
            padding: 12px 24px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-outline-primary {
            border: 2px solid #667eea;
            color: #667eea;
            border-radius: 12px;
            padding: 12px 24px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-outline-primary:hover {
            background: #667eea;
            border-color: #667eea;
            transform: translateY(-2px);
        }

        /* View Toggle */
        .view-toggle {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .view-toggle .btn {
            border-radius: 8px;
            border: none;
            padding: 10px 20px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .view-toggle .btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        /* Modal Styling */
        .modal-content {
            border-radius: 20px;
            border: none;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            border-radius: 20px 20px 0 0;
        }

        /* Card Actions */
        .card-actions {
            opacity: 0.7;
            transition: all 0.3s ease;
        }

        .card-actions:hover {
            opacity: 1;
        }

        .card-actions .btn {
            border: 1px solid;
            padding: 4px 8px;
            font-size: 0.75rem;
            border-radius: 4px;
        }

        .card-actions .btn:hover {
            transform: scale(1.1);
        }

        /* Search and filter styles */
        .search-box .input-group {
            border-radius: 8px;
            overflow: hidden;
        }

        .search-box .form-control {
            border-right: none;
        }

        .search-box .input-group-text {
            background-color: #f8f9fa;
            border-right: none;
        }

        .filter-controls .form-select {
            border-radius: 6px;
        }

        /* Table styles */
        .table th {
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
            background-color: #343a40 !important;
            color: white !important;
        }

        .table tbody tr:hover {
            background-color: rgba(0, 123, 255, 0.1);
        }

        .btn-group-sm .btn {
            padding: 0.2rem 0.4rem;
            font-size: 0.75rem;
        }

        /* Sparkline containers */
        .sparkline-container {
            width: 60px;
            height: 30px;
            opacity: 0.7;
        }

        .sparkline-container svg {
            width: 100% !important;
            height: 100% !important;
        }

        /* Sort controls */
        .sort-controls {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        /* Vendor badges */
        .vendor-badge {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            color: #1976d2;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        /* Animation for loading states */
        .loading-shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        /* Responsive improvements */
        @media (max-width: 768px) {
            .main-container {
                margin: 10px;
                padding: 20px;
            }
            
            .severity-card {
                margin-bottom: 15px;
            }
            
            .severity-value {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <div class="app-header py-3">
            <div class="container">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="h3 mb-0" style="color: #667eea;">
                            <i class="fas fa-shield-alt me-2"></i>VulnTrackr - Vulnerability Management
                        </h1>
                    </div>
                    <div>
                        <button class="btn btn-outline-success me-2" onclick="showAPIModal()">
                            <i class="fas fa-plug me-2"></i>Connect to APIs
                        </button>
                        <a href="tickets.html" class="btn btn-outline-primary">
                            <i class="fas fa-ticket-alt me-2"></i>Ticket Management
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="main-container">
                <!-- Upload Section -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="upload-area" id="uploadArea">
                            <i class="fas fa-cloud-upload-alt fa-3x mb-3"></i>
                            <h4 class="mb-2">Upload Vulnerability Data</h4>
                            <p class="mb-3">Drop CSV files here or click to select</p>
                            <input type="file" id="fileInput" class="d-none" accept=".csv" multiple>
                            <button class="btn btn-light btn-lg" onclick="document.getElementById('fileInput').click()">
                                <i class="fas fa-file-upload me-2"></i>Choose Files
                            </button>
                            <div class="mt-3">
                                <small class="text-light">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Supports Tenable, Qualys, Nessus, and other standard vulnerability scanner formats
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Trend Chart Section (Hidden initially) -->
                <div class="row mb-4" id="trendChartSection" style="display: none;">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="mb-0">
                                        <i class="fas fa-chart-line me-2"></i>Vulnerability Trends Over Time
                                    </h5>
                                    <small class="text-muted">Track vulnerability severity changes across imports</small>
                                </div>
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-outline-primary" onclick="toggleUploadArea()">
                                        <i class="fas fa-upload me-1"></i>Upload More Data
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="showAPIModal()">
                                        <i class="fas fa-plug me-1"></i>Connect APIs
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="trendChart" style="height: 300px;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Severity Statistics -->
                <div class="row mb-4">
                    <div class="col-md-3 mb-3">
                        <div class="severity-card critical">
                            <div class="card-body text-center">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <i class="fas fa-exclamation-triangle fa-2x" style="color: #ff6b6b;"></i>
                                    <div id="criticalSparkline" class="sparkline-container"></div>
                                </div>
                                <h2 class="severity-value" id="criticalValue">0.0</h2>
                                <p class="severity-label mb-0">Critical VPR</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="severity-card high">
                            <div class="card-body text-center">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <i class="fas fa-exclamation-circle fa-2x" style="color: #ffa726;"></i>
                                    <div id="highSparkline" class="sparkline-container"></div>
                                </div>
                                <h2 class="severity-value" id="highValue">0.0</h2>
                                <p class="severity-label mb-0">High VPR</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="severity-card medium">
                            <div class="card-body text-center">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <i class="fas fa-info-circle fa-2x" style="color: #42a5f5;"></i>
                                    <div id="mediumSparkline" class="sparkline-container"></div>
                                </div>
                                <h2 class="severity-value" id="mediumValue">0.0</h2>
                                <p class="severity-label mb-0">Medium VPR</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="severity-card low">
                            <div class="card-body text-center">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <i class="fas fa-shield-alt fa-2x" style="color: #66bb6a;"></i>
                                    <div id="lowSparkline" class="sparkline-container"></div>
                                </div>
                                <h2 class="severity-value" id="lowValue">0.0</h2>
                                <p class="severity-label mb-0">Low VPR</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- View Controls -->
                <div class="row mb-4">
                    <div class="col-lg-4">
                        <div class="view-toggle">
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="viewMode" id="assetView" value="asset" checked>
                                <label class="btn" for="assetView">
                                    <i class="fas fa-server me-2"></i>Asset View
                                </label>
                                
                                <input type="radio" class="btn-check" name="viewMode" id="vulnView" value="vuln">
                                <label class="btn" for="vulnView">
                                    <i class="fas fa-bug me-2"></i>Vulnerability View
                                </label>

                                <input type="radio" class="btn-check" name="viewMode" id="tableView" value="table">
                                <label class="btn" for="tableView">
                                    <i class="fas fa-table me-2"></i>Table View
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="search-box">
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" class="form-control" id="searchInput" placeholder="Search assets, vulnerabilities, CVEs...">
                                <button class="btn btn-outline-secondary" type="button" id="clearSearch">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="filter-controls">
                            <div class="row align-items-center">
                                <div class="col-4">
                                    <label for="severityFilter" class="form-label mb-0 small">Severity:</label>
                                </div>
                                <div class="col-4">
                                    <select class="form-select form-select-sm" id="severityFilter">
                                        <option value="">All</option>
                                        <option value="critical">Critical</option>
                                        <option value="high">High</option>
                                        <option value="medium">Medium</option>
                                        <option value="low">Low</option>
                                    </select>
                                </div>
                                <div class="col-4">
                                    <select class="form-select form-select-sm" id="sortBy">
                                        <option value="critical">Critical Count</option>
                                        <option value="high">High Count</option>
                                        <option value="medium">Medium Count</option>
                                        <option value="total">Total Vulnerabilities</option>
                                        <option value="hostname">Hostname</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Data Display Area -->
                <div id="assetCardsContainer" class="row">
                    <!-- Asset cards will be dynamically loaded here -->
                </div>

                <!-- Asset Pagination -->
                <div id="assetPaginationContainer" class="row mt-3" style="display: none;">
                    <div class="col-12">
                        <nav aria-label="Asset pagination">
                            <ul class="pagination justify-content-center" id="assetPagination">
                                <!-- Pagination controls will be dynamically loaded here -->
                            </ul>
                        </nav>
                        <div class="text-center">
                            <small class="text-muted">Items per page: 
                                <select id="assetItemsPerPage" class="form-select form-select-sm d-inline-block" style="width: auto;">
                                    <option value="12">12</option>
                                    <option value="24" selected>24</option>
                                    <option value="48">48</option>
                                    <option value="96">96</option>
                                </select>
                            </small>
                        </div>
                    </div>
                </div>

                <div id="vulnCardsContainer" class="row" style="display: none;">
                    <!-- Vulnerability cards will be dynamically loaded here -->
                </div>

                <!-- Vulnerability Pagination -->
                <div id="vulnPaginationContainer" class="row mt-3" style="display: none;">
                    <div class="col-12">
                        <nav aria-label="Vulnerability pagination">
                            <ul class="pagination justify-content-center" id="vulnPagination">
                                <!-- Pagination controls will be dynamically loaded here -->
                            </ul>
                        </nav>
                        <div class="text-center">
                            <small class="text-muted">Items per page: 
                                <select id="vulnItemsPerPage" class="form-select form-select-sm d-inline-block" style="width: auto;">
                                    <option value="12">12</option>
                                    <option value="24" selected>24</option>
                                    <option value="48">48</option>
                                    <option value="96">96</option>
                                </select>
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Table View -->
                <div id="tableContainer" style="display: none;">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="fas fa-table me-2"></i>Vulnerability Table View
                            </h6>
                            <div class="d-flex align-items-center">
                                <small class="text-muted me-3">Items per page:</small>
                                <select id="tableItemsPerPage" class="form-select form-select-sm" style="width: auto;">
                                    <option value="25">25</option>
                                    <option value="50" selected>50</option>
                                    <option value="100">100</option>
                                    <option value="200">200</option>
                                </select>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0" id="vulnerabilityTable">
                                    <thead class="table-dark">
                                        <tr>
                                            <th><i class="fas fa-server me-1"></i>Asset</th>
                                            <th><i class="fas fa-network-wired me-1"></i>IP Address</th>
                                            <th><i class="fas fa-shield-alt me-1"></i>CVE</th>
                                            <th><i class="fas fa-bug me-1"></i>Vulnerability</th>
                                            <th><i class="fas fa-exclamation-triangle me-1"></i>Severity</th>
                                            <th><i class="fas fa-chart-line me-1"></i>VPR Score</th>
                                            <th><i class="fas fa-industry me-1"></i>Vendor</th>
                                            <th><i class="fas fa-cogs me-1"></i>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tableBody">
                                        <!-- Table rows will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Table Pagination -->
                <div id="tablePaginationContainer" class="row mt-3" style="display: none;">
                    <div class="col-12">
                        <nav aria-label="Table pagination">
                            <ul class="pagination justify-content-center" id="tablePagination">
                                <!-- Pagination controls will be dynamically loaded here -->
                            </ul>
                        </nav>
                    </div>
                </div>

                <!-- Last Upload Info -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted">Last Upload Information</h6>
                                <p class="card-text mb-0" id="lastUploadInfo">No data uploaded yet</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Data Management -->
                <div class="row mt-3">
                    <div class="col-12 text-center">
                        <button class="btn btn-outline-danger" onclick="clearVulnData()">
                            <i class="fas fa-trash-alt me-2"></i>Clear All Data
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Asset Details Modal -->
    <div class="modal fade" id="assetModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Asset Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="assetModalBody">
                    <!-- Asset details will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Vulnerability Details Modal -->
    <div class="modal fade" id="vulnModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Vulnerability Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="vulnModalBody">
                    <!-- Vulnerability details will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Asset Modal -->
    <div class="modal fade" id="editAssetModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Asset</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editAssetForm">
                        <input type="hidden" id="editAssetOriginalHostname">
                        <div class="mb-3">
                            <label for="editAssetHostname" class="form-label">Hostname</label>
                            <input type="text" class="form-control" id="editAssetHostname" required>
                        </div>
                        <div class="mb-3">
                            <label for="editAssetIP" class="form-label">IP Address</label>
                            <input type="text" class="form-control" id="editAssetIP">
                        </div>
                        <div class="mb-3">
                            <label for="editAssetVendor" class="form-label">Vendor</label>
                            <input type="text" class="form-control" id="editAssetVendor">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveAssetChanges()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Vulnerability Modal -->
    <div class="modal fade" id="editVulnModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Vulnerability</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editVulnForm">
                        <input type="hidden" id="editVulnOriginalId">
                        <div class="mb-3">
                            <label for="editVulnName" class="form-label">Vulnerability Name</label>
                            <input type="text" class="form-control" id="editVulnName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editVulnCVE" class="form-label">CVE</label>
                            <input type="text" class="form-control" id="editVulnCVE">
                        </div>
                        <div class="mb-3">
                            <label for="editVulnSeverity" class="form-label">Severity</label>
                            <select class="form-select" id="editVulnSeverity" required>
                                <option value="critical">Critical</option>
                                <option value="high">High</option>
                                <option value="medium">Medium</option>
                                <option value="low">Low</option>
                                <option value="info">Info</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="editVulnVPR" class="form-label">VPR Score</label>
                            <input type="number" class="form-control" id="editVulnVPR" min="0" max="10" step="0.1">
                        </div>
                        <div class="mb-3">
                            <label for="editVulnVendor" class="form-label">Vendor</label>
                            <input type="text" class="form-control" id="editVulnVendor">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveVulnChanges()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- API Connection Modal -->
    <div class="modal fade" id="apiModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Connect to Vendor APIs</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6><i class="fas fa-shield-alt me-2"></i>Cisco Security</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="ciscoApiKey" class="form-label">API Key</label>
                                        <input type="password" class="form-control" id="ciscoApiKey" placeholder="Enter Cisco API key">
                                    </div>
                                    <div class="mb-3">
                                        <label for="ciscoSecret" class="form-label">API Secret</label>
                                        <input type="password" class="form-control" id="ciscoSecret" placeholder="Enter API secret">
                                    </div>
                                    <button class="btn btn-primary btn-sm" onclick="testCiscoAPI()">Test Connection</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6><i class="fas fa-fire me-2"></i>Palo Alto Networks</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="paloApiKey" class="form-label">API Key</label>
                                        <input type="password" class="form-control" id="paloApiKey" placeholder="Enter Palo Alto API key">
                                    </div>
                                    <div class="mb-3">
                                        <label for="paloHost" class="form-label">Host</label>
                                        <input type="text" class="form-control" id="paloHost" placeholder="firewall.company.com">
                                    </div>
                                    <button class="btn btn-primary btn-sm" onclick="testPaloAPI()">Test Connection</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6><i class="fas fa-bug me-2"></i>Tenable</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="tenableApiKey" class="form-label">Access Key</label>
                                        <input type="password" class="form-control" id="tenableApiKey" placeholder="Enter Tenable access key">
                                    </div>
                                    <div class="mb-3">
                                        <label for="tenableSecret" class="form-label">Secret Key</label>
                                        <input type="password" class="form-control" id="tenableSecret" placeholder="Enter secret key">
                                    </div>
                                    <button class="btn btn-primary btn-sm" onclick="testTenableAPI()">Test Connection</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6><i class="fas fa-search me-2"></i>Qualys</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="qualysUsername" class="form-label">Username</label>
                                        <input type="text" class="form-control" id="qualysUsername" placeholder="Enter Qualys username">
                                    </div>
                                    <div class="mb-3">
                                        <label for="qualysPassword" class="form-label">Password</label>
                                        <input type="password" class="form-control" id="qualysPassword" placeholder="Enter password">
                                    </div>
                                    <button class="btn btn-primary btn-sm" onclick="testQualysAPI()">Test Connection</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-success" onclick="syncFromAPIs()">Sync Data from APIs</button>
                </div>
            </div>
        </div>
    </div>

    <!-- API Configuration Modal -->
    <div class="modal fade" id="apiModal" tabindex="-1" aria-labelledby="apiModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="apiModalLabel">
                        <i class="fas fa-plug me-2"></i>API Configuration & Security
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-shield-alt me-2"></i>
                        <strong>Security Notice:</strong> All API credentials are encrypted using AES-256 encryption before being stored locally. Your credentials never leave your browser.
                    </div>

                    <!-- Cisco PSIRT API Configuration -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fab fa-cisco me-2"></i>Cisco PSIRT openVuln API
                                <span class="badge bg-success ms-2" id="ciscoStatus">Not Configured</span>
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="ciscoClientId" class="form-label">
                                            <i class="fas fa-key me-1"></i>Client ID
                                        </label>
                                        <input type="text" class="form-control" id="ciscoClientId" placeholder="Enter Cisco API Client ID">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="ciscoClientSecret" class="form-label">
                                            <i class="fas fa-lock me-1"></i>Client Secret
                                        </label>
                                        <input type="password" class="form-control" id="ciscoClientSecret" placeholder="Enter Cisco API Client Secret">
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <button class="btn btn-primary me-2" onclick="testCiscoAPI()">
                                    <i class="fas fa-play me-1"></i>Test Connection
                                </button>
                                <button class="btn btn-success me-2" onclick="saveCiscoCredentials()">
                                    <i class="fas fa-save me-1"></i>Save & Encrypt
                                </button>
                                <button class="btn btn-outline-secondary" onclick="loadCiscoCredentials()">
                                    <i class="fas fa-download me-1"></i>Load Saved
                                </button>
                            </div>
                            <div id="ciscoTestResult" class="alert" style="display: none;"></div>
                        </div>
                    </div>

                    <!-- Data Sync Options -->
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-sync me-2"></i>Data Synchronization
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <button class="btn btn-outline-primary w-100 mb-2" onclick="syncCiscoVulnerabilities()">
                                        <i class="fas fa-download me-2"></i>Sync Cisco Vulnerabilities
                                    </button>
                                </div>
                                <div class="col-md-6">
                                    <button class="btn btn-outline-info w-100 mb-2" onclick="syncCiscoAdvisories()">
                                        <i class="fas fa-file-alt me-2"></i>Sync Security Advisories
                                    </button>
                                </div>
                            </div>
                            <div class="mt-3">
                                <div class="progress" id="syncProgress" style="display: none;">
                                    <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                                </div>
                                <div id="syncStatus" class="text-muted small mt-2"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Future API Integrations -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-rocket me-2"></i>Future API Integrations <span class="badge bg-info">Roadmap</span>
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6><i class="fas fa-shield-alt text-warning me-2"></i>Palo Alto Networks</h6>
                                    <div class="alert alert-light border">
                                        <strong>🔗 Get API Access:</strong><br>
                                        <a href="https://developer.paloaltonetworks.com/" target="_blank" class="text-decoration-none">
                                            <i class="fas fa-external-link-alt me-1"></i>developer.paloaltonetworks.com
                                        </a><br>
                                        <small class="text-muted">
                                            Available APIs: Prisma Cloud, Cortex XDR, PAN-OS, WildFire<br>
                                            • Threat intelligence feeds<br>
                                            • Security posture data<br>
                                            • Firewall policy analysis
                                        </small>
                                    </div>
                                    
                                    <div class="mb-2">
                                        <label class="form-label text-muted">API Key <span class="badge bg-secondary">Planned</span></label>
                                        <input type="password" class="form-control" placeholder="Enter Palo Alto API key" disabled>
                                    </div>
                                    
                                    <select class="form-select mb-2" disabled>
                                        <option>Select Palo Alto Product</option>
                                        <option>Prisma Cloud</option>
                                        <option>Cortex XDR</option>
                                        <option>PAN-OS Firewall</option>
                                        <option>WildFire</option>
                                    </select>
                                </div>
                                
                                <div class="col-md-6">
                                    <h6><i class="fas fa-network-wired text-primary me-2"></i>SNMP Network Polling</h6>
                                    <div class="alert alert-light border">
                                        <strong>🎯 Advanced Network Discovery:</strong><br>
                                        <small class="text-muted">
                                            • Real-time device status via SNMPv2/v3<br>
                                            • Hardware health monitoring<br>
                                            • Firmware version detection<br>
                                            • Network interface analysis<br>
                                            • Vulnerability correlation by device type<br>
                                            <br>
                                            <strong>🐳 Docker Implementation:</strong><br>
                                            • Containerized SNMP polling service<br>
                                            • Node.js backend with net-snmp library<br>
                                            • RESTful API for browser integration<br>
                                            • Scalable multi-network support
                                        </small>
                                    </div>
                                    
                                    <div class="mb-2">
                                        <label class="form-label text-muted">SNMP Community <span class="badge bg-secondary">Planned</span></label>
                                        <input type="password" class="form-control" placeholder="Community string" disabled>
                                    </div>
                                    
                                    <div class="mb-2">
                                        <label class="form-label text-muted">Network Range</label>
                                        <input type="text" class="form-control" placeholder="192.168.1.0/24" disabled>
                                    </div>
                                    
                                    <button class="btn btn-outline-primary btn-sm me-2" disabled>
                                        <i class="fas fa-search me-1"></i>Network Discovery
                                    </button>
                                    <button class="btn btn-outline-success btn-sm" disabled>
                                        <i class="fas fa-heartbeat me-1"></i>Health Monitor
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Ansible Automation Integration -->
                            <div class="row mt-4">
                                <div class="col-12">
                                    <h6><i class="fab fa-ansible text-danger me-2"></i>Ansible Automation Platform</h6>
                                    <div class="alert alert-light border">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <strong>🤖 Automated Remediation:</strong><br>
                                                <small class="text-muted">
                                                    • Automated patch deployment<br>
                                                    • Configuration compliance enforcement<br>
                                                    • Vulnerability remediation playbooks<br>
                                                    • Bulk system updates and hardening
                                                </small>
                                            </div>
                                            <div class="col-md-6">
                                                <strong>🐳 Container Architecture:</strong><br>
                                                <small class="text-muted">
                                                    • Docker Compose stack deployment<br>
                                                    • Ansible AWX/Tower integration<br>
                                                    • Secure credential vault management<br>
                                                    • Playbook execution monitoring
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-4">
                                            <label class="form-label text-muted">Ansible Tower URL <span class="badge bg-secondary">Planned</span></label>
                                            <input type="url" class="form-control" placeholder="https://ansible.company.com" disabled>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label text-muted">API Token</label>
                                            <input type="password" class="form-control" placeholder="Ansible API token" disabled>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label text-muted">Organization</label>
                                            <input type="text" class="form-control" placeholder="Default" disabled>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-3">
                                        <button class="btn btn-outline-danger btn-sm me-2" disabled>
                                            <i class="fab fa-ansible me-1"></i>Test Connection
                                        </button>
                                        <button class="btn btn-outline-warning btn-sm me-2" disabled>
                                            <i class="fas fa-play me-1"></i>Run Patch Playbook
                                        </button>
                                        <button class="btn btn-outline-info btn-sm" disabled>
                                            <i class="fas fa-shield-alt me-1"></i>Security Hardening
                                        </button>
                                    </div>
                                </div>
                            </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-danger" onclick="clearAPICredentials()">
                        <i class="fas fa-trash me-1"></i>Clear All Credentials
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let vulnData = [];
        let historyData = JSON.parse(localStorage.getItem('vulnHistory') || '[]');
        
        // Pagination variables
        let currentAssetPage = 1;
        let currentVulnPage = 1;
        let currentTablePage = 1;
        let assetItemsPerPage = 24;
        let vulnItemsPerPage = 24;
        let tableItemsPerPage = 50;
        let currentAssetData = [];
        let currentVulnGroupData = [];
        let filteredData = [];

        // Search and filter state
        let searchTerm = '';
        let severityFilter = '';

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            initializeSortable();
            loadExistingData();
            
            // PRODUCTION MODE: Sample data loading disabled
            if (vulnData.length === 0) {
                console.log('PRODUCTION MODE: No sample data loading for legacy page');
                // loadSampleData(); // DISABLED FOR PRODUCTION
            }
        });

        function setupEventListeners() {
            // File upload handlers
            const fileInput = document.getElementById('fileInput');
            const uploadArea = document.getElementById('uploadArea');

            fileInput.addEventListener('change', handleFileUpload);
            
            // Drag and drop
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    fileInput.files = files;
                    handleFileUpload({ target: { files } });
                }
            });

            // View mode toggles
            document.querySelectorAll('input[name="viewMode"]').forEach(radio => {
                radio.addEventListener('change', updateCardViews);
            });

            // Sort dropdown
            document.getElementById('sortBy').addEventListener('change', updateCardViews);
            
            // Pagination event listeners
            document.getElementById('assetItemsPerPage').addEventListener('change', function() {
                assetItemsPerPage = parseInt(this.value);
                currentAssetPage = 1;
                updateAssetCards();
            });
            
            document.getElementById('vulnItemsPerPage').addEventListener('change', function() {
                vulnItemsPerPage = parseInt(this.value);
                currentVulnPage = 1;
                updateVulnCards();
            });

            // Search functionality
            document.getElementById('searchInput').addEventListener('input', function() {
                filterAndDisplayData();
            });

            document.getElementById('clearSearch').addEventListener('click', function() {
                document.getElementById('searchInput').value = '';
                filterAndDisplayData();
            });

            // Filter functionality
            document.getElementById('severityFilter').addEventListener('change', function() {
                filterAndDisplayData();
            });

            // Table pagination
            document.getElementById('tableItemsPerPage').addEventListener('change', function() {
                tableItemsPerPage = parseInt(this.value);
                currentTablePage = 1;
                updateTableView();
            });
        }

        function handleFileUpload(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            Array.from(files).forEach(file => {
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        processVulnData(results.data, file);
                    },
                    error: function(error) {
                        console.error('Error parsing CSV:', error);
                        alert('Error parsing CSV file: ' + error.message);
                    }
                });
            });
        }

        function processVulnData(data, file) {
            console.log('Processing vulnerability data from file:', file.name);
            console.log('Raw CSV data sample:', data.slice(0, 3));
            console.log('CSV Headers found:', Object.keys(data[0] || {}));
            
            if (!data || data.length === 0) {
                alert('No data found in CSV file');
                return;
            }

            // Check if this is a very large file that needs batch processing
            if (data.length > 5000) {
                processBatchVulnData(data, file);
                return;
            }

            // Extract date from filename or use current date
            let fileDate = new Date();
            const dateMatch = file.name.match(/(\d{4}[-_]\d{2}[-_]\d{2})/);
            if (dateMatch) {
                fileDate = new Date(dateMatch[1].replace(/_/g, '-'));
            }

            // Process each row with flexible column mapping
            const processedData = data.map((row, index) => {
                // Map common column variations to our standard format
                const mappedRow = {};
                
                // Hostname mapping - specific to your Cisco CSV format
                mappedRow.hostname = row['asset.name'] || row.hostname || row.asset_name || row.host || row.target || '';
                
                // IP Address mapping - specific to your Cisco CSV format
                mappedRow.ipAddress = row['asset.display_ipv4_address'] || row.ip || row.ip_address || row.target_ip || row.asset_ip || '';
                
                // Vendor mapping - specific to your Cisco CSV format
                mappedRow.vendor = row['definition.family'] || row.vendor || row.family || row.plugin_family || row.scanner || 'Unknown';
                
                // Vulnerability ID mapping - specific to your Cisco CSV format
                mappedRow.definitionId = row['definition.id'] || row.plugin_id || row.vuln_id || row.id || '';
                
                // CVE mapping - specific to your Cisco CSV format
                mappedRow.cve = row['definition.cve'] || row.cve || row.cve_id || '';
                
                // Vulnerability name mapping - specific to your Cisco CSV format
                mappedRow.definitionName = row['definition.name'] || row.title || row.name || row.description || row.plugin_name || '';
                
                // Severity mapping
                let severity = row.severity || row['severity'] || row.risk || row.threat_level || 'Unknown';
                severity = severity.toString().toLowerCase();
                
                // Normalize severity values
                if (severity.includes('critical') || severity.includes('4')) severity = 'critical';
                else if (severity.includes('high') || severity.includes('3')) severity = 'high';
                else if (severity.includes('medium') || severity.includes('2') || severity.includes('med')) severity = 'medium';
                else if (severity.includes('low') || severity.includes('1')) severity = 'low';
                else if (severity.includes('info') || severity.includes('0')) severity = 'info';
                
                mappedRow.severity = severity;
                
                // VPR Score mapping - specific to your Cisco CSV format
                let vprScore = row['definition.vpr.score'] || row.vpr_score || row.vpr || row.cvss_score || row.cvss || 0;
                mappedRow.vprScore = parseFloat(vprScore) || 0;
                
                // State mapping
                mappedRow.state = row.state || row.status || 'ACTIVE';
                
                // Date mapping
                mappedRow.date = fileDate.toLocaleDateString();
                
                // Debug log for first few rows
                if (index < 3) {
                    console.log(`Row ${index} mapping:`, {
                        original: row,
                        mapped: mappedRow
                    });
                }
                
                return mappedRow;
            }).filter(row => row.hostname && row.hostname.trim() !== ''); // Filter out rows without hostnames

            console.log('Processed data sample:', processedData.slice(0, 3));
            console.log('Total processed records:', processedData.length);
            
            if (processedData.length === 0) {
                alert('No valid vulnerability data found in CSV. Please check that the file has hostname data in columns like "asset.name", "hostname", or "host".');
                return;
            }

            // Add to existing data
            vulnData = [...vulnData, ...processedData];
            
            // Remove duplicates based on hostname + definitionId
            vulnData = vulnData.filter((item, index, self) => 
                index === self.findIndex(t => t.hostname === item.hostname && t.definitionId === item.definitionId)
            );

            // Calculate statistics and update displays
            const stats = calculateStatistics(vulnData, fileDate);
            updateStatCards(stats);
            updateCardViews();
            updateLastUploadInfo(file.name, fileDate, processedData.length);
            
            // Save to localStorage
            localStorage.setItem('hextrackr_vuln_data', JSON.stringify(vulnData));
            
            // Save to history
            saveToHistory(file.name, fileDate, stats);
            
            // Show trend chart section if we have data
            if (vulnData.length > 0) {
                document.getElementById('uploadArea').style.display = 'none';
                document.getElementById('trendChartSection').style.display = 'block';
                // Update trend chart after a short delay to ensure DOM is ready
                setTimeout(updateTrendChart, 100);
            }
            
            alert(`Successfully processed ${processedData.length} vulnerability records!`);
        }

        function processBatchVulnData(data, file) {
            console.log(`Processing large CSV file with ${data.length} rows in batches...`);
            
            // SAFEGUARD 1: Maximum record limit (100K records for browser stability)
            const MAX_RECORDS = 100000;
            if (data.length > MAX_RECORDS) {
                if (!confirm(`This file contains ${data.length.toLocaleString()} records. For optimal performance, we recommend processing only the first ${MAX_RECORDS.toLocaleString()} records. This will include the most recent vulnerabilities.\n\nProceed with ${MAX_RECORDS.toLocaleString()} records?`)) {
                    return;
                }
                data = data.slice(0, MAX_RECORDS);
                console.log(`Truncated to ${MAX_RECORDS.toLocaleString()} records for processing`);
            }

            // SAFEGUARD 2: Check available storage space
            function checkStorageQuota() {
                try {
                    // Estimate storage needed (rough calculation: ~500 bytes per record after optimization)
                    const estimatedSize = data.length * 500;
                    const currentUsage = JSON.stringify(localStorage).length;
                    const availableSpace = 5 * 1024 * 1024 - currentUsage; // 5MB typical localStorage limit
                    
                    if (estimatedSize > availableSpace) {
                        console.warn(`Estimated storage needed: ${(estimatedSize/1024/1024).toFixed(1)}MB, Available: ${(availableSpace/1024/1024).toFixed(1)}MB`);
                        return false;
                    }
                    return true;
                } catch (e) {
                    console.warn('Could not check storage quota:', e);
                    return true; // Proceed anyway
                }
            }

            if (!checkStorageQuota()) {
                alert('Warning: This file may exceed browser storage limits. Consider using a smaller dataset or clearing existing data first.');
            }
            
            // Show progress modal
            const progressModal = document.createElement('div');
            progressModal.innerHTML = `
                <div class="modal fade" id="progressModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Processing Large CSV File</h5>
                            </div>
                            <div class="modal-body">
                                <p>Processing ${data.length.toLocaleString()} vulnerability records...</p>
                                <div class="progress mb-3">
                                    <div class="progress-bar" role="progressbar" style="width: 0%" id="progressBar"></div>
                                </div>
                                <p class="text-muted small">This may take a few moments for large files.</p>
                                <div id="progressStatus">Initializing...</div>
                                <div id="memoryStatus" class="text-muted small mt-2"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(progressModal);
            const modal = new bootstrap.Modal(document.getElementById('progressModal'));
            modal.show();

            // Extract date from filename or use current date
            let fileDate = new Date();
            const dateMatch = file.name.match(/(\d{4}[-_]\d{2}[-_]\d{2})/);
            if (dateMatch) {
                fileDate = new Date(dateMatch[1].replace(/_/g, '-'));
            }

            const batchSize = 1000; // Process 1000 rows at a time
            let currentBatch = 0;
            const totalBatches = Math.ceil(data.length / batchSize);
            let allProcessedData = [];

            function processBatch() {
                const startIndex = currentBatch * batchSize;
                const endIndex = Math.min(startIndex + batchSize, data.length);
                const batchData = data.slice(startIndex, endIndex);

                // Update progress
                const progress = Math.round((currentBatch / totalBatches) * 100);
                document.getElementById('progressBar').style.width = progress + '%';
                document.getElementById('progressStatus').textContent = `Processing batch ${currentBatch + 1} of ${totalBatches} (rows ${startIndex + 1}-${endIndex})`;

                // SAFEGUARD 4: Memory monitoring
                if (performance && performance.memory) {
                    const memUsed = (performance.memory.usedJSHeapSize / 1024 / 1024).toFixed(1);
                    const memLimit = (performance.memory.jsHeapSizeLimit / 1024 / 1024).toFixed(1);
                    document.getElementById('memoryStatus').textContent = `Memory: ${memUsed}MB / ${memLimit}MB`;
                    
                    // Warning if memory usage is getting high
                    if (performance.memory.usedJSHeapSize / performance.memory.jsHeapSizeLimit > 0.8) {
                        console.warn('High memory usage detected:', memUsed + 'MB');
                    }
                }

                // Process this batch
                const processedBatch = batchData.map((row, index) => {
                    const mappedRow = {};
                    
                    // Essential fields only - filter out verbose descriptions and unnecessary data
                    mappedRow.hostname = row['asset.name'] || row.hostname || row.asset_name || row.host || row.target || '';
                    mappedRow.ipAddress = row['asset.display_ipv4_address'] || row.ip || row.ip_address || row.target_ip || row.asset_ip || '';
                    mappedRow.vendor = row['definition.family'] || row.vendor || row.family || row.plugin_family || row.scanner || 'Unknown';
                    mappedRow.definitionId = row['definition.id'] || row.plugin_id || row.vuln_id || row.id || '';
                    mappedRow.cve = row['definition.cve'] || row.cve || row.cve_id || '';
                    
                    // Keep vulnerability name short - truncate if too long
                    let vulnName = row['definition.name'] || row.title || row.name || row.plugin_name || '';
                    if (vulnName.length > 100) {
                        vulnName = vulnName.substring(0, 97) + '...';
                    }
                    mappedRow.definitionName = vulnName;
                    
                    // Severity mapping
                    let severity = row.severity || row['severity'] || row.risk || row.threat_level || 'Unknown';
                    severity = severity.toString().toLowerCase();
                    
                    if (severity.includes('critical') || severity.includes('4')) severity = 'critical';
                    else if (severity.includes('high') || severity.includes('3')) severity = 'high';
                    else if (severity.includes('medium') || severity.includes('2') || severity.includes('med')) severity = 'medium';
                    else if (severity.includes('low') || severity.includes('1')) severity = 'low';
                    else if (severity.includes('info') || severity.includes('0')) severity = 'info';
                    
                    mappedRow.severity = severity;
                    
                    // VPR Score - essential for prioritization
                    let vprScore = row['definition.vpr.score'] || row.vpr_score || row.vpr || row.cvss_score || row.cvss || 0;
                    mappedRow.vprScore = parseFloat(vprScore) || 0;
                    
                    // State and date - keep minimal
                    mappedRow.state = row.state || row.status || 'ACTIVE';
                    mappedRow.date = fileDate.toLocaleDateString();
                    
                    // Create unique ID for deduplication
                    mappedRow.vulnId = `${mappedRow.hostname}-${mappedRow.definitionId}-${Date.now()}-${startIndex + index}`;
                    
                    // Skip any verbose description fields, age fields, or other non-essential data
                    // These can be fetched via API when needed for detailed views
                    
                    return mappedRow;
                }).filter(row => row.hostname && row.hostname.trim() !== '');

                allProcessedData = allProcessedData.concat(processedBatch);
                currentBatch++;

                if (currentBatch < totalBatches) {
                    // Process next batch after a small delay to keep UI responsive
                    setTimeout(processBatch, 10);
                } else {
                    // All batches processed
                    finalizeBatchProcessing();
                }
            }

            function finalizeBatchProcessing() {
                document.getElementById('progressStatus').textContent = 'Finalizing data...';
                document.getElementById('progressBar').style.width = '100%';

                console.log(`Processed ${allProcessedData.length} records from ${data.length} rows`);

                try {
                    // Use Map for efficient deduplication
                    const uniqueData = new Map();
                    
                    // Add existing data first
                    vulnData.forEach(item => {
                        const key = `${item.hostname}-${item.definitionId}`;
                        uniqueData.set(key, item);
                    });
                    
                    // Add new data, replacing older entries
                    allProcessedData.forEach(item => {
                        const key = `${item.hostname}-${item.definitionId}`;
                        const existing = uniqueData.get(key);
                        
                        if (!existing || new Date(existing.date) < new Date(item.date)) {
                            uniqueData.set(key, item);
                        }
                    });

                    vulnData = Array.from(uniqueData.values());
                    console.log(`Final dataset: ${vulnData.length} unique vulnerabilities`);

                    // Calculate statistics and update displays
                    const stats = calculateStatistics(vulnData, fileDate);
                    updateStatCards(stats);
                    filterAndDisplayData(); // Use filterAndDisplayData instead of updateCardViews
                    updateLastUploadInfo(file.name, fileDate, allProcessedData.length);
                    
                    // SAFEGUARD 3: Try to save to localStorage with quota error handling
                    document.getElementById('progressStatus').textContent = 'Saving data...';
                    try {
                        localStorage.setItem('hextrackr_vuln_data', JSON.stringify(vulnData));
                        console.log('Data saved successfully to localStorage');
                    } catch (storageError) {
                        console.error('Storage quota exceeded:', storageError);
                        
                        // Try to free up space by removing old data
                        try {
                            localStorage.removeItem('hextrackr_vuln_history');
                            localStorage.setItem('hextrackr_vuln_data', JSON.stringify(vulnData));
                            console.log('Saved after clearing history data');
                        } catch (secondError) {
                            console.error('Still unable to save:', secondError);
                            
                            // Last resort: Save only the most critical/recent data
                            try {
                                const reducedData = vulnData
                                    .filter(item => item.severity === 'Critical' || item.severity === 'High')
                                    .slice(0, 50000); // Limit to 50K most critical vulnerabilities
                                
                                localStorage.setItem('hextrackr_vuln_data', JSON.stringify(reducedData));
                                
                                alert(`Storage quota exceeded! Saved only ${reducedData.length} Critical/High severity vulnerabilities out of ${vulnData.length} total records. Consider exporting data or using a smaller dataset.`);
                                vulnData = reducedData; // Update in-memory data to match saved data
                            } catch (finalError) {
                                console.error('Unable to save any data:', finalError);
                                alert('Storage quota exceeded and unable to save data. Please clear browser storage or use a smaller dataset.');
                                throw finalError;
                            }
                        }
                    }
                    
                    // Save to history (skip if storage issues)
                    try {
                        saveToHistory(file.name, fileDate, stats);
                    } catch (historyError) {
                        console.warn('Could not save to history:', historyError);
                    }
                    
                    // Show trend chart section
                    if (vulnData.length > 0) {
                        document.getElementById('uploadArea').style.display = 'none';
                        document.getElementById('trendChartSection').style.display = 'block';
                        setTimeout(updateTrendChart, 100);
                    }

                    // Close progress modal
                    modal.hide();
                    setTimeout(() => {
                        try {
                            document.body.removeChild(progressModal);
                        } catch (e) {
                            console.log('Modal already removed');
                        }
                    }, 300);
                    
                    alert(`Successfully processed ${allProcessedData.length} vulnerability records!\nFinal dataset: ${vulnData.length} unique vulnerabilities`);
                    
                } catch (error) {
                    console.error('Error during finalization:', error);
                    modal.hide();
                    setTimeout(() => {
                        try {
                            document.body.removeChild(progressModal);
                        } catch (e) {
                            console.log('Modal already removed');
                        }
                    }, 300);
                    
                    // More specific error messages
                    if (error.message.includes('quota') || error.name === 'QuotaExceededError') {
                        alert(`Storage quota exceeded! The dataset is too large for browser storage. Try:\n1. Using a smaller CSV file\n2. Clearing existing data first\n3. Processing only Critical/High severity vulnerabilities`);
                    } else {
                        alert(`Processing completed but with errors: ${error.message}`);
                    }
                }
            }

            // Start processing
            setTimeout(processBatch, 100);
        }

        function calculateStatistics(data, date) {
            // Handle undefined or null data
            if (!data || !Array.isArray(data)) {
                console.warn('calculateStatistics called with invalid data:', data);
                return {
                    severityVPR: { critical: 0, high: 0, medium: 0, low: 0, info: 0 },
                    vendor: {},
                    total: 0,
                    date: date || new Date()
                };
            }

            const stats = {
                severityVPR: { critical: 0, high: 0, medium: 0, low: 0, info: 0 },
                vendor: {},
                total: data.length,
                date: date
            };

            data.forEach(item => {
                // Sum VPR scores by severity
                if (item.severity && stats.severityVPR.hasOwnProperty(item.severity)) {
                    stats.severityVPR[item.severity] += item.vprScore || 0;
                }
                
                // Count by vendor
                const vendor = item.vendor || 'Unknown';
                stats.vendor[vendor] = (stats.vendor[vendor] || 0) + 1;
            });

            return stats;
        }

        function updateStatCards(stats) {
            // Update severity cards with VPR sums (rounded to 1 decimal)
            document.getElementById('criticalValue').textContent = stats.severityVPR.critical.toFixed(1);
            document.getElementById('highValue').textContent = stats.severityVPR.high.toFixed(1);
            document.getElementById('mediumValue').textContent = stats.severityVPR.medium.toFixed(1);
            document.getElementById('lowValue').textContent = stats.severityVPR.low.toFixed(1);
            
            // Create sparklines if we have historical data
            if (historyData.length > 1) {
                const criticalTrend = historyData.slice(-7).map(h => h.stats.severityVPR ? h.stats.severityVPR.critical : 0);
                const highTrend = historyData.slice(-7).map(h => h.stats.severityVPR ? h.stats.severityVPR.high : 0);
                const mediumTrend = historyData.slice(-7).map(h => h.stats.severityVPR ? h.stats.severityVPR.medium : 0);
                const lowTrend = historyData.slice(-7).map(h => h.stats.severityVPR ? h.stats.severityVPR.low : 0);
                
                // Clear existing sparklines
                ['#criticalSparkline', '#highSparkline', '#mediumSparkline', '#lowSparkline'].forEach(id => {
                    const container = document.querySelector(id);
                    if (container) container.innerHTML = '';
                });
                
                // Create new sparklines
                createSeveritySparkline('#criticalSparkline', criticalTrend, '#ff6b6b', 'Critical');
                createSeveritySparkline('#highSparkline', highTrend, '#ffa726', 'High');
                createSeveritySparkline('#mediumSparkline', mediumTrend, '#42a5f5', 'Medium');
                createSeveritySparkline('#lowSparkline', lowTrend, '#66bb6a', 'Low');
            }
        }

        // Pagination functions
        function createPagination(containerId, currentPage, totalItems, itemsPerPage, onPageChange) {
            const container = document.getElementById(containerId);
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            
            if (totalPages <= 1) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = '';
            const pagination = container.querySelector('.pagination');
            pagination.innerHTML = '';
            
            // Previous button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = '<a class="page-link" href="#" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a>';
            if (currentPage > 1) {
                prevLi.querySelector('a').onclick = (e) => { e.preventDefault(); onPageChange(currentPage - 1); };
            }
            pagination.appendChild(prevLi);
            
            // Page numbers
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);
            
            if (startPage > 1) {
                const firstLi = document.createElement('li');
                firstLi.className = 'page-item';
                firstLi.innerHTML = '<a class="page-link" href="#">1</a>';
                firstLi.querySelector('a').onclick = (e) => { e.preventDefault(); onPageChange(1); };
                pagination.appendChild(firstLi);
                
                if (startPage > 2) {
                    const ellipsisLi = document.createElement('li');
                    ellipsisLi.className = 'page-item disabled';
                    ellipsisLi.innerHTML = '<span class="page-link">...</span>';
                    pagination.appendChild(ellipsisLi);
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                if (i !== currentPage) {
                    li.querySelector('a').onclick = (e) => { e.preventDefault(); onPageChange(i); };
                }
                pagination.appendChild(li);
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsisLi = document.createElement('li');
                    ellipsisLi.className = 'page-item disabled';
                    ellipsisLi.innerHTML = '<span class="page-link">...</span>';
                    pagination.appendChild(ellipsisLi);
                }
                
                const lastLi = document.createElement('li');
                lastLi.className = 'page-item';
                lastLi.innerHTML = `<a class="page-link" href="#">${totalPages}</a>`;
                lastLi.querySelector('a').onclick = (e) => { e.preventDefault(); onPageChange(totalPages); };
                pagination.appendChild(lastLi);
            }
            
            // Next button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = '<a class="page-link" href="#" aria-label="Next"><span aria-hidden="true">&raquo;</span></a>';
            if (currentPage < totalPages) {
                nextLi.querySelector('a').onclick = (e) => { e.preventDefault(); onPageChange(currentPage + 1); };
            }
            pagination.appendChild(nextLi);
        }
        
        function goToAssetPage(page) {
            currentAssetPage = page;
            updateAssetCards();
        }
        
        function goToVulnPage(page) {
            currentVulnPage = page;
            updateVulnCards();
        }

        function updateCardViews() {
            const currentView = document.querySelector('input[name="viewMode"]:checked').value;
            
            // Hide all containers first
            document.getElementById('assetCardsContainer').style.display = 'none';
            document.getElementById('vulnCardsContainer').style.display = 'none';
            document.getElementById('tableContainer').style.display = 'none';
            document.getElementById('assetPaginationContainer').style.display = 'none';
            document.getElementById('vulnPaginationContainer').style.display = 'none';
            document.getElementById('tablePaginationContainer').style.display = 'none';
            
            if (currentView === 'asset') {
                updateAssetCards();
                document.getElementById('assetCardsContainer').style.display = '';
                document.getElementById('assetPaginationContainer').style.display = '';
            } else if (currentView === 'vuln') {
                updateVulnCards();
                document.getElementById('vulnCardsContainer').style.display = '';
                document.getElementById('vulnPaginationContainer').style.display = '';
            } else if (currentView === 'table') {
                updateTableView();
                document.getElementById('tableContainer').style.display = '';
                document.getElementById('tablePaginationContainer').style.display = '';
            }
        }

        function filterAndDisplayData() {
            searchTerm = document.getElementById('searchInput').value.toLowerCase();
            severityFilter = document.getElementById('severityFilter').value;
            
            // Apply filters to vulnData
            filteredData = vulnData.filter(item => {
                const matchesSearch = !searchTerm || 
                    (item.hostname && item.hostname.toLowerCase().includes(searchTerm)) ||
                    (item.cve && item.cve.toLowerCase().includes(searchTerm)) ||
                    (item.definitionName && item.definitionName.toLowerCase().includes(searchTerm)) ||
                    (item.ipAddress && item.ipAddress.toLowerCase().includes(searchTerm)) ||
                    (item.vendor && item.vendor.toLowerCase().includes(searchTerm));
                
                const matchesSeverity = !severityFilter || (item.severity && item.severity.toLowerCase() === severityFilter);
                
                return matchesSearch && matchesSeverity;
            });
            
            // Update the current view
            updateCardViews();
        }

        function updateAssetCards() {
            const container = document.getElementById('assetCardsContainer');
            
            if (vulnData.length === 0) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="card asset-card text-center py-5">
                            <div class="card-body">
                                <i class="fas fa-server fa-3x text-muted mb-3"></i>
                                <h4>No vulnerability data available</h4>
                                <p class="text-muted">Upload a CSV file to get started.</p>
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('assetPaginationContainer').style.display = 'none';
                return;
            }

            // Use filtered data if search/filter is active, otherwise use all data
            const dataToShow = searchTerm || severityFilter ? filteredData : vulnData;

            if (dataToShow.length === 0) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-info">
                            <i class="fas fa-search me-2"></i>No assets match your search criteria.
                        </div>
                    </div>
                `;
                document.getElementById('assetPaginationContainer').style.display = 'none';
                return;
            }

            // Group data by asset
            const assetGroups = {};
            dataToShow.forEach(item => {
                if (!assetGroups[item.hostname]) {
                    assetGroups[item.hostname] = {
                        hostname: item.hostname,
                        ipAddress: item.ipAddress,
                        vendor: item.vendor,
                        severityCounts: { critical: 0, high: 0, medium: 0, low: 0, info: 0 },
                        vulnerabilities: []
                    };
                }
                
                assetGroups[item.hostname].severityCounts[item.severity]++;
                assetGroups[item.hostname].vulnerabilities.push(item);
            });

            const sortBy = document.getElementById('sortBy').value;
            const sortedAssets = Object.values(assetGroups).sort((a, b) => {
                if (sortBy === 'hostname') return a.hostname.localeCompare(b.hostname);
                if (sortBy === 'total') return (b.vulnerabilities.length) - (a.vulnerabilities.length);
                return b.severityCounts[sortBy] - a.severityCounts[sortBy];
            });

            // Store current data for pagination
            currentAssetData = sortedAssets;
            
            // Calculate pagination
            const totalItems = sortedAssets.length;
            const startIndex = (currentAssetPage - 1) * assetItemsPerPage;
            const endIndex = startIndex + assetItemsPerPage;
            const paginatedAssets = sortedAssets.slice(startIndex, endIndex);

            container.innerHTML = paginatedAssets.map(asset => createAssetCard(asset)).join('');
            
            // Create pagination controls
            createPagination('assetPaginationContainer', currentAssetPage, totalItems, assetItemsPerPage, goToAssetPage);
        }

        function updateVulnCards() {
            const container = document.getElementById('vulnCardsContainer');
            
            if (vulnData.length === 0) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="card vuln-card text-center py-5">
                            <div class="card-body">
                                <i class="fas fa-bug fa-3x text-muted mb-3"></i>
                                <h4>No vulnerability data available</h4>
                                <p class="text-muted">Upload a CSV file to get started.</p>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            // Use filtered data if search/filter is active, otherwise use all data
            const dataToShow = searchTerm || severityFilter ? filteredData : vulnData;

            if (dataToShow.length === 0) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-info">
                            <i class="fas fa-search me-2"></i>No vulnerabilities match your search criteria.
                        </div>
                    </div>
                `;
                return;
            }

            // Group vulnerabilities by CVE/Definition ID
            const vulnGroups = {};
            dataToShow.forEach(item => {
                // Use CVE as primary key, fallback to definition ID
                const key = item.cve || item.definitionId || item.definitionName;
                if (!vulnGroups[key]) {
                    vulnGroups[key] = {
                        cve: item.cve,
                        definitionId: item.definitionId,
                        definitionName: item.definitionName,
                        severity: item.severity,
                        vprScore: item.vprScore,
                        vendor: item.vendor,
                        affectedAssets: [],
                        count: 0
                    };
                }
                
                vulnGroups[key].affectedAssets.push({
                    hostname: item.hostname,
                    ipAddress: item.ipAddress,
                    state: item.state,
                    date: item.date
                });
                vulnGroups[key].count++;
                
                // Use highest VPR score if multiple instances
                if (item.vprScore > vulnGroups[key].vprScore) {
                    vulnGroups[key].vprScore = item.vprScore;
                }
            });

            const sortBy = document.getElementById('sortBy').value;
            let sortedVulns = Object.values(vulnGroups);
            
            if (sortBy === 'hostname') {
                sortedVulns.sort((a, b) => a.affectedAssets[0].hostname.localeCompare(b.affectedAssets[0].hostname));
            } else if (sortBy === 'critical' || sortBy === 'high' || sortBy === 'medium' || sortBy === 'low') {
                sortedVulns.sort((a, b) => {
                    if (a.severity === sortBy && b.severity !== sortBy) return -1;
                    if (a.severity !== sortBy && b.severity === sortBy) return 1;
                    return b.vprScore - a.vprScore;
                });
            } else {
                sortedVulns.sort((a, b) => b.vprScore - a.vprScore);
            }

            // Store current data for pagination
            currentVulnGroupData = sortedVulns;
            
            // Calculate pagination
            const totalItems = sortedVulns.length;
            const startIndex = (currentVulnPage - 1) * vulnItemsPerPage;
            const endIndex = startIndex + vulnItemsPerPage;
            const paginatedVulns = sortedVulns.slice(startIndex, endIndex);

            container.innerHTML = paginatedVulns.map(vuln => createVulnCard(vuln)).join('');
            
            // Create pagination controls
            createPagination('vulnPaginationContainer', currentVulnPage, totalItems, vulnItemsPerPage, goToVulnPage);
        }

        function createAssetCard(asset) {
            const totalVulns = asset.vulnerabilities.length;
            const criticalCount = asset.severityCounts.critical;
            const highCount = asset.severityCounts.high;
            const mediumCount = asset.severityCounts.medium;
            const lowCount = asset.severityCounts.low;
            
            return `
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card asset-card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0" onclick="showAssetDetails('${asset.hostname}')" style="cursor: pointer;">
                                <i class="fas fa-server me-2"></i>${asset.hostname}
                            </h6>
                            <div class="card-actions">
                                <button class="btn btn-sm btn-outline-primary me-1" onclick="editAsset('${asset.hostname}')" title="Edit Asset">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteAsset('${asset.hostname}')" title="Delete Asset">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body" onclick="showAssetDetails('${asset.hostname}')" style="cursor: pointer;">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span class="vendor-badge">${asset.vendor}</span>
                                <p class="text-muted small mb-0">
                                    <i class="fas fa-network-wired me-1"></i>${asset.ipAddress || 'N/A'}
                                </p>
                            </div>
                            
                            <div class="row text-center">
                                <div class="col-3">
                                    <div class="severity-critical">
                                        <span class="severity-indicator"></span>
                                        <strong>${criticalCount}</strong>
                                    </div>
                                    <small class="text-muted">Critical</small>
                                </div>
                                <div class="col-3">
                                    <div class="severity-high">
                                        <span class="severity-indicator"></span>
                                        <strong>${highCount}</strong>
                                    </div>
                                    <small class="text-muted">High</small>
                                </div>
                                <div class="col-3">
                                    <div class="severity-medium">
                                        <span class="severity-indicator"></span>
                                        <strong>${mediumCount}</strong>
                                    </div>
                                    <small class="text-muted">Medium</small>
                                </div>
                                <div class="col-3">
                                    <div class="severity-low">
                                        <span class="severity-indicator"></span>
                                        <strong>${lowCount}</strong>
                                    </div>
                                    <small class="text-muted">Low</small>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer text-center">
                            <small class="text-muted">Total: ${totalVulns} vulnerabilities</small>
                        </div>
                    </div>
                </div>
            `;
        }

        function createVulnCard(vuln) {
            const severityColor = {
                critical: '#ff6b6b',
                high: '#ffa726', 
                medium: '#42a5f5',
                low: '#66bb6a',
                info: '#9e9e9e'
            };

            // Show first few affected assets
            const maxAssetsToShow = 3;
            const assetList = vuln.affectedAssets.slice(0, maxAssetsToShow)
                .map(asset => asset.hostname).join(', ');
            const remainingAssets = vuln.affectedAssets.length - maxAssetsToShow;

            return `
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card vuln-card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <small class="text-muted">${vuln.cve || vuln.definitionId}</small>
                            <div class="d-flex align-items-center">
                                <span class="badge me-2" style="background-color: ${severityColor[vuln.severity]}; color: white;">
                                    ${vuln.severity.toUpperCase()}
                                </span>
                                <div class="card-actions">
                                    <button class="btn btn-sm btn-outline-primary me-1" onclick="editVulnerability('${vuln.definitionId}')" title="Edit Vulnerability">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteVulnerability('${vuln.definitionId}')" title="Delete Vulnerability">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body" onclick="showVulnDetails('${vuln.definitionId}', '${vuln.definitionName}')" style="cursor: pointer;">
                            <h6 class="card-title">${vuln.definitionName.substring(0, 60)}${vuln.definitionName.length > 60 ? '...' : ''}</h6>
                            
                            <p class="card-text">
                                <strong>VPR Score:</strong> ${vuln.vprScore}<br>
                                <strong>Vendor:</strong> ${vuln.vendor}<br>
                                <strong>Affected Assets:</strong> ${vuln.count}
                            </p>
                            
                            <div class="small text-muted mt-2">
                                <strong>Assets:</strong> ${assetList}${remainingAssets > 0 ? ` +${remainingAssets} more` : ''}
                            </div>
                        </div>
                        <div class="card-footer">
                            <small class="text-muted">Total instances: ${vuln.count}</small>
                        </div>
                    </div>
                </div>
            `;
        }

        function updateTableView() {
            const tableBody = document.getElementById('tableBody');
            
            if (vulnData.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-5">
                            <i class="fas fa-bug fa-3x text-muted mb-3"></i>
                            <h5>No vulnerability data available</h5>
                            <p class="text-muted">Upload a CSV file to get started.</p>
                        </td>
                    </tr>
                `;
                return;
            }

            // Use filtered data if search/filter is active, otherwise use all data
            const dataToShow = searchTerm || severityFilter ? filteredData : vulnData;
            
            // Sort data
            const sortBy = document.getElementById('sortBy').value;
            let sortedData = [...dataToShow];
            
            if (sortBy === 'hostname') {
                sortedData.sort((a, b) => (a.hostname || '').localeCompare(b.hostname || ''));
            } else if (sortBy === 'critical' || sortBy === 'high' || sortBy === 'medium' || sortBy === 'low') {
                sortedData.sort((a, b) => {
                    if (a.severity === sortBy && b.severity !== sortBy) return -1;
                    if (a.severity !== sortBy && b.severity === sortBy) return 1;
                    return (b.vprScore || 0) - (a.vprScore || 0);
                });
            } else {
                sortedData.sort((a, b) => (b.vprScore || 0) - (a.vprScore || 0));
            }

            // Pagination for table
            const totalItems = sortedData.length;
            const startIndex = (currentTablePage - 1) * tableItemsPerPage;
            const endIndex = startIndex + tableItemsPerPage;
            const paginatedData = sortedData.slice(startIndex, endIndex);

            // Create table rows
            tableBody.innerHTML = paginatedData.map(item => createTableRow(item)).join('');
            
            // Update pagination
            createPagination('tablePaginationContainer', currentTablePage, totalItems, tableItemsPerPage, goToTablePage);
        }

        function createTableRow(item) {
            const severityColors = {
                critical: '#dc3545',
                high: '#fd7e14', 
                medium: '#0d6efd',
                low: '#198754',
                info: '#6c757d'
            };

            const severityColor = severityColors[item.severity?.toLowerCase()] || '#6c757d';

            return `
                <tr>
                    <td>
                        <div class="d-flex align-items-center">
                            <i class="fas fa-server text-muted me-2"></i>
                            <span>${item.hostname || 'N/A'}</span>
                        </div>
                    </td>
                    <td>
                        <small class="text-muted">${item.ipAddress || 'N/A'}</small>
                    </td>
                    <td>
                        <code class="small">${item.cve || 'N/A'}</code>
                    </td>
                    <td>
                        <div class="text-truncate" style="max-width: 200px;" title="${item.definitionName || 'N/A'}">
                            ${(item.definitionName || 'N/A').substring(0, 50)}${(item.definitionName || '').length > 50 ? '...' : ''}
                        </div>
                    </td>
                    <td>
                        <span class="badge" style="background-color: ${severityColor}; color: white;">
                            ${(item.severity || 'Unknown').toUpperCase()}
                        </span>
                    </td>
                    <td>
                        <strong>${item.vprScore || 'N/A'}</strong>
                    </td>
                    <td>
                        <small class="text-muted">${item.vendor || 'Unknown'}</small>
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-outline-primary btn-sm" onclick="editVulnerability('${item.definitionId}')" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-info btn-sm" onclick="showVulnDetails('${item.definitionId}', '${item.definitionName}')" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="deleteVulnerability('${item.definitionId}')" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }

        function goToTablePage(page) {
            currentTablePage = page;
            updateTableView();
        }

        // Create small sparkline charts for severity indicators
        function createSeveritySparkline(containerId, data, color, title) {
            const options = {
                series: [{
                    data: data
                }],
                chart: {
                    type: 'line',
                    width: 60,
                    height: 30,
                    sparkline: {
                        enabled: true
                    }
                },
                stroke: {
                    curve: 'smooth',
                    width: 2
                },
                colors: [color],
                tooltip: {
                    fixed: {
                        enabled: false
                    },
                    x: {
                        show: false
                    },
                    y: {
                        title: {
                            formatter: function() {
                                return title + ': ';
                            }
                        }
                    },
                    marker: {
                        show: false
                    }
                }
            };

            const chart = new ApexCharts(document.querySelector(containerId), options);
            chart.render();
            return chart;
        }

        function showAssetDetails(hostname) {
            const asset = vulnData.filter(v => v.hostname === hostname);
            if (asset.length === 0) return;

            const assetInfo = asset[0];
            const vulnerabilities = asset;

            const modalBody = document.getElementById('assetModalBody');
            modalBody.innerHTML = `
                <div class="row mb-3">
                    <div class="col-md-6">
                        <h6>Asset Information</h6>
                        <p><strong>Hostname:</strong> ${assetInfo.hostname}</p>
                        <p><strong>IP Address:</strong> ${assetInfo.ipAddress || 'N/A'}</p>
                        <p><strong>Vendor:</strong> ${assetInfo.vendor}</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Vulnerability Summary</h6>
                        <p><strong>Total Vulnerabilities:</strong> ${vulnerabilities.length}</p>
                        <p><strong>Critical:</strong> ${vulnerabilities.filter(v => v.severity === 'critical').length}</p>
                        <p><strong>High:</strong> ${vulnerabilities.filter(v => v.severity === 'high').length}</p>
                        <p><strong>Medium:</strong> ${vulnerabilities.filter(v => v.severity === 'medium').length}</p>
                        <p><strong>Low:</strong> ${vulnerabilities.filter(v => v.severity === 'low').length}</p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <h6>Vulnerabilities</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>CVE</th>
                                        <th>Name</th>
                                        <th>Severity</th>
                                        <th>VPR Score</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${vulnerabilities.map(v => `
                                        <tr>
                                            <td>${v.cve || v.definitionId}</td>
                                            <td>${v.definitionName.substring(0, 50)}${v.definitionName.length > 50 ? '...' : ''}</td>
                                            <td><span class="badge bg-${v.severity === 'critical' ? 'danger' : v.severity === 'high' ? 'warning' : v.severity === 'medium' ? 'info' : 'success'}">${v.severity.toUpperCase()}</span></td>
                                            <td>${v.vprScore}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;

            const modal = new bootstrap.Modal(document.getElementById('assetModal'));
            modal.show();
        }

        function showVulnDetails(definitionId, definitionName) {
            // Find all instances of this vulnerability across assets
            const vulnInstances = vulnData.filter(v => 
                v.definitionId === definitionId || v.definitionName === definitionName
            );
            
            if (vulnInstances.length === 0) return;

            const vuln = vulnInstances[0]; // Use first instance for main details
            
            const modalBody = document.getElementById('vulnModalBody');
            modalBody.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Vulnerability Information</h6>
                        <p><strong>CVE:</strong> ${vuln.cve || 'N/A'}</p>
                        <p><strong>Definition ID:</strong> ${vuln.definitionId}</p>
                        <p><strong>Name:</strong> ${vuln.definitionName}</p>
                        <p><strong>Severity:</strong> <span class="badge bg-${vuln.severity === 'critical' ? 'danger' : vuln.severity === 'high' ? 'warning' : vuln.severity === 'medium' ? 'info' : 'success'}">${vuln.severity.toUpperCase()}</span></p>
                        <p><strong>VPR Score:</strong> ${vuln.vprScore}</p>
                        <p><strong>Vendor:</strong> ${vuln.vendor}</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Affected Assets (${vulnInstances.length})</h6>
                        <div class="table-responsive" style="max-height: 300px;">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Hostname</th>
                                        <th>IP Address</th>
                                        <th>State</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${vulnInstances.map(instance => `
                                        <tr>
                                            <td>${instance.hostname}</td>
                                            <td>${instance.ipAddress || 'N/A'}</td>
                                            <td><span class="badge bg-${instance.state === 'ACTIVE' ? 'warning' : 'success'}">${instance.state}</span></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;

            const modal = new bootstrap.Modal(document.getElementById('vulnModal'));
            modal.show();
        }

        function updateLastUploadInfo(filename, date, count) {
            const info = document.getElementById('lastUploadInfo');
            info.innerHTML = `
                <strong>File:</strong> ${filename} | 
                <strong>Date:</strong> ${date.toLocaleDateString()} | 
                <strong>Records:</strong> ${count}
            `;
        }

        function saveToHistory(filename, date, stats) {
            const historyEntry = {
                date: date.toISOString(),
                filename: filename,
                stats: stats
            };
            
            historyData.push(historyEntry);
            
            // Keep only last 30 entries
            if (historyData.length > 30) {
                historyData = historyData.slice(-30);
            }
            
            localStorage.setItem('vulnHistory', JSON.stringify(historyData));
        }

        function initializeSortable() {
            // Initialize sortable for both containers
            if (typeof Sortable !== 'undefined') {
                new Sortable(document.getElementById('assetCardsContainer'), {
                    animation: 150,
                    ghostClass: 'sortable-ghost'
                });
                
                new Sortable(document.getElementById('vulnCardsContainer'), {
                    animation: 150,
                    ghostClass: 'sortable-ghost'
                });
            }
        }

        function loadExistingData() {
            const savedData = localStorage.getItem('hextrackr_vuln_data');
            const savedHistory = localStorage.getItem('vulnHistory');
            
            if (savedHistory) {
                try {
                    historyData = JSON.parse(savedHistory);
                } catch (error) {
                    console.error('Error loading history data:', error);
                    historyData = [];
                }
            }
            
            if (savedData) {
                try {
                    vulnData = JSON.parse(savedData);
                    if (vulnData.length > 0) {
                        const stats = calculateStatistics(vulnData);
                        updateStatCards(stats);
                        updateCardViews();
                        
                        // Show trend chart instead of upload area if data exists
                        document.getElementById('uploadArea').style.display = 'none';
                        document.getElementById('trendChartSection').style.display = 'block';
                        // Update trend chart after a short delay to ensure DOM is ready
                        setTimeout(updateTrendChart, 100);
                    }
                } catch (error) {
                    console.error('Error loading saved data:', error);
                    vulnData = []; // Reset to empty array on error
                }
            }
        }

        function loadSampleData() {
            // Sample data to demonstrate the interface
            const sampleData = [
                {
                    hostname: 'web-server-01',
                    ipAddress: '192.168.1.10',
                    vendor: 'Apache',
                    definitionId: 'CVE-2023-0001',
                    cve: 'CVE-2023-0001',
                    definitionName: 'Apache HTTP Server Buffer Overflow',
                    severity: 'critical',
                    vprScore: 9.8,
                    state: 'ACTIVE',
                    date: new Date().toLocaleDateString()
                },
                {
                    hostname: 'db-server-01',
                    ipAddress: '192.168.1.20',
                    vendor: 'MySQL',
                    definitionId: 'CVE-2023-0002',
                    cve: 'CVE-2023-0002',
                    definitionName: 'MySQL SQL Injection Vulnerability',
                    severity: 'high',
                    vprScore: 8.5,
                    state: 'ACTIVE',
                    date: new Date().toLocaleDateString()
                }
            ];

            vulnData = sampleData;
            const stats = calculateStatistics(vulnData);
            updateStatCards(stats);
            updateCardViews();
            
            // Add sample history for sparklines
            for (let i = 6; i >= 1; i--) {
                const pastDate = new Date();
                pastDate.setDate(pastDate.getDate() - i);
                
                historyData.push({
                    date: pastDate.toISOString(),
                    filename: `sample_data_${i}.csv`,
                    stats: {
                        severityVPR: {
                            critical: Math.max(0, 9.8 + (Math.random() - 0.5) * 3),
                            high: Math.max(0, 8.5 + (Math.random() - 0.5) * 2),
                            medium: Math.max(0, 5.2 + (Math.random() - 0.5) * 2),
                            low: Math.max(0, 2.1 + (Math.random() - 0.5) * 1)
                        }
                    }
                });
            }
            
            localStorage.setItem('vulnHistory', JSON.stringify(historyData));
            localStorage.setItem('hextrackr_vuln_data', JSON.stringify(vulnData));
        }

        function clearVulnData() {
            if (confirm('Are you sure you want to clear all vulnerability data?')) {
                vulnData = [];
                historyData = [];
                localStorage.removeItem('vulnHistory');
                localStorage.removeItem('hextrackr_vuln_data');
                
                // Clear displays
                updateStatCards({
                    severityVPR: { critical: 0, high: 0, medium: 0, low: 0 },
                    vendor: {},
                    total: 0
                });
                
                // Clear card containers
                document.getElementById('assetCardsContainer').innerHTML = '<div class="col-12"><div class="alert alert-info">No vulnerability data available</div></div>';
                document.getElementById('vulnCardsContainer').innerHTML = '<div class="col-12"><div class="alert alert-info">No vulnerability data available</div></div>';
                
                // Clear upload info
                const uploadInfo = document.getElementById('lastUploadInfo');
                if (uploadInfo) {
                    uploadInfo.innerHTML = '<span class="text-muted">No data uploaded</span>';
                }
                
                alert('All vulnerability data cleared successfully');
            }
        }

        // Edit and Delete Functions
        function editAsset(hostname) {
            const asset = vulnData.find(item => item.hostname === hostname);
            if (!asset) return;

            // Populate the edit form
            document.getElementById('editAssetOriginalHostname').value = hostname;
            document.getElementById('editAssetHostname').value = asset.hostname;
            document.getElementById('editAssetIP').value = asset.ipAddress || '';
            document.getElementById('editAssetVendor').value = asset.vendor || '';

            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('editAssetModal'));
            modal.show();
        }

        function saveAssetChanges() {
            const originalHostname = document.getElementById('editAssetOriginalHostname').value;
            const newHostname = document.getElementById('editAssetHostname').value;
            const newIP = document.getElementById('editAssetIP').value;
            const newVendor = document.getElementById('editAssetVendor').value;

            if (!newHostname.trim()) {
                alert('Hostname is required');
                return;
            }

            // Check if hostname changed and new hostname already exists
            if (originalHostname !== newHostname && vulnData.some(item => item.hostname === newHostname)) {
                alert('Hostname already exists');
                return;
            }

            // Update all vulnerabilities for this asset
            vulnData.forEach(item => {
                if (item.hostname === originalHostname) {
                    item.hostname = newHostname;
                    item.ipAddress = newIP;
                    item.vendor = newVendor;
                }
            });

            // Save to localStorage
            saveVulnData();

            // Refresh the display
            updateCardViews();

            // Close the modal
            bootstrap.Modal.getInstance(document.getElementById('editAssetModal')).hide();

            alert('Asset updated successfully');
        }

        function deleteAsset(hostname) {
            const asset = vulnData.filter(item => item.hostname === hostname);
            if (!asset.length) return;

            const vulnCount = asset.length;
            if (confirm(`Are you sure you want to delete asset "${hostname}" and all ${vulnCount} associated vulnerabilities?`)) {
                // Remove all vulnerabilities for this asset
                vulnData = vulnData.filter(item => item.hostname !== hostname);

                // Save to localStorage
                saveVulnData();

                // Refresh the display
                updateCardViews();

                alert(`Asset "${hostname}" and ${vulnCount} vulnerabilities deleted successfully`);
            }
        }

        function editVulnerability(vulnId) {
            const vuln = vulnData.find(item => item.vulnId === vulnId);
            if (!vuln) return;

            // Populate the edit form
            document.getElementById('editVulnOriginalId').value = vulnId;
            document.getElementById('editVulnName').value = vuln.name || '';
            document.getElementById('editVulnCVE').value = vuln.cve || '';
            document.getElementById('editVulnSeverity').value = vuln.severity || '';
            document.getElementById('editVulnVPR').value = vuln.vprScore || '';
            document.getElementById('editVulnVendor').value = vuln.vendor || '';

            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('editVulnModal'));
            modal.show();
        }

        function saveVulnChanges() {
            const vulnId = document.getElementById('editVulnOriginalId').value;
            const newName = document.getElementById('editVulnName').value;
            const newCVE = document.getElementById('editVulnCVE').value;
            const newSeverity = document.getElementById('editVulnSeverity').value;
            const newVPR = document.getElementById('editVulnVPR').value;
            const newVendor = document.getElementById('editVulnVendor').value;

            if (!newName.trim()) {
                alert('Vulnerability name is required');
                return;
            }

            // Find and update the vulnerability
            const vulnIndex = vulnData.findIndex(item => item.vulnId === vulnId);
            if (vulnIndex !== -1) {
                vulnData[vulnIndex].name = newName;
                vulnData[vulnIndex].cve = newCVE;
                vulnData[vulnIndex].severity = newSeverity;
                vulnData[vulnIndex].vprScore = parseFloat(newVPR) || 0;
                vulnData[vulnIndex].vendor = newVendor;

                // Save to localStorage
                saveVulnData();

                // Refresh the display
                updateCardViews();

                // Close the modal
                bootstrap.Modal.getInstance(document.getElementById('editVulnModal')).hide();

                alert('Vulnerability updated successfully');
            }
        }

        function deleteVulnerability(vulnId) {
            const vuln = vulnData.find(item => item.vulnId === vulnId);
            if (!vuln) return;

            if (confirm(`Are you sure you want to delete vulnerability "${vuln.name || vuln.cve}"?`)) {
                // Remove the vulnerability
                vulnData = vulnData.filter(item => item.vulnId !== vulnId);

                // Save to localStorage
                saveVulnData();

                // Refresh the display
                updateCardViews();

                alert('Vulnerability deleted successfully');
            }
        }

        // API Integration Functions
        function testCiscoAPI() {
            const apiKey = document.getElementById('ciscoApiKey').value;
            const secret = document.getElementById('ciscoSecret').value;

            if (!apiKey || !secret) {
                alert('Please enter both API key and secret');
                return;
            }

            // TODO: Implement actual Cisco API test
            alert('Cisco API test functionality will be implemented in a future version');
        }

        function testPaloAPI() {
            const apiKey = document.getElementById('paloApiKey').value;
            const host = document.getElementById('paloHost').value;

            if (!apiKey || !host) {
                alert('Please enter both API key and host');
                return;
            }

            // TODO: Implement actual Palo Alto API test
            alert('Palo Alto API test functionality will be implemented in a future version');
        }

        function testTenableAPI() {
            const accessKey = document.getElementById('tenableApiKey').value;
            const secretKey = document.getElementById('tenableSecret').value;

            if (!accessKey || !secretKey) {
                alert('Please enter both access key and secret key');
                return;
            }

            // TODO: Implement actual Tenable API test
            alert('Tenable API test functionality will be implemented in a future version');
        }

        function testQualysAPI() {
            const username = document.getElementById('qualysUsername').value;
            const password = document.getElementById('qualysPassword').value;

            if (!username || !password) {
                alert('Please enter both username and password');
                return;
            }

            // TODO: Implement actual Qualys API test
            alert('Qualys API test functionality will be implemented in a future version');
        }

        function syncFromAPIs() {
            alert('API synchronization functionality will be implemented in a future version');
        }

        // Add Connect to APIs button functionality
        function showAPIModal() {
            const modal = new bootstrap.Modal(document.getElementById('apiModal'));
            modal.show();
        }

        function toggleUploadArea() {
            const uploadArea = document.getElementById('uploadArea');
            const trendSection = document.getElementById('trendChartSection');
            
            if (uploadArea.style.display === 'none') {
                uploadArea.style.display = 'block';
                trendSection.style.display = 'none';
            } else {
                uploadArea.style.display = 'none';
                trendSection.style.display = 'block';
                updateTrendChart();
            }
        }

        function updateTrendChart() {
            if (!historyData || historyData.length === 0) {
                document.getElementById('trendChart').innerHTML = '<div class="text-center text-muted py-5">No historical data available</div>';
                return;
            }

            // Prepare data for the chart
            const chartData = historyData.map(entry => {
                const stats = calculateStatistics(entry.data, entry.date);
                return {
                    date: new Date(entry.date).toLocaleDateString(),
                    critical: stats.severityVPR.critical,
                    high: stats.severityVPR.high,
                    medium: stats.severityVPR.medium,
                    low: stats.severityVPR.low
                };
            });

            const options = {
                series: [
                    {
                        name: 'Critical',
                        data: chartData.map(d => ({ x: d.date, y: d.critical }))
                    },
                    {
                        name: 'High',
                        data: chartData.map(d => ({ x: d.date, y: d.high }))
                    },
                    {
                        name: 'Medium',
                        data: chartData.map(d => ({ x: d.date, y: d.medium }))
                    },
                    {
                        name: 'Low',
                        data: chartData.map(d => ({ x: d.date, y: d.low }))
                    }
                ],
                chart: {
                    height: 300,
                    type: 'line',
                    zoom: {
                        enabled: false
                    },
                    toolbar: {
                        show: true
                    }
                },
                colors: ['#ff6b6b', '#ffa726', '#42a5f5', '#66bb6a'],
                dataLabels: {
                    enabled: false
                },
                stroke: {
                    curve: 'smooth',
                    width: 3
                },
                title: {
                    text: 'Vulnerability Severity Trends',
                    align: 'left'
                },
                grid: {
                    borderColor: '#e7e7e7',
                    row: {
                        colors: ['#f3f3f3', 'transparent'],
                        opacity: 0.5
                    }
                },
                markers: {
                    size: 6
                },
                xaxis: {
                    type: 'category',
                    title: {
                        text: 'Upload Date'
                    }
                },
                yaxis: {
                    title: {
                        text: 'Average VPR Score'
                    },
                    min: 0,
                    max: 10
                },
                legend: {
                    position: 'top',
                    horizontalAlign: 'right',
                    floating: true,
                    offsetY: -25,
                    offsetX: -5
                }
            };

            const chart = new ApexCharts(document.querySelector("#trendChart"), options);
            chart.render();
        }

        // UTILITY: Storage management functions
        function clearStorageData() {
            if (confirm('This will clear all stored vulnerability data. Are you sure?')) {
                localStorage.removeItem('hextrackr_vuln_data');
                localStorage.removeItem('hextrackr_vuln_history');
                alert('Storage cleared successfully. You can now upload a new large CSV file.');
                location.reload();
            }
        }

        function getStorageInfo() {
            try {
                const vulnData = localStorage.getItem('hextrackr_vuln_data');
                const historyData = localStorage.getItem('hextrackr_vuln_history');
                const totalUsage = JSON.stringify(localStorage).length;
                
                console.log('Storage Usage:');
                console.log(`- Vulnerability Data: ${vulnData ? (vulnData.length / 1024 / 1024).toFixed(2) : 0}MB`);
                console.log(`- History Data: ${historyData ? (historyData.length / 1024 / 1024).toFixed(2) : 0}MB`);
                console.log(`- Total Storage: ${(totalUsage / 1024 / 1024).toFixed(2)}MB`);
                console.log('Run clearStorageData() to free up space');
            } catch (e) {
                console.error('Could not check storage:', e);
            }
        }

        // Add storage info to console on load
        setTimeout(getStorageInfo, 1000);

        // ================================
        // 🔐 ENCRYPTION & API FUNCTIONS
        // ================================

        // Generate a device-specific encryption key (stays in browser only)
        function getEncryptionKey() {
            let key = localStorage.getItem('hextrackr_encryption_key');
            if (!key) {
                // Generate a new key based on device characteristics
                const deviceData = navigator.userAgent + navigator.language + screen.width + screen.height;
                key = CryptoJS.SHA256(deviceData + Date.now()).toString();
                localStorage.setItem('hextrackr_encryption_key', key);
            }
            return key;
        }

        // Encrypt sensitive data
        function encryptData(data) {
            try {
                const key = getEncryptionKey();
                return CryptoJS.AES.encrypt(JSON.stringify(data), key).toString();
            } catch (e) {
                console.error('Encryption failed:', e);
                return null;
            }
        }

        // Decrypt sensitive data
        function decryptData(encryptedData) {
            try {
                const key = getEncryptionKey();
                const bytes = CryptoJS.AES.decrypt(encryptedData, key);
                return JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
            } catch (e) {
                console.error('Decryption failed:', e);
                return null;
            }
        }

        // Show API Configuration Modal
        function showAPIModal() {
            const modal = new bootstrap.Modal(document.getElementById('apiModal'));
            loadCiscoCredentials(); // Load existing credentials
            modal.show();
        }

        // Save Cisco credentials with encryption
        function saveCiscoCredentials() {
            const clientId = document.getElementById('ciscoClientId').value.trim();
            const clientSecret = document.getElementById('ciscoClientSecret').value.trim();

            if (!clientId || !clientSecret) {
                alert('Please enter both Client ID and Client Secret');
                return;
            }

            const credentials = {
                clientId: clientId,
                clientSecret: clientSecret,
                savedAt: new Date().toISOString()
            };

            const encrypted = encryptData(credentials);
            if (encrypted) {
                localStorage.setItem('hextrackr_cisco_credentials', encrypted);
                document.getElementById('ciscoStatus').textContent = 'Configured';
                document.getElementById('ciscoStatus').className = 'badge bg-success ms-2';
                
                // Clear the input fields for security
                document.getElementById('ciscoClientId').value = '';
                document.getElementById('ciscoClientSecret').value = '';
                
                alert('✅ Cisco API credentials encrypted and saved securely!');
            } else {
                alert('❌ Failed to encrypt credentials. Please try again.');
            }
        }

        // Load Cisco credentials (decrypt and populate form)
        function loadCiscoCredentials() {
            const encrypted = localStorage.getItem('hextrackr_cisco_credentials');
            if (encrypted) {
                const credentials = decryptData(encrypted);
                if (credentials) {
                    document.getElementById('ciscoClientId').value = credentials.clientId;
                    document.getElementById('ciscoClientSecret').value = credentials.clientSecret;
                    document.getElementById('ciscoStatus').textContent = 'Configured';
                    document.getElementById('ciscoStatus').className = 'badge bg-success ms-2';
                } else {
                    document.getElementById('ciscoStatus').textContent = 'Decryption Failed';
                    document.getElementById('ciscoStatus').className = 'badge bg-danger ms-2';
                }
            } else {
                document.getElementById('ciscoStatus').textContent = 'Not Configured';
                document.getElementById('ciscoStatus').className = 'badge bg-secondary ms-2';
            }
        }

        // Test Cisco API connection
        async function testCiscoAPI() {
            const clientId = document.getElementById('ciscoClientId').value.trim();
            const clientSecret = document.getElementById('ciscoClientSecret').value.trim();

            if (!clientId || !clientSecret) {
                alert('Please enter credentials first');
                return;
            }

            const resultDiv = document.getElementById('ciscoTestResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'alert alert-info';
            resultDiv.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Testing connection...';

            try {
                // Get OAuth token from Cisco
                const tokenResponse = await fetch('https://cloudsso.cisco.com/as/token.oauth2', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'Accept': 'application/json'
                    },
                    body: `client_id=${encodeURIComponent(clientId)}&client_secret=${encodeURIComponent(clientSecret)}&grant_type=client_credentials`
                });

                if (tokenResponse.ok) {
                    const tokenData = await tokenResponse.json();
                    resultDiv.className = 'alert alert-success';
                    resultDiv.innerHTML = `
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>✅ Connection Successful!</strong><br>
                        Access token received. API is ready to use.
                    `;
                    
                    // Store the token temporarily for testing
                    window.ciscoAccessToken = tokenData.access_token;
                } else {
                    throw new Error(`Authentication failed: ${tokenResponse.status}`);
                }
            } catch (error) {
                resultDiv.className = 'alert alert-danger';
                resultDiv.innerHTML = `
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>❌ Connection Failed!</strong><br>
                    ${error.message}
                `;
            }
        }

        // Sync Cisco vulnerabilities using API
        async function syncCiscoVulnerabilities() {
            const encrypted = localStorage.getItem('hextrackr_cisco_credentials');
            if (!encrypted) {
                alert('Please configure Cisco API credentials first');
                return;
            }

            const credentials = decryptData(encrypted);
            if (!credentials) {
                alert('Failed to decrypt credentials. Please reconfigure.');
                return;
            }

            const progressDiv = document.getElementById('syncProgress');
            const statusDiv = document.getElementById('syncStatus');
            const progressBar = progressDiv.querySelector('.progress-bar');

            progressDiv.style.display = 'block';
            statusDiv.textContent = 'Authenticating with Cisco API...';
            progressBar.style.width = '10%';

            try {
                // Step 1: Get OAuth token
                const tokenResponse = await fetch('https://cloudsso.cisco.com/as/token.oauth2', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'Accept': 'application/json'
                    },
                    body: `client_id=${encodeURIComponent(credentials.clientId)}&client_secret=${encodeURIComponent(credentials.clientSecret)}&grant_type=client_credentials`
                });

                if (!tokenResponse.ok) {
                    throw new Error('Authentication failed');
                }

                const tokenData = await tokenResponse.json();
                progressBar.style.width = '30%';
                statusDiv.textContent = 'Fetching vulnerability data...';

                // Step 2: Get recent CVEs (last 30 days)
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                const startDate = thirtyDaysAgo.toISOString().split('T')[0];
                const endDate = new Date().toISOString().split('T')[0];

                const vulnResponse = await fetch(`https://api.cisco.com/security/advisories/v2/advisories?startDate=${startDate}&endDate=${endDate}&limit=100`, {
                    headers: {
                        'Authorization': `Bearer ${tokenData.access_token}`,
                        'Accept': 'application/json'
                    }
                });

                if (!vulnResponse.ok) {
                    throw new Error('Failed to fetch vulnerabilities');
                }

                const vulnData = await vulnResponse.json();
                progressBar.style.width = '70%';
                statusDiv.textContent = 'Processing vulnerability data...';

                // Step 3: Transform API data to our format (only the 8 fields we care about)
                const transformedData = vulnData.advisories?.map(advisory => {
                    return {
                        hostname: 'Unknown Asset', // This would come from your asset inventory
                        ipAddress: 'Unknown IP', // This would come from your asset inventory
                        cve: advisory.cves?.length > 0 ? advisory.cves[0] : advisory.advisoryId,
                        definitionName: advisory.advisoryTitle || advisory.summary,
                        severity: mapCiscoSeverity(advisory.sir),
                        vprScore: mapSeverityToScore(advisory.sir),
                        vendor: 'Cisco',
                        date: new Date(advisory.publicationUrl || advisory.lastUpdated).toLocaleDateString(),
                        definitionId: advisory.advisoryId,
                        state: 'ACTIVE'
                    };
                }) || [];

                progressBar.style.width = '90%';
                statusDiv.textContent = 'Updating local database...';

                // Step 4: Merge with existing data
                const existingData = JSON.parse(localStorage.getItem('hextrackr_vuln_data') || '[]');
                const mergedData = [...existingData, ...transformedData];
                
                // Remove duplicates
                const uniqueData = mergedData.filter((item, index, array) => 
                    array.findIndex(other => other.cve === item.cve && other.hostname === item.hostname) === index
                );

                // Save to localStorage
                localStorage.setItem('hextrackr_vuln_data', JSON.stringify(uniqueData));
                window.vulnData = uniqueData;

                progressBar.style.width = '100%';
                statusDiv.textContent = `✅ Successfully synced ${transformedData.length} vulnerabilities from Cisco API`;

                // Refresh the display
                filterAndDisplayData();

                // Hide progress after 3 seconds
                setTimeout(() => {
                    progressDiv.style.display = 'none';
                    statusDiv.textContent = '';
                }, 3000);

                alert(`✅ Successfully synced ${transformedData.length} Cisco vulnerabilities!\nOnly essential fields were imported to optimize performance.`);

            } catch (error) {
                progressBar.style.width = '0%';
                statusDiv.textContent = `❌ Sync failed: ${error.message}`;
                progressDiv.style.display = 'none';
                alert(`❌ Sync failed: ${error.message}`);
            }
        }

        // Map Cisco severity to our format
        function mapCiscoSeverity(sir) {
            if (!sir) return 'info';
            const severity = sir.toLowerCase();
            if (severity.includes('critical')) return 'critical';
            if (severity.includes('high')) return 'high';
            if (severity.includes('medium')) return 'medium';
            if (severity.includes('low')) return 'low';
            return 'info';
        }

        // Map severity to numeric score
        function mapSeverityToScore(sir) {
            const severity = mapCiscoSeverity(sir);
            switch (severity) {
                case 'critical': return 9.5;
                case 'high': return 7.5;
                case 'medium': return 5.0;
                case 'low': return 2.5;
                default: return 1.0;
            }
        }

        // Sync Cisco Security Advisories
        async function syncCiscoAdvisories() {
            alert('Security Advisories sync feature coming soon! This will pull detailed advisory information.');
        }

        // Clear all encrypted API credentials
        function clearAPICredentials() {
            if (confirm('⚠️ Are you sure you want to clear all API credentials? This cannot be undone.')) {
                localStorage.removeItem('hextrackr_cisco_credentials');
                localStorage.removeItem('hextrackr_encryption_key');
                document.getElementById('ciscoClientId').value = '';
                document.getElementById('ciscoClientSecret').value = '';
                document.getElementById('ciscoStatus').textContent = 'Not Configured';
                document.getElementById('ciscoStatus').className = 'badge bg-secondary ms-2';
                alert('✅ All API credentials have been cleared.');
            }
        }

        // Check API configuration on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Check if Cisco credentials are configured
            const encrypted = localStorage.getItem('hextrackr_cisco_credentials');
            if (encrypted) {
                const credentials = decryptData(encrypted);
                if (credentials) {
                    document.getElementById('ciscoStatus').textContent = 'Configured';
                    document.getElementById('ciscoStatus').className = 'badge bg-success ms-2';
                }
            }
        });
    </script>
</body>
</html>
