<!-- Fragment template for documentation content injected by docs-tabler.js -->
<section class="doc-fragment">
    <h1>Backend Architecture</h1>
<p>The backend is a Node.js/Express monolithic server providing REST endpoints, data processing, and SQLite persistence. It also serves the static frontend assets and the documentation portal.</p>
<h2>Key Characteristics</h2>
<ul>
<li><strong>Monolithic Architecture</strong>: A single <code>server.js</code> file (over 1,200 lines) handles all backend concerns, including routing, database interaction, and business logic.</li>
<li><strong>Dual Purpose</strong>: Acts as both an API server and a static file server for the UI.</li>
<li><strong>Database</strong>: A single SQLite database file (<code>data/hextrackr.db</code>) with a shared connection pool.</li>
<li><strong>Security</strong>: Includes a built-in <code>PathValidator</code> class for secure file system operations and sets standard security headers.</li>
</ul>
<h2>Core Components</h2>
<ul>
<li><strong><code>server.js</code></strong>: The main entry point. It initializes the Express app, configures middleware, sets up all API routes, and connects to the SQLite database.</li>
<li><strong><code>scripts/init-database.js</code></strong>: A script responsible for creating the initial database schema, including tables and indexes.</li>
<li><strong><code>PathValidator</code> Class</strong>: A security utility class within <code>server.js</code> designed to prevent path traversal attacks when accessing the file system.</li>
</ul>
<h2>Core Middleware</h2>
<ul>
<li><strong><code>cors</code></strong>: Enables Cross-Origin Resource Sharing.</li>
<li><strong><code>compression</code></strong>: Compresses response bodies for better performance.</li>
<li><strong><code>express.json</code></strong>: Parses incoming JSON requests (limit <code>100mb</code>).</li>
<li><strong><code>express.urlencoded</code></strong>: Parses URL-encoded data (limit <code>100mb</code>).</li>
<li><strong><code>multer</code></strong>: Handles <code>multipart/form-data</code> for file uploads, specifically for CSV imports.</li>
<li><strong>Security Headers</strong>: Sets <code>X-Content-Type-Options</code>, <code>X-Frame-Options</code>, and <code>X-XSS-Protection</code> headers on all responses.</li>
<li><strong><code>express.static</code></strong>: Serves static files (HTML, CSS, JS) from the project root and <code>docs-html</code> directories.</li>
</ul>
<h2>Persistence and Data Management</h2>
<h3>Database</h3>
<p>The backend uses a file-based SQLite database. For a detailed schema, see the <a href="./data-model.html">Data Model documentation</a>.</p>
<ul>
<li><strong>Initialization</strong>: On startup, the server checks if the database file exists. If not, it runs the <code>scripts/init-database.js</code> script to create it.</li>
<li><strong>Schema Evolution</strong>: The server performs idempotent <code>ALTER TABLE</code> operations on startup to add new columns to the <code>vulnerabilities</code> table, ensuring backward compatibility with older database files.</li>
</ul>
<h3>Vulnerability Rollover Architecture</h3>
<p>A key feature of the backend is the <strong>rollover architecture</strong> for managing vulnerability data. This system processes daily scans to maintain both a current snapshot and a historical trend of vulnerabilities. For a detailed explanation, see the <a href="./rollover-mechanism.html">Vulnerability Rollover Architecture documentation</a>.</p>
<h2>API Surface</h2>
<p>The backend exposes a comprehensive REST API. For full request/response details, see the <a href="../api-reference/overview.html">API Reference</a>.</p>
<ul>
<li><strong>Tickets</strong>: <code>GET, POST, PUT, DELETE /api/tickets</code>, <code>POST /api/tickets/migrate</code>, <code>POST /api/import/tickets</code></li>
<li><strong>Reference Data</strong>: <code>GET /api/sites</code>, <code>GET /api/locations</code></li>
<li><strong>Vulnerabilities</strong>: <code>GET /api/vulnerabilities</code>, <code>GET /api/vulnerabilities/stats</code>, <code>GET /api/vulnerabilities/recent-trends</code>, <code>GET /api/vulnerabilities/trends</code>, <code>POST /api/vulnerabilities/import</code>, <code>POST /api/import/vulnerabilities</code>, <code>DELETE /api/vulnerabilities/clear</code></li>
<li><strong>Imports</strong>: <code>GET /api/imports</code></li>
<li><strong>Backup/Restore</strong>: <code>GET /api/backup/stats</code>, <code>GET /api/backup/:type</code>, <code>POST /api/restore</code>, <code>DELETE /api/backup/clear/:type</code></li>
<li><strong>Internal</strong>: <code>GET /health</code>, <code>GET /api/docs/stats</code></li>
</ul>
<h2>Key Business Logic Flows</h2>
<h3>Vulnerability CSV Import</h3>
<pre><code class="language-mermaid">sequenceDiagram
    participant User
    participant API as server.js
    participant DB as SQLite

    User-&gt;&gt;API: POST /api/vulnerabilities/import (multipart/form-data)
    API-&gt;&gt;API: Parse CSV with PapaParse
    API-&gt;&gt;DB: INSERT into vulnerability_imports
    API-&gt;&gt;API: Process rows with rollover logic
    API-&gt;&gt;DB: INSERT into vulnerability_snapshots
    API-&gt;&gt;DB: INSERT or UPDATE vulnerabilities_current
    API-&gt;&gt;DB: DELETE stale vulnerabilities
    API-&gt;&gt;DB: UPDATE vulnerability_daily_totals
    API--&gt;&gt;User: { success, importId, rowsProcessed, ... }
</code></pre>
<h3>Get Paginated Vulnerabilities</h3>
<pre><code class="language-mermaid">sequenceDiagram
    participant UI as Frontend
    participant API as server.js
    participant DB as SQLite

    UI-&gt;&gt;API: GET /api/vulnerabilities?page=1&amp;limit=50
    API-&gt;&gt;DB: SELECT * FROM vulnerabilities_current ... LIMIT ? OFFSET ?
    DB--&gt;&gt;API: Vulnerability rows
    API-&gt;&gt;DB: SELECT COUNT(*) FROM vulnerabilities_current
    DB--&gt;&gt;API: Total count
    API--&gt;&gt;UI: { data: [...], pagination: { ... } }
</code></pre>

    <!-- Note: This file is intentionally minimal. The full page scaffold, header, footer, and scripts
             are provided by docs-html/index.html. Content generated using this template will be
             fetched and injected into #content-container by docs-html/js/docs-portal-v2.js. -->
</section>
