# Proposed Vulnerability Tracking Schema

## Problem with Current Approach

- Unique constraints are CVE-based but many vulnerabilities don't have CVEs
- No proper time-series tracking for trending
- Duplicate detection logic is flawed

## Proposed Solution: Snapshot-Based Architecture

### 1. vulnerabilities (master record)

```sql
CREATE TABLE vulnerabilities (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    vulnerability_key TEXT NOT NULL UNIQUE, -- SHA256(hostname + description + vpr_score)
    hostname TEXT NOT NULL,
    ip_address TEXT,
    description TEXT NOT NULL,
    vpr_score REAL NOT NULL,
    severity TEXT,
    vendor TEXT,
    cve TEXT, -- Optional, many don't have this
    cvss_score REAL,
    plugin_id TEXT,
    solution TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### 2. vulnerability_snapshots (time-series tracking)

```sql
CREATE TABLE vulnerability_snapshots (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    vulnerability_id INTEGER NOT NULL,
    import_id INTEGER NOT NULL,
    import_date TEXT NOT NULL, -- 2025-08-18, 2025-09-01, etc.
    state TEXT DEFAULT 'ACTIVE', -- ACTIVE, RESOLVED, NEW
    first_seen TEXT,
    last_seen TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (vulnerability_id) REFERENCES vulnerabilities (id),
    FOREIGN KEY (import_id) REFERENCES vulnerability_imports (id),
    UNIQUE(vulnerability_id, import_date)
);
```

### 3. vulnerability_daily_totals (dashboard aggregates)

```sql
CREATE TABLE vulnerability_daily_totals (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    import_date TEXT NOT NULL UNIQUE,
    critical_count INTEGER DEFAULT 0,
    critical_vpr_total REAL DEFAULT 0,
    high_count INTEGER DEFAULT 0,
    high_vpr_total REAL DEFAULT 0,
    medium_count INTEGER DEFAULT 0,
    medium_vpr_total REAL DEFAULT 0,
    low_count INTEGER DEFAULT 0,
    low_vpr_total REAL DEFAULT 0,
    total_count INTEGER DEFAULT 0,
    total_vpr REAL DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

## Benefits

1. **Proper deduplication**: Hostname + Description + VPR Score (works without CVE)
2. **Time-series tracking**: Same vulnerability can exist across multiple dates
3. **Trending analysis**: Easy to compare totals between dates
4. **Performance**: Pre-calculated aggregates for dashboard
5. **Flexibility**: Can track vulnerability lifecycle (NEW → ACTIVE → RESOLVED)

## Import Workflow

1. Parse CSV row
2. Generate vulnerability_key = SHA256(hostname + description + vpr_score)
3. INSERT or UPDATE vulnerability master record
4. INSERT snapshot for this import_date
5. UPDATE daily totals for this import_date

## Dashboard Queries

```sql
-- Get latest totals
SELECT * FROM vulnerability_daily_totals ORDER BY import_date DESC LIMIT 1;

-- Get trending data
SELECT import_date, critical_vpr_total, high_vpr_total 
FROM vulnerability_daily_totals 
ORDER BY import_date;

-- Get vulnerabilities for a specific date
SELECT v.*, vs.state, vs.import_date 
FROM vulnerabilities v
JOIN vulnerability_snapshots vs ON v.id = vs.vulnerability_id
WHERE vs.import_date = '2025-08-18';
```
