<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HexTrackr - Vulnerability Dashboard v2.3.0</title>
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üõ°Ô∏è</text></svg>">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'hex': {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e'
                        }
                    }
                }
            }
        }
    </script>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- ApexCharts for sparklines -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <!-- CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <!-- Sortable for drag/drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <!-- Crypto for encryption -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <!-- Deprecated Turso service moved to /deprecated folder -->
    <!-- <script src="deprecated/turso-service.js"></script> -->
    <!-- <script src="cisco-api-service-enhanced.js"></script> -->
    <!-- <script src="dnac-api-service.js"></script> -->
    <!-- <script src="tenable-vpr-service.js"></script> -->
    <!-- <script src="servicenow-api-service.js"></script> -->
    <!-- <script src="integration-service.js"></script> -->
    <style>
        /* HexTrackr Custom Styles */
        :root {
            --hex-50: #f0f9ff;
            --hex-100: #e0f2fe;
            --hex-500: #0ea5e9;
            --hex-600: #0284c7;
            --hex-700: #0369a1;
            --hex-800: #075985;
            --hex-900: #0c4a6e;
        }
        
        /* Custom gradient backgrounds */
        .bg-gradient-hex {
            background: linear-gradient(135deg, var(--hex-800) 0%, var(--hex-700) 50%, var(--hex-600) 100%);
        }
        
        .bg-gradient-light {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        }
        
        /* Utility classes */
        .min-h-screen {
            min-height: 100vh;
        }
        
        /* Vulnerability-specific customizations */
        
        /* Responsive Layout Improvements */
        .main-container {
            padding: 20px;
            margin: 10px auto;
        }

        /* Compact Button Layout */
        .btn {
            white-space: nowrap;
        }

        .btn-group .btn-sm {
            padding: 0.375rem 0.75rem;
        }

        /* Mobile responsive adjustments */
        @media (max-width: 768px) {
            .main-container {
                padding: 15px;
                margin: 5px;
            }
            
            .d-flex.flex-wrap.gap-2 {
                justify-content: center !important;
            }
            
            .btn-group {
                flex-direction: column;
                width: 100%;
            }
            
            .btn-group .btn {
                border-radius: 0.375rem !important;
                margin-bottom: 2px;
            }
        }

        /* Enhanced Card Styling */
        .hex-card .card-body {
            transition: all 0.3s ease;
        }

        .hex-card:hover .card-body {
            transform: scale(1.02);
        }

        /* Table Responsive Wrapper */
        .table-container {
            background: rgba(255, 255, 255, 0.9);
            border-radius: var(--hex-border-radius);
            box-shadow: var(--hex-shadow);
            overflow: hidden;
        }

        .table-responsive {
            border-radius: var(--hex-border-radius);
        }

        /* Improved Modal Styling */
        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
        }
        
        /* Sortable table headers */
        .sortable-header {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 25px !important;
        }
        
        .sortable-header:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .sortable-header::after {
            content: '\f0dc';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.5;
        }
        
        .sortable-header.sort-asc::after {
            content: '\f0de';
            opacity: 1;
        }
        
        .sortable-header.sort-desc::after {
            content: '\f0dd';
            opacity: 1;
        }

        /* Severity indicators using unified colors */
        .severity-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .severity-critical .severity-indicator { background: var(--hex-danger); }
        .severity-high .severity-indicator { background: var(--hex-warning); }
        .severity-medium .severity-indicator { background: var(--hex-info); }
        .severity-low .severity-indicator { background: var(--hex-success); }

        /* Severity Statistics Cards - Clean Design */
        .severity-statistics {
            background: rgba(255, 255, 255, 0.95);
            border-radius: var(--hex-border-radius);
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: var(--hex-shadow);
            isolation: isolate; /* Prevents bleeding from other elements */
            position: relative;
            z-index: 10;
        }

        .severity-card {
            background: white;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            transition: all 0.3s ease;
            cursor: pointer;
            overflow: hidden;
            position: relative;
            height: 140px;
        }

        .severity-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border-color: var(--hex-primary);
        }

        .severity-card.critical {
            border-left: 4px solid var(--hex-critical);
        }

        .severity-card.critical:hover {
            border-left-color: var(--hex-critical);
            background: linear-gradient(135deg, rgba(220, 38, 38, 0.05) 0%, white 100%);
        }

        .severity-card.high {
            border-left: 4px solid var(--hex-high);
        }

        .severity-card.high:hover {
            border-left-color: var(--hex-high);
            background: linear-gradient(135deg, rgba(234, 88, 12, 0.05) 0%, white 100%);
        }

        .severity-card.medium {
            border-left: 4px solid var(--hex-medium);
        }

        .severity-card.medium:hover {
            border-left-color: var(--hex-medium);
            background: linear-gradient(135deg, rgba(217, 119, 6, 0.05) 0%, white 100%);
        }

        .severity-card.low {
            border-left: 4px solid var(--hex-low);
        }

        .severity-card.low:hover {
            border-left-color: var(--hex-low);
            background: linear-gradient(135deg, rgba(101, 163, 13, 0.05) 0%, white 100%);
        }

        .severity-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 10px 0 5px 0;
        }

        .severity-label {
            font-size: 0.9rem;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 0;
        }

        .severity-icon {
            position: absolute;
            top: 15px;
            right: 15px;
            opacity: 0.1;
            font-size: 2rem;
        }

        .severity-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(102, 126, 234, 0.9);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .severity-card:hover .severity-overlay {
            opacity: 1;
        }

        .severity-overlay i {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        /* Ensure table containers don't bleed */
        #tableContainer {
            isolation: isolate;
            position: relative;
            z-index: 1;
        }

        #tableContainer.show {
            display: block !important;
        }

        /* Clear any table styling that might bleed */
        .severity-statistics * {
            background-image: none !important;
            background-color: transparent;
        }

        .severity-statistics .severity-card {
            background: white !important;
        }

        /* Sparkline containers in cards */
        .card-sparkline {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 60px;
            height: 30px;
            opacity: 0.3;
        }

        /* Sparkline containers for severity cards */
        .sparkline-container {
            height: 50px !important;
            margin: 8px 0 !important;
            opacity: 0.8;
            border-radius: 4px;
        }

        .sparkline-container .apexcharts-canvas {
            max-height: 50px !important;
        }

        /* Change indicators for severity cards */
        .change-indicator {
            display: flex !important;
            flex-direction: column;
            align-items: center;
            font-size: 0.75rem;
            line-height: 1.1;
            min-width: 40px;
        }

        .change-indicator i {
            font-size: 0.9rem;
            margin-bottom: 1px;
        }

        .change-indicator.increase i {
            color: #dc3545 !important; /* Red for increases (bad) */
        }

        .change-indicator.decrease i {
            color: #28a745 !important; /* Green for decreases (good) */
            transform: rotate(180deg);
        }

        .change-indicator.no-change i {
            color: #6c757d !important; /* Gray for no change */
            transform: rotate(90deg);
        }

        .change-value {
            font-weight: 600;
            white-space: nowrap;
        }

        .change-indicator.increase .change-value {
            color: #dc3545;
        }

        .change-indicator.decrease .change-value {
            color: #28a745;
        }

        .change-indicator.no-change .change-value {
            color: #6c757d;
        }

        /* Animation for change indicators */
        .change-indicator {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-blue-50 min-h-screen">
    <!-- Modern Streamlined Header -->
    <header class="bg-gradient-to-r from-hex-800 via-hex-700 to-hex-600 shadow-xl border-b-4 border-hex-500">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <!-- Logo and Title -->
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-3">
                        <div class="bg-white/20 p-2 rounded-lg backdrop-blur-sm">
                            <i class="fas fa-shield-alt text-white text-xl"></i>
                        </div>
                        <h1 class="text-2xl font-bold text-white tracking-tight">
                            HexTrackr
                            <span class="text-hex-100 font-normal ml-2 text-lg">
                                Vulnerability Dashboard v2.3.0
                            </span>
                        </h1>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex items-center space-x-3">
                    <button id="toolsButton" class="inline-flex items-center px-4 py-2 bg-white/10 hover:bg-white/20 text-white rounded-lg transition-all duration-200 backdrop-blur-sm border border-white/20 hover:border-white/30">
                        <i class="fas fa-tools mr-2"></i>
                        <span class="hidden sm:inline">Tools & Settings</span>
                        <span class="sm:hidden">Tools</span>
                    </button>
                    <a href="tickets.html" class="inline-flex items-center px-4 py-2 bg-hex-500 hover:bg-hex-400 text-white rounded-lg transition-all duration-200 shadow-md hover:shadow-lg">
                        <i class="fas fa-ticket-alt mr-2"></i>
                        <span class="hidden sm:inline">Ticket Management</span>
                        <span class="sm:hidden">Tickets</span>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="space-y-8">
            <!-- Modern Upload Section -->
            <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
                <div class="bg-gradient-to-r from-hex-600 to-hex-700 px-6 py-4">
                    <div class="flex justify-between items-center">
                        <h2 class="text-xl font-semibold text-white flex items-center">
                            <i class="fas fa-cloud-upload-alt mr-3"></i>
                            Upload Vulnerability Data
                        </h2>
                        <div class="flex gap-3">
                            <button id="uploadCsvButton" class="btn btn-sm bg-white/20 hover:bg-white/30 text-white border-white/20 hover:border-white/40 transition-all duration-200">
                                <i class="fas fa-file-csv me-1"></i>Upload CSV
                            </button>
                            <button id="uploadJsonButton" class="btn btn-sm bg-white/20 hover:bg-white/30 text-white border-white/20 hover:border-white/40 transition-all duration-200">
                                <i class="fas fa-file-code me-1"></i>Upload JSON
                            </button>
                            <!-- DISABLED: API connections removed for standalone operation -->
                            <button id="connectApisButton" class="btn btn-sm bg-gray-500 text-gray-300 border-gray-500 cursor-not-allowed" disabled>
                                <i class="fas fa-ban me-1"></i>APIs Disabled
                            </button>
                        </div>
                    </div>
                </div>
                <div class="p-6">
                    <div class="upload-area border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-hex-400 hover:bg-hex-50/50 transition-all duration-200 cursor-pointer" id="uploadArea">
                        <div class="space-y-4">
                            <div class="mx-auto w-16 h-16 bg-hex-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-cloud-upload-alt text-hex-600 text-2xl"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-medium text-gray-900">Drop files here or click to browse</h3>
                                <p class="text-gray-500 mt-1">Supports multiple CSV files from various vulnerability scanners</p>
                            </div>
                            <input type="file" id="fileInput" class="hidden" accept=".csv" multiple>
                            <button id="selectFileButton" class="inline-flex items-center px-6 py-3 bg-hex-600 hover:bg-hex-700 text-white font-medium rounded-lg transition-colors duration-200 shadow-md hover:shadow-lg">
                                <i class="fas fa-file-upload mr-2"></i>
                                Choose Files
                            </button>
                            <div class="text-sm text-gray-600 bg-gray-50 rounded-lg p-3 inline-block">
                                <i class="fas fa-info-circle text-hex-500 mr-2"></i>
                                Compatible with Tenable, Qualys, Nessus, and other standard formats
                            </div>
                        </div>
                    </div>
                </div>
            </div>

                <!-- Trend Chart Section (Hidden initially) -->
                <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden mb-6" id="trendChartSection" style="display: none;">
                    <div class="card-header bg-gradient-to-r from-hex-50 to-hex-100 px-6 py-4 border-b border-gray-200">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-0 text-hex-primary font-semibold">
                                    <i class="fas fa-chart-line me-2"></i>Vulnerability Trends Over Time
                                </h5>
                                <small class="text-gray-600">Track vulnerability severity changes across imports</small>
                            </div>
                            <!-- Chart Controls -->
                            <div class="d-flex gap-2">
                                <select id="scoreTypeSelect" class="form-select form-select-sm" style="width: auto;" onchange="updateTrendChart(this.value, document.getElementById('metricTypeSelect').value)">
                                    <option value="VPR">VPR Scores</option>
                                    <option value="CVSS">CVSS Scores</option>
                                </select>
                                <select id="metricTypeSelect" class="form-select form-select-sm" style="width: auto;" onchange="updateTrendChart(document.getElementById('scoreTypeSelect').value, this.value)">
                                    <option value="sum">Totals</option>
                                    <option value="avg">Averages</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="p-6">
                        <div id="trendChart" class="chart-wrapper" style="height: 450px; background: rgba(255,255,255,0.95); border-radius: 8px; padding: 20px;"></div>
                    </div>
                </div>

            <!-- Modern Severity Dashboard -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Critical Vulnerabilities -->
                <div id="criticalCard" class="bg-white rounded-xl shadow-lg border-l-4 border-red-500 hover:shadow-xl hover:scale-105 transition-all duration-300 cursor-pointer group" data-severity="critical">
                    <div class="p-6 text-center">
                        <div class="w-14 h-14 mx-auto mb-4 bg-red-100 rounded-full flex items-center justify-center group-hover:bg-red-200 transition-colors">
                            <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                        </div>
                        <div class="space-y-2">
                            <div class="flex items-center justify-center space-x-2">
                                <h2 class="text-3xl font-bold text-red-600" id="criticalValue">0.0</h2>
                                <div id="criticalChange" class="hidden">
                                    <div class="flex items-center text-green-600">
                                        <i class="fas fa-arrow-up text-xs"></i>
                                        <span class="text-sm change-value">+0.0</span>
                                    </div>
                                </div>
                            </div>
                            <h3 class="font-semibold text-gray-900">Critical VPR Total</h3>
                            <div id="criticalSparkline" class="sparkline-container" style="height: 50px; margin: 8px 0;"></div>
                            <p class="text-sm text-gray-500">Click to filter</p>
                        </div>
                    </div>
                </div>

                <!-- High Vulnerabilities -->
                <div id="highCard" class="bg-white rounded-xl shadow-lg border-l-4 border-orange-500 hover:shadow-xl hover:scale-105 transition-all duration-300 cursor-pointer group" data-severity="high">
                    <div class="p-6 text-center">
                        <div class="w-14 h-14 mx-auto mb-4 bg-orange-100 rounded-full flex items-center justify-center group-hover:bg-orange-200 transition-colors">
                            <i class="fas fa-exclamation-circle text-orange-600 text-xl"></i>
                        </div>
                        <div class="space-y-2">
                            <div class="flex items-center justify-center space-x-2">
                                <h2 class="text-3xl font-bold text-orange-600" id="highValue">0.0</h2>
                                <div id="highChange" class="hidden">
                                    <div class="flex items-center text-green-600">
                                        <i class="fas fa-arrow-up text-xs"></i>
                                        <span class="text-sm change-value">+0.0</span>
                                    </div>
                                </div>
                            </div>
                            <h3 class="font-semibold text-gray-900">High VPR Total</h3>
                            <div id="highSparkline" class="sparkline-container" style="height: 50px; margin: 8px 0;"></div>
                            <p class="text-sm text-gray-500">Click to filter</p>
                        </div>
                    </div>
                </div>

                <!-- Medium Vulnerabilities -->
                <div id="mediumCard" class="bg-white rounded-xl shadow-lg border-l-4 border-yellow-500 hover:shadow-xl hover:scale-105 transition-all duration-300 cursor-pointer group" data-severity="medium">
                    <div class="p-6 text-center">
                        <div class="w-14 h-14 mx-auto mb-4 bg-yellow-100 rounded-full flex items-center justify-center group-hover:bg-yellow-200 transition-colors">
                            <i class="fas fa-info-circle text-yellow-600 text-xl"></i>
                        </div>
                        <div class="space-y-2">
                            <div class="flex items-center justify-center space-x-2">
                                <h2 class="text-3xl font-bold text-yellow-600" id="mediumValue">0.0</h2>
                                <div id="mediumChange" class="hidden">
                                    <div class="flex items-center text-green-600">
                                        <i class="fas fa-arrow-up text-xs"></i>
                                        <span class="text-sm change-value">+0.0</span>
                                    </div>
                                </div>
                            </div>
                            <h3 class="font-semibold text-gray-900">Medium VPR Total</h3>
                            <div id="mediumSparkline" class="sparkline-container" style="height: 50px; margin: 8px 0;"></div>
                            <p class="text-sm text-gray-500">Click to filter</p>
                        </div>
                    </div>
                </div>

                <!-- Low Vulnerabilities -->
                <div id="lowCard" class="bg-white rounded-xl shadow-lg border-l-4 border-green-500 hover:shadow-xl hover:scale-105 transition-all duration-300 cursor-pointer group" data-severity="low">
                    <div class="p-6 text-center">
                        <div class="w-14 h-14 mx-auto mb-4 bg-green-100 rounded-full flex items-center justify-center group-hover:bg-green-200 transition-colors">
                            <i class="fas fa-shield-alt text-green-600 text-xl"></i>
                        </div>
                        <div class="space-y-2">
                            <div class="flex items-center justify-center space-x-2">
                                <h2 class="text-3xl font-bold text-green-600" id="lowValue">0.0</h2>
                                <div id="lowChange" class="hidden">
                                    <div class="flex items-center text-green-600">
                                        <i class="fas fa-arrow-up text-xs"></i>
                                        <span class="text-sm change-value">+0.0</span>
                                    </div>
                                </div>
                            </div>
                            <h3 class="font-semibold text-gray-900">Low VPR Total</h3>
                            <div id="lowSparkline" class="sparkline-container" style="height: 50px; margin: 8px 0;"></div>
                            <p class="text-sm text-gray-500">Click to filter</p>
                        </div>
                    </div>
                </div>
            </div>

                <!-- View Controls -->
                <!-- Modern Search and Filter Navigation Bar -->
                <nav class="navbar navbar-expand-lg bg-white shadow-sm rounded-lg border mb-4 p-3">
                    <div class="container-fluid">
                        <!-- View Toggles -->
                        <div class="navbar-brand mb-0 me-4">
                            <div class="btn-group" role="group" aria-label="View toggles">
                                <input type="radio" class="btn-check" name="viewMode" id="assetView" value="asset" checked>
                                <label class="btn btn-outline-primary" for="assetView">
                                    <i class="fas fa-server me-2"></i>Asset View
                                </label>
                                
                                <input type="radio" class="btn-check" name="viewMode" id="vulnView" value="vuln">
                                <label class="btn btn-outline-primary" for="vulnView">
                                    <i class="fas fa-bug me-2"></i>Vulnerability View
                                </label>
                                
                                <input type="radio" class="btn-check" name="viewMode" id="tableView" value="table">
                                <label class="btn btn-outline-primary" for="tableView">
                                    <i class="fas fa-table me-2"></i>Table View
                                </label>
                            </div>
                        </div>

                        <!-- Collapsible content for search and filters -->
                        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSearchFilters" aria-controls="navbarSearchFilters" aria-expanded="false" aria-label="Toggle navigation">
                            <span class="navbar-toggler-icon"></span>
                        </button>

                        <div class="collapse navbar-collapse" id="navbarSearchFilters">
                            <div class="navbar-nav w-100">
                                <div class="row w-100 g-3 align-items-end">
                                    <!-- Search Box -->
                                    <div class="col-xl-4 col-lg-5">
                                        <div class="search-container">
                                            <label class="form-label small fw-bold text-muted mb-1">
                                                <i class="fas fa-search me-1"></i>Search
                                            </label>
                                            <div class="input-group">
                                                <input type="text" class="form-control" id="searchInput" 
                                                       placeholder="Assets, CVEs, hostnames..." 
                                                       autocomplete="off">
                                                <button class="btn btn-outline-secondary" type="button" id="clearSearch" title="Clear search">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Severity Filter -->
                                    <div class="col-xl-2 col-lg-3 col-md-4">
                                        <div class="filter-container">
                                            <label for="severityFilter" class="form-label small fw-bold text-muted mb-1">
                                                <i class="fas fa-filter me-1"></i>Severity
                                            </label>
                                            <select class="form-select" id="severityFilter">
                                                <option value="">All Severities</option>
                                                <option value="critical">üî¥ Critical</option>
                                                <option value="high">üü† High</option>
                                                <option value="medium">üü° Medium</option>
                                                <option value="low">üü¢ Low</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <!-- Ticket Status Filter -->
                                    <div class="col-xl-2 col-lg-3 col-md-4">
                                        <div class="filter-container">
                                            <label for="ticketFilter" class="form-label small fw-bold text-muted mb-1">
                                                <i class="fas fa-ticket-alt me-1"></i>Tickets
                                            </label>
                                            <select class="form-select" id="ticketFilter">
                                                <option value="">All Items</option>
                                                <option value="open">üìã Has Open Ticket</option>
                                                <option value="closed">‚úÖ Has Closed Ticket</option>
                                                <option value="none">‚ùå No Ticket</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <!-- Sort Options -->
                                    <div class="col-xl-2 col-lg-3 col-md-4">
                                        <div class="filter-container">
                                            <label for="sortSelect" class="form-label small fw-bold text-muted mb-1">
                                                <i class="fas fa-sort me-1"></i>Sort by
                                            </label>
                                            <select class="form-select" id="sortSelect">
                                                <option value="hostname-asc">Hostname A-Z</option>
                                                <option value="hostname-desc">Hostname Z-A</option>
                                                <option value="severity-high">Severity (High to Low)</option>
                                                <option value="severity-low">Severity (Low to High)</option>
                                                <option value="tickets-open">Open Tickets First</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <!-- Action Buttons -->
                                    <div class="col-xl-2 col-lg-12 col-md-12">
                                        <div class="d-flex gap-2 justify-content-end flex-wrap">
                                            <button id="refreshButton" class="btn btn-outline-primary" title="Refresh data">
                                                <i class="fas fa-sync-alt"></i>
                                            </button>
                                            <button id="exportButton" class="btn btn-outline-success" title="Export Data">
                                                <i class="fas fa-download"></i>
                                            </button>
                                            <button id="settingsButton" class="btn btn-outline-info" title="Settings">
                                                <i class="fas fa-cog"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </nav>

                <!-- Data Display Area -->
                <div id="assetCardsContainer" class="row">
                    <!-- Asset cards will be dynamically loaded here -->
                </div>

                <!-- Asset Pagination -->
                <div id="assetPaginationContainer" class="row mt-3" style="display: none;">
                    <div class="col-12">
                        <nav aria-label="Asset pagination">
                            <ul class="pagination justify-content-center" id="assetPagination">
                                <!-- Pagination controls will be dynamically loaded here -->
                            </ul>
                        </nav>
                        <div class="text-center">
                            <small class="text-muted">Items per page: 
                                <select id="assetItemsPerPage" class="form-select form-select-sm d-inline-block" style="width: auto;">
                                    <option value="12">12</option>
                                    <option value="24" selected>24</option>
                                    <option value="48">48</option>
                                    <option value="96">96</option>
                                </select>
                            </small>
                        </div>
                    </div>
                </div>

                <div id="vulnCardsContainer" class="row" style="display: none;">
                    <!-- Vulnerability cards will be dynamically loaded here -->
                </div>

                <!-- Vulnerability Pagination -->
                <div id="vulnPaginationContainer" class="row mt-3" style="display: none;">
                    <div class="col-12">
                        <nav aria-label="Vulnerability pagination">
                            <ul class="pagination justify-content-center" id="vulnPagination">
                                <!-- Pagination controls will be dynamically loaded here -->
                            </ul>
                        </nav>
                        <div class="text-center">
                            <small class="text-muted">Items per page: 
                                <select id="vulnItemsPerPage" class="form-select form-select-sm d-inline-block" style="width: auto;">
                                    <option value="12">12</option>
                                    <option value="24" selected>24</option>
                                    <option value="48">48</option>
                                    <option value="96">96</option>
                                </select>
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Table View -->
                <div id="tableContainer" style="display: none;">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="fas fa-table me-2"></i>Vulnerability Table View
                            </h6>
                            <div class="d-flex align-items-center">
                                <small class="text-muted me-3">Items per page:</small>
                                <select id="tableItemsPerPage" class="form-select form-select-sm" style="width: auto;">
                                    <option value="25">25</option>
                                    <option value="50" selected>50</option>
                                    <option value="100">100</option>
                                    <option value="200">200</option>
                                </select>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0" id="vulnerabilityTable">
                                    <thead class="table-dark">
                                        <tr>
                                            <th><i class="fas fa-server me-1"></i>Asset</th>
                                            <th><i class="fas fa-network-wired me-1"></i>IP Address</th>
                                            <th><i class="fas fa-shield-alt me-1"></i>CVE</th>
                                            <th><i class="fas fa-bug me-1"></i>Vulnerability</th>
                                            <th><i class="fas fa-exclamation-triangle me-1"></i>Severity</th>
                                            <th><i class="fas fa-chart-line me-1"></i>VPR Score</th>
                                            <th><i class="fas fa-industry me-1"></i>Vendor</th>
                                            <th><i class="fas fa-cogs me-1"></i>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tableBody">
                                        <!-- Table rows will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Table Pagination -->
                <div id="tablePaginationContainer" class="row mt-3" style="display: none;">
                    <div class="col-12">
                        <nav aria-label="Table pagination">
                            <ul class="pagination justify-content-center" id="tablePagination">
                                <!-- Pagination controls will be dynamically loaded here -->
                            </ul>
                        </nav>
                    </div>
                </div>

                <!-- Enhanced Footer Section -->
                <div class="row mt-4">
                    <div class="col-12">
                        <footer class="bg-gradient-to-r from-slate-50 to-blue-50 rounded-lg border shadow-sm">
                            <div class="card border-0 bg-transparent">
                                <div class="card-body py-4">
                                    <div class="row align-items-center">
                                        <!-- Status Information -->
                                        <div class="col-lg-6">
                                            <div class="d-flex align-items-center mb-3 mb-lg-0">
                                                <div class="bg-primary bg-opacity-10 rounded-circle p-2 me-3">
                                                    <i class="fas fa-database text-primary"></i>
                                                </div>
                                                <div>
                                                    <h6 class="mb-1 fw-bold text-dark">Data Status</h6>
                                                    <p class="mb-0 text-muted small" id="lastUploadInfo">No data uploaded yet</p>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Application Info -->
                                        <div class="col-lg-6 text-lg-end">
                                            <div class="d-flex align-items-center justify-content-lg-end">
                                                <div class="me-3">
                                                    <div class="d-flex align-items-center text-muted small">
                                                        <i class="fas fa-shield-alt text-primary me-2"></i>
                                                        <span class="fw-bold">HexTrackr</span>
                                                        <span class="mx-2">‚Ä¢</span>
                                                        <span>v2.3.0</span>
                                                        <span class="mx-2">‚Ä¢</span>
                                                        <span>¬© 2025</span>
                                                    </div>
                                                    <div class="text-muted small mt-1">
                                                        Vulnerability Management Dashboard
                                                    </div>
                                                </div>
                                                <div class="bg-success bg-opacity-10 rounded-circle p-2">
                                                    <i class="fas fa-heart text-success"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Quick Actions Bar -->
                                    <div class="row mt-3 pt-3 border-top border-light">
                                        <div class="col-12">
                                            <div class="d-flex flex-wrap gap-2 justify-content-center">
                                                <button id="footerSettingsButton" class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-cog me-1"></i>Settings
                                                </button>
                                                <a href="tickets.html" class="btn btn-sm btn-outline-success">
                                                    <i class="fas fa-ticket-alt me-1"></i>Tickets
                                                </a>
                                                <button id="footerExportButton" class="btn btn-sm btn-outline-info">
                                                    <i class="fas fa-download me-1"></i>Export
                                                </button>
                                                <button id="footerRefreshButton" class="btn btn-sm btn-outline-warning">
                                                    <i class="fas fa-sync-alt me-1"></i>Refresh
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </footer>
                    </div>
                </div>

                <!-- Data Management -->
                <div class="row mt-3">
                    <div class="col-12 text-center">
                        <button id="clearDataButton" class="btn btn-outline-danger">
                            <i class="fas fa-trash-alt me-2"></i>Clear All Data
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Asset Details Modal -->
    <div class="modal fade" id="assetModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Asset Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="assetModalBody">
                    <!-- Asset details will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Vulnerability Details Modal -->
    <div class="modal fade" id="vulnModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Vulnerability Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="vulnModalBody">
                    <!-- Vulnerability details will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Asset Modal -->
    <div class="modal fade" id="editAssetModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Asset</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editAssetForm">
                        <input type="hidden" id="editAssetOriginalHostname">
                        <div class="mb-3">
                            <label for="editAssetHostname" class="form-label">Hostname</label>
                            <input type="text" class="form-control" id="editAssetHostname" required>
                        </div>
                        <div class="mb-3">
                            <label for="editAssetIP" class="form-label">IP Address</label>
                            <input type="text" class="form-control" id="editAssetIP">
                        </div>
                        <div class="mb-3">
                            <label for="editAssetVendor" class="form-label">Vendor</label>
                            <input type="text" class="form-control" id="editAssetVendor">
                        </div>
                        <div class="mb-3">
                            <label for="editAssetRiskLevel" class="form-label">Risk Level</label>
                            <select class="form-select" id="editAssetRiskLevel">
                                <option value="critical">Critical</option>
                                <option value="high">High</option>
                                <option value="medium">Medium</option>
                                <option value="low">Low</option>
                                <option value="info">Info</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="editAssetNotes" class="form-label">Notes</label>
                            <textarea class="form-control" id="editAssetNotes" rows="3" placeholder="Asset notes, business criticality, etc."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success me-2" onclick="addAssetToTicketTracker()" title="Create work order for this asset">
                        <i class="fas fa-ticket-alt me-1"></i>Add to Ticket Tracker
                    </button>
                    <button type="button" class="btn btn-primary" onclick="saveAssetChanges()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Vulnerability Modal -->
    <div class="modal fade" id="editVulnModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Vulnerability</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editVulnForm">
                        <input type="hidden" id="editVulnOriginalId">
                        <div class="mb-3">
                            <label for="editVulnName" class="form-label">Vulnerability Name</label>
                            <input type="text" class="form-control" id="editVulnName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editVulnCVE" class="form-label">CVE</label>
                            <input type="text" class="form-control" id="editVulnCVE">
                        </div>
                        <div class="mb-3">
                            <label for="editVulnSeverity" class="form-label">Severity</label>
                            <select class="form-select" id="editVulnSeverity" required>
                                <option value="critical">Critical</option>
                                <option value="high">High</option>
                                <option value="medium">Medium</option>
                                <option value="low">Low</option>
                                <option value="info">Info</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="editVulnVPR" class="form-label">VPR Score</label>
                            <input type="number" class="form-control" id="editVulnVPR" min="0" max="10" step="0.1">
                        </div>
                        <div class="mb-3">
                            <label for="editVulnVendor" class="form-label">Vendor</label>
                            <input type="text" class="form-control" id="editVulnVendor">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <div class="me-auto">
                        <button type="button" class="btn btn-success" onclick="openHexagonTicket()">
                            <i class="fas fa-ticket-alt me-2"></i>Open Hexagon Ticket
                        </button>
                    </div>
                    <div>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="saveVulnChanges()">Save Changes</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tools & Settings Modal -->
    <div class="modal fade" id="toolsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-tools me-2"></i>Tools & Settings
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Nav tabs -->
                    <ul class="nav nav-tabs mb-4" id="toolsTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="api-tab" data-bs-toggle="tab" data-bs-target="#api-pane" type="button" role="tab">
                                <i class="fas fa-plug me-2"></i>API Connections
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <!-- DISABLED: Database functionality removed -->
                            <button class="nav-link text-gray-400 cursor-not-allowed" disabled>
                                <i class="fas fa-server me-2 text-gray-400"></i>Server Storage (Disabled)
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="export-tab" data-bs-toggle="tab" data-bs-target="#export-pane" type="button" role="tab">
                                <i class="fas fa-download me-2"></i>Data Export
                            </button>
                        </li>
                    </ul>

                    <!-- Tab content -->
                    <div class="tab-content" id="toolsTabContent">
                        <!-- API Connections Tab -->
                        <div class="tab-pane fade show active" id="api-pane" role="tabpanel">
                            <div class="row">
                                <div class="col-md-6 mb-4">
                                    <div class="card">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0"><i class="fas fa-shield-alt me-2"></i>Cisco Security</h6>
                                            <div class="btn-group">
                                                <a href="https://developer.cisco.com/site/devnet-oauth/" 
                                                   target="_blank" 
                                                   class="btn btn-outline-primary btn-sm"
                                                   title="Get Cisco API Keys">
                                                    <i class="fas fa-key me-1"></i>Get API Key
                                                </a>
                                                <a href="https://developer.cisco.com/docs/security-advisories/" 
                                                   target="_blank" 
                                                   class="btn btn-outline-info btn-sm"
                                                   title="View Cisco Security API Documentation">
                                                    <i class="fas fa-book me-1"></i>Docs
                                                </a>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <label for="ciscoApiKey" class="form-label">Client ID</label>
                                                <input type="text" class="form-control" id="ciscoApiKey" placeholder="Enter Cisco OAuth Client ID">
                                            </div>
                                            <div class="mb-3">
                                                <label for="ciscoSecret" class="form-label">Client Secret</label>
                                                <input type="password" class="form-control" id="ciscoSecret" placeholder="Enter OAuth Client Secret">
                                            </div>
                                            <div class="d-flex gap-2">
                                                <button class="btn btn-primary btn-sm" onclick="testCiscoAPI()">
                                                    <i class="fas fa-plug me-1"></i>Test Connection
                                                </button>
                                                <button class="btn btn-success btn-sm" onclick="syncCiscoAdvisories()">
                                                    <i class="fas fa-sync me-1"></i>Sync Advisories
                                                </button>
                                            </div>
                                            <div id="ciscoTestResult" class="mt-3" style="display: none;"></div>
                                            <div class="mt-2">
                                                <small class="text-muted">
                                                    <i class="fas fa-info-circle me-1"></i>
                                                    Enhanced with VPR scoring, documentation links, and rate limiting
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6><i class="fas fa-fire me-2"></i>Palo Alto Networks</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <label for="paloApiKey" class="form-label">API Key</label>
                                                <input type="password" class="form-control" id="paloApiKey" placeholder="Enter Palo Alto API key">
                                            </div>
                                            <div class="mb-3">
                                                <label for="paloHost" class="form-label">Host</label>
                                                <input type="text" class="form-control" id="paloHost" placeholder="firewall.company.com">
                                            </div>
                                            <button class="btn btn-primary btn-sm" onclick="testPaloAPI()">Test Connection</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6><i class="fas fa-bug me-2"></i>Tenable</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <label for="tenableApiKey" class="form-label">Access Key</label>
                                                <input type="password" class="form-control" id="tenableApiKey" placeholder="Enter Tenable access key">
                                            </div>
                                            <div class="mb-3">
                                                <label for="tenableSecret" class="form-label">Secret Key</label>
                                                <input type="password" class="form-control" id="tenableSecret" placeholder="Enter secret key">
                                            </div>
                                            <button class="btn btn-primary btn-sm" onclick="testTenableAPI()">Test Connection</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6><i class="fas fa-search me-2"></i>Qualys</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <label for="qualysUsername" class="form-label">Username</label>
                                                <input type="text" class="form-control" id="qualysUsername" placeholder="Enter Qualys username">
                                            </div>
                                            <div class="mb-3">
                                                <label for="qualysPassword" class="form-label">Password</label>
                                                <input type="password" class="form-control" id="qualysPassword" placeholder="Enter password">
                                            </div>
                                            <button class="btn btn-primary btn-sm" onclick="testQualysAPI()">Test Connection</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Database Settings Tab - DISABLED -->
                        <div class="tab-pane fade" id="database-pane" role="tabpanel">
                            <div class="row">
                                <div class="col-12">
                                    <div class="alert alert-warning" role="alert">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        <strong>Database Functionality Disabled</strong>
                                        <p class="mb-0 mt-2">All server storage, API connections, and external database features have been disabled for standalone operation. HexTrackr now operates entirely with browser localStorage for maximum stability and simplicity.</p>
                                    </div>
                                    <div class="card">
                                        <div class="card-header">
                                            <h6><i class="fas fa-laptop me-2"></i>Current Storage Configuration</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="alert alert-info" role="alert">
                                                <i class="fas fa-info-circle me-2"></i>
                                                <strong>Local Storage Active:</strong> Using browser localStorage for vulnerability data and ticket management.
                                            </div>
                                            <div class="mb-2">
                                                <strong>Type:</strong> <span class="badge bg-primary">Browser localStorage</span>
                                            </div>
                                            <div class="mb-2">
                                                <strong>Status:</strong> <span class="badge bg-success">Active</span>
                                            </div>
                                            <div class="mb-2">
                                                <strong>External APIs:</strong> <span class="badge bg-secondary">Disabled</span>
                                            </div>
                                            <div class="mb-2">
                                                <strong>Database Servers:</strong> <span class="badge bg-secondary">Disabled</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Data Export Tab -->
                        <div class="tab-pane fade" id="export-pane" role="tabpanel">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6><i class="fas fa-download me-2"></i>Export Vulnerability Data</h6>
                                        </div>
                                        <div class="card-body">
                                            <button class="btn btn-outline-success w-100 mb-2" onclick="exportVulnerabilities('csv')">
                                                <i class="fas fa-file-csv me-2"></i>Export as CSV
                                            </button>
                                            <button class="btn btn-outline-primary w-100 mb-2" onclick="exportVulnerabilities('json')">
                                                <i class="fas fa-file-code me-2"></i>Export as JSON
                                            </button>
                                            <button class="btn btn-outline-info w-100" onclick="exportVulnerabilities('pdf')">
                                                <i class="fas fa-file-pdf me-2"></i>Export as PDF Report
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6><i class="fas fa-cog me-2"></i>System Tools</h6>
                                        </div>
                                        <div class="card-body">
                                            <button class="btn btn-outline-warning w-100 mb-2" onclick="clearVulnData()">
                                                <i class="fas fa-trash me-2"></i>Clear All Data
                                            </button>
                                            <!-- DEPRECATED: Turso backup/restore buttons moved to /deprecated folder
                                            <button class="btn btn-outline-info w-100 mb-2" onclick="backupToTurso()">
                                                <i class="fas fa-cloud-upload-alt me-2"></i>Backup to Cloud
                                            </button>
                                            <button class="btn btn-outline-secondary w-100" onclick="restoreFromTurso()">
                                                <i class="fas fa-cloud-download-alt me-2"></i>Restore from Cloud
                                            </button>
                                            -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-success" onclick="syncFromAPIs()">
                        <i class="fas fa-sync me-2"></i>Sync All Data
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Production Environment Configuration
        const PRODUCTION_MODE = true; // Set to false for development
        
        // Clear all sample data from localStorage in production mode
        function clearSampleDataFromStorage() {
            if (PRODUCTION_MODE) {
                localStorage.removeItem('hextrackr_vuln_data');
                localStorage.removeItem('vulnHistory');
                localStorage.removeItem('hextrackr_tickets');
                console.log('PRODUCTION MODE: Cleared all sample data from localStorage');
            }
        }
        
        // Global variables
        let vulnData = [];
        let historyData = JSON.parse(localStorage.getItem('vulnHistory') || '[]');
        let previousStats = null; // Track previous statistics for change indicators
        
        // Pagination variables
        let currentAssetPage = 1;
        let currentVulnPage = 1;
        let currentTablePage = 1;
        let assetItemsPerPage = 24;
        let vulnItemsPerPage = 24;
        let tableItemsPerPage = 50;
        let currentAssetData = [];
        let currentVulnGroupData = [];
        let filteredData = [];

        // Search and filter state
        let searchTerm = '';
        let severityFilter = '';

        // Initialize the application
        document.addEventListener('DOMContentLoaded', async function() {
            // PRODUCTION: Clear sample data from localStorage first
            clearSampleDataFromStorage();
            
            setupEventListeners();
            initializeSortable();
            loadExistingData();
            
            // Check for device filter from tickets page
            checkForDeviceFilter();
            
            // Load real data from API instead of sample data
            try {
                await loadVulnerabilitiesFromAPI();
                if (!window.vulnData || window.vulnData.length === 0) {
                    console.log('No data from API, PRODUCTION MODE: Not loading sample data');
                    // loadSampleData(); // DISABLED FOR PRODUCTION
                }
            } catch (error) {
                console.error('Failed to load data from API:', error);
                console.log('PRODUCTION MODE: Not loading sample data fallback');
                // loadSampleData(); // DISABLED FOR PRODUCTION
            }
        });

        function setupEventListeners() {
            // Secure event listeners to replace inline onclick handlers
            
            // Header buttons
            const toolsButton = document.getElementById('toolsButton');
            if (toolsButton) toolsButton.addEventListener('click', showToolsModal);
            
            const uploadCsvButton = document.getElementById('uploadCsvButton');
            if (uploadCsvButton) uploadCsvButton.addEventListener('click', () => {
                // Set file input to accept CSV files
                const fileInput = document.getElementById('fileInput');
                fileInput.accept = '.csv';
                fileInput.click();
            });
            
            const uploadJsonButton = document.getElementById('uploadJsonButton');
            if (uploadJsonButton) uploadJsonButton.addEventListener('click', () => {
                // Set file input to accept JSON files
                const fileInput = document.getElementById('fileInput');
                fileInput.accept = '.json';
                fileInput.click();
            });
            
            const connectApisButton = document.getElementById('connectApisButton');
            // DISABLED: API connections removed - button is now disabled
            if (connectApisButton) {
                connectApisButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    alert('API connections have been disabled for standalone operation. HexTrackr now runs entirely on local storage.');
                });
            }
            
            const selectFileButton = document.getElementById('selectFileButton');
            if (selectFileButton) selectFileButton.addEventListener('click', () => document.getElementById('fileInput').click());
            
            // Vulnerability severity cards
            const criticalCard = document.getElementById('criticalCard');
            if (criticalCard) criticalCard.addEventListener('click', () => filterBySeverity('critical'));
            
            const highCard = document.getElementById('highCard');
            if (highCard) highCard.addEventListener('click', () => filterBySeverity('high'));
            
            const mediumCard = document.getElementById('mediumCard');
            if (mediumCard) mediumCard.addEventListener('click', () => filterBySeverity('medium'));
            
            const lowCard = document.getElementById('lowCard');
            if (lowCard) lowCard.addEventListener('click', () => filterBySeverity('low'));
            
            // Action buttons
            const refreshButton = document.getElementById('refreshButton');
            if (refreshButton) refreshButton.addEventListener('click', refreshData);
            
            const clearDataButton = document.getElementById('clearDataButton');
            if (clearDataButton) clearDataButton.addEventListener('click', clearVulnData);

            // Footer buttons
            const footerSettingsButton = document.getElementById('footerSettingsButton');
            if (footerSettingsButton) footerSettingsButton.addEventListener('click', showToolsModal);
            
            const footerExportButton = document.getElementById('footerExportButton');
            if (footerExportButton) footerExportButton.addEventListener('click', exportData);
            
            const footerRefreshButton = document.getElementById('footerRefreshButton');
            if (footerRefreshButton) footerRefreshButton.addEventListener('click', refreshData);

            // Dropdown menu buttons (now simplified direct buttons)
            const exportButton = document.getElementById('exportButton');
            if (exportButton) exportButton.addEventListener('click', exportData);
            
            const settingsButton = document.getElementById('settingsButton');
            if (settingsButton) settingsButton.addEventListener('click', showToolsModal);

            // Remove old dropdown button references since we simplified the UI

            // File upload handlers
            const fileInput = document.getElementById('fileInput');
            const uploadArea = document.getElementById('uploadArea');

            fileInput.addEventListener('change', handleFileUpload);
            
            // Drag and drop
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    fileInput.files = files;
                    handleFileUpload({ target: { files } });
                }
            });

            // View mode toggles
            document.querySelectorAll('input[name="viewMode"]').forEach(radio => {
                radio.addEventListener('change', updateCardViews);
            });

            // Sort dropdown - check if element exists
            const sortSelect = document.getElementById('sortSelect');
            if (sortSelect) {
                sortSelect.addEventListener('change', updateCardViews);
            }
            
            // Pagination event listeners
            document.getElementById('assetItemsPerPage').addEventListener('change', function() {
                assetItemsPerPage = parseInt(this.value);
                currentAssetPage = 1;
                updateAssetCards();
            });
            
            document.getElementById('vulnItemsPerPage').addEventListener('change', function() {
                vulnItemsPerPage = parseInt(this.value);
                currentVulnPage = 1;
                updateVulnCards();
            });

            // Search functionality
            document.getElementById('searchInput').addEventListener('input', function() {
                filterAndDisplayData();
            });

            document.getElementById('clearSearch').addEventListener('click', function() {
                document.getElementById('searchInput').value = '';
                filterAndDisplayData();
            });

            // Filter functionality
            document.getElementById('severityFilter').addEventListener('change', function() {
                filterAndDisplayData();
            });

            // Table pagination
            document.getElementById('tableItemsPerPage').addEventListener('change', function() {
                tableItemsPerPage = parseInt(this.value);
                currentTablePage = 1;
                updateTableView();
            });

            // Event delegation for dynamically created buttons
            document.addEventListener('click', function(e) {
                // Asset card action buttons
                if (e.target.closest('.asset-edit-btn')) {
                    const hostname = e.target.closest('.asset-edit-btn').dataset.assetHostname;
                    editAsset(hostname);
                } else if (e.target.closest('.asset-delete-btn')) {
                    const hostname = e.target.closest('.asset-delete-btn').dataset.assetHostname;
                    deleteAsset(hostname);
                } else if (e.target.closest('.asset-card-body')) {
                    const hostname = e.target.closest('.asset-card-body').dataset.assetHostname;
                    showAssetDetails(hostname);
                } else if (e.target.closest('.asset-header')) {
                    const hostname = e.target.closest('.asset-header').dataset.assetHostname;
                    showAssetDetails(hostname);
                }
                
                // Vulnerability card action buttons
                else if (e.target.closest('.vuln-edit-btn')) {
                    const vulnId = e.target.closest('.vuln-edit-btn').dataset.vulnId;
                    editVulnerability(vulnId);
                } else if (e.target.closest('.vuln-delete-btn')) {
                    const vulnId = e.target.closest('.vuln-delete-btn').dataset.vulnId;
                    deleteVulnerability(vulnId);
                } else if (e.target.closest('.vuln-card-body')) {
                    const vulnId = e.target.closest('.vuln-card-body').dataset.vulnId;
                    const vulnName = e.target.closest('.vuln-card-body').dataset.vulnName;
                    showVulnDetails(vulnId, vulnName);
                }
                
                // Table action buttons
                else if (e.target.closest('.table-edit-btn')) {
                    const vulnId = e.target.closest('.table-edit-btn').dataset.vulnId;
                    editVulnerability(vulnId);
                } else if (e.target.closest('.table-view-btn')) {
                    const vulnId = e.target.closest('.table-view-btn').dataset.vulnId;
                    const vulnName = e.target.closest('.table-view-btn').dataset.vulnName;
                    showVulnDetails(vulnId, vulnName);
                } else if (e.target.closest('.table-delete-btn')) {
                    const vulnId = e.target.closest('.table-delete-btn').dataset.vulnId;
                    deleteVulnerability(vulnId);
                }
            });
        }

        // Simple client-side CSV processing (Primary method - user data as source of truth)
        async function processFileSimple(file) {
            try {
                console.log(`üìÅ Processing file: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`);
                
                // Show upload progress
                showUploadProgress(file.name, file.size);
                
                // Parse CSV using PapaParse
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        console.log(`üìä CSV parsing completed: ${results.data.length} records`);
                        
                        if (results.errors && results.errors.length > 0) {
                            console.warn('‚ö†Ô∏è CSV parsing warnings:', results.errors.slice(0, 5));
                        }
                        
                        if (!results.data || results.data.length === 0) {
                            hideUploadProgress();
                            alert('No data found in CSV file');
                            return;
                        }
                        
                        // Process the CSV data
                        processVulnerabilityData(results.data, file.name);
                    },
                    error: function(error) {
                        console.error('‚ùå CSV parsing error:', error);
                        hideUploadProgress();
                        alert(`Failed to parse CSV: ${error.message}`);
                    }
                });
                
            } catch (error) {
                console.error('‚ùå File processing failed:', error);
                hideUploadProgress();
                alert(`Failed to process file: ${error.message}`);
            }
        }

        // Process parsed vulnerability data from CSV
        function processVulnerabilityData(data, fileName) {
            console.log(`üîÑ Processing ${data.length} vulnerability records from ${fileName}`);
            
            // Convert CSV data to our internal format
            const vulnerabilities = data.map((row, index) => {
                // Handle your CSV format with definition.vpr.score
                const vprScore = parseFloat(row['definition.vpr.score']) || 0;
                const cvssScore = parseFloat(row['definition.cvss.score']) || 0;
                
                return {
                    id: `csv_${Date.now()}_${index}`,
                    cve_id: row['definition.cve'] || row['cve'] || `CISCO-${Date.now()}-${index}`,
                    title: row['definition.title'] || row['title'] || 'Unknown Vulnerability',
                    description: row['definition.description'] || row['description'] || 'No description available',
                    severity: row['definition.severity'] || row['severity'] || 'medium',
                    vpr_score: vprScore,
                    cvss_score: cvssScore,
                    vendor: 'Cisco', // Since this is Cisco data
                    affected_products: row['definition.affectedProducts'] || row['affected_products'] || 'Unknown',
                    source: 'CSV Import',
                    imported_date: new Date().toISOString(),
                    file_source: fileName
                };
            });
            
            console.log(`‚úÖ Converted ${vulnerabilities.length} vulnerabilities`);
            console.log('Sample vulnerability:', vulnerabilities[0]);
            
            // Store in localStorage for persistence
            storeVulnerabilityData(vulnerabilities, fileName);
            
            // Calculate and update statistics
            const stats = calculateStatistics(vulnerabilities);
            updateStatCards(stats);
            
            // Update data status
            updateDataStatus(`${vulnerabilities.length} vulnerabilities loaded from ${fileName}`);
            
            // Hide progress and show success
            hideUploadProgress();
            showToast(`‚úÖ Successfully imported ${vulnerabilities.length} vulnerabilities!`, 'success');
            
            // Store for historical tracking
            saveHistoricalData(stats);
        }

        // Store vulnerability data in localStorage
        function storeVulnerabilityData(vulnerabilities, source) {
            try {
                const existingData = JSON.parse(localStorage.getItem('hextrackr_vulnerabilities') || '[]');
                
                // Add source information and merge
                const newData = vulnerabilities.map(v => ({...v, import_source: source}));
                const mergedData = [...existingData, ...newData];
                
                // Store back
                localStorage.setItem('hextrackr_vulnerabilities', JSON.stringify(mergedData));
                localStorage.setItem('hextrackr_last_import', new Date().toISOString());
                localStorage.setItem('hextrackr_total_count', mergedData.length);
                
                console.log(`üíæ Stored ${mergedData.length} total vulnerabilities in localStorage`);
                
                // Also update global vulnData for immediate use
                window.vulnData = mergedData;
                
            } catch (error) {
                console.error('‚ùå Failed to store vulnerability data:', error);
            }
        }

        // Enhanced file processing with PostgreSQL backend support
        async function processFile(file) {
            try {
                console.log(`üìÅ Processing file: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`);
                
                // Always use the API upload for all files (PostgreSQL backend)
                await uploadCsvToAPI(file);
                
            } catch (error) {
                console.error('‚ùå File processing failed:', error);
                hideUploadProgress();
                alert(`Failed to process file: ${error.message}`);
            }
        }

        // Process large CSV via PostgreSQL API - DISABLED
        async function processLargeCsvViaAPI(file) {
            alert('Server API functionality has been disabled. Using local CSV processing instead.');
            return processFileSimple(file);
        }

        // Upload CSV file to API for processing - DISABLED
        async function uploadCsvToAPI(file) {
            alert('Server API functionality has been disabled. Using local CSV processing instead.');
            return processFileSimple(file);
        }

        // Load vulnerabilities from PostgreSQL API - DISABLED
        async function loadVulnerabilitiesFromAPI() {
            console.log('üìä API database loading disabled - using localStorage');
            return; // No longer loads from server
        }

        // Load vulnerability statistics from API - DISABLED
        async function loadVulnerabilityStatsFromAPI() {
            console.log('üìä API statistics loading disabled - using local calculation');
            return; // No longer loads from server
        }

        // Update dashboard statistics display
        function updateDashboardStats(stats) {
            // Update the dashboard counters with real data
            const totalElement = document.querySelector('[data-stat="total"]');
            const criticalElement = document.querySelector('[data-stat="critical"]');
            const highElement = document.querySelector('[data-stat="high"]');
            const openElement = document.querySelector('[data-stat="open"]');
            
            if (totalElement) totalElement.textContent = stats.total || 0;
            if (criticalElement) criticalElement.textContent = stats.critical || 0;
            if (highElement) highElement.textContent = stats.high || 0;
            if (openElement) openElement.textContent = stats.open || 0;
        }

        function handleFileUpload(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            console.log(`üìÅ Processing ${files.length} file(s) for CSV import...`);
            
            Array.from(files).forEach(async file => {
                // Use simple client-side processing as primary method
                await processFileSimple(file);
            });
        }

        // Process file using server-side API
        async function processFileClientSide(file) {
            console.log(`üìÅ Processing file: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`);
            
            // Show upload progress modal
            showUploadProgress(file.name, file.size);
            
            // Use FormData to upload file to server API
            const formData = new FormData();
            formData.append('csvFile', file);
            formData.append('csvType', 'vulnerabilities');
            
            try {
                const response = await fetch('/api/import/upload-csv', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`Upload failed: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log(`‚úÖ File processed successfully: ${result.recordsProcessed} records`);
                
                // Hide progress modal and refresh data
                hideUploadProgress();
                await loadVulnerabilitiesFromAPI();
                showToast('‚úÖ File uploaded successfully!', 'success');
                
            } catch (error) {
                console.error('‚ùå Upload error:', error);
                hideUploadProgress();
                showToast(`‚ùå Upload failed: ${error.message}`, 'error');
            }
        }

        // Legacy client-side processing for backup (commented out)
        /*
        async function processFileClientSideOld(file) {
            console.log(`üìÅ Processing file: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`);
            
            // Show upload progress modal
            showUploadProgress(file.name, file.size);
            
            // For client-side processing, we can parse the entire file at once
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: async function(results) {
                    console.log(`üìä CSV parsing completed: ${results.data.length} records`);
                    
                    if (results.errors && results.errors.length > 0) {
                        console.warn('‚ö†Ô∏è CSV parsing warnings:', results.errors);
                    }
                    
                    if (!results.data || results.data.length === 0) {
                        hideUploadProgress();
                        alert('No data found in CSV file');
                        return;
                    }
                    
                    try {
                        // Map CSV data to our format
                        console.log('üîÑ Mapping CSV data...');
                        updateUploadProgress(20, 'Mapping CSV data...');
                        
                        const mappedData = results.data.map(row => mapCSVRow(row, file));
                        
                        console.log(`üíæ Saving ${mappedData.length} records to SQLite...`);
                        updateUploadProgress(40, 'Saving to database...');
                        
                        // Use optimized bulk insert with progress callback
                        await window.sqliteService.bulkInsertVulnerabilities(mappedData, (progress, batch, total) => {
                            const overallProgress = 40 + (progress * 0.6); // 40% + 60% for database
                            updateUploadProgress(overallProgress, `Saving batch ${batch}/${total}...`);
                        });
                        
                        console.log('‚úÖ Upload completed successfully');
                        hideUploadProgress();
                        loadExistingData();
                        
                    } catch (error) {
                        console.error('‚ùå Failed to process CSV:', error);
                        hideUploadProgress();
                        alert(`Error processing CSV: ${error.message}`);
                    }
                },
                error: function(error) {
                    console.error('Error parsing CSV:', error);
                    hideUploadProgress();
                    alert('Error parsing CSV file: ' + error.message);
                }
            });
        }
        */

        function processWithLocalStorage(file) {
            // Fallback to original localStorage method for smaller files
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    if (results.data.length > 10000) {
                        alert('‚ö†Ô∏è File too large for localStorage. Please use a smaller dataset or enable SQLite.');
                        return;
                    }
                    processVulnData(results.data, file);
                },
                error: function(error) {
                    console.error('Error parsing CSV:', error);
                    alert('Error parsing CSV file: ' + error.message);
                }
            });
        }

        function mapCSVRow(row, file) {
            // Enhanced date extraction from filename with multiple patterns
            let fileDate = new Date();
            let fileSource = file.name;
            
            // Try multiple date patterns that your boss might use
            const datePatterns = [
                /(\d{4}[-_]\d{2}[-_]\d{2})/,           // 2025-08-19 or 2025_08_19
                /(\d{2}[-_]\d{2}[-_]\d{4})/,           // 08-19-2025 or 08_19_2025
                /(\d{4}\d{2}\d{2})/,                   // 20250819
                /(\d{2}\d{2}\d{4})/,                   // 08192025
                /(\w{3}[-_]\d{1,2}[-_]\d{4})/,        // Aug-19-2025
                /(\d{1,2}[-_]\w{3}[-_]\d{4})/         // 19-Aug-2025
            ];
            
            for (const pattern of datePatterns) {
                const dateMatch = file.name.match(pattern);
                if (dateMatch) {
                    let dateStr = dateMatch[1];
                    
                    // Normalize the date string
                    if (dateStr.includes('_')) {
                        dateStr = dateStr.replace(/_/g, '-');
                    }
                    
                    // Handle different formats
                    if (/^\d{8}$/.test(dateStr)) {
                        // Format: 20250819 -> 2025-08-19
                        dateStr = dateStr.replace(/(\d{4})(\d{2})(\d{2})/, '$1-$2-$3');
                    } else if (/^\d{2}\d{2}\d{4}$/.test(dateStr)) {
                        // Format: 08192025 -> 2025-08-19
                        dateStr = dateStr.replace(/(\d{2})(\d{2})(\d{4})/, '$3-$1-$2');
                    } else if (/^\d{2}-\d{2}-\d{4}$/.test(dateStr)) {
                        // Format: 08-19-2025 -> 2025-08-19
                        const parts = dateStr.split('-');
                        dateStr = `${parts[2]}-${parts[0]}-${parts[1]}`;
                    }
                    
                    try {
                        const parsedDate = new Date(dateStr);
                        if (!isNaN(parsedDate.getTime())) {
                            fileDate = parsedDate;
                            console.log(`üìÖ Extracted date from filename: ${dateStr} -> ${fileDate.toISOString()}`);
                            break;
                        }
                    } catch (e) {
                        console.warn(`‚ö†Ô∏è Failed to parse date: ${dateStr}`);
                    }
                }
            }
            
            // If no date found in filename, use file modification time if available
            if (!file.name.match(/\d{4}|\d{2}/) && file.lastModified) {
                fileDate = new Date(file.lastModified);
                console.log(`üìÖ Using file modification date: ${fileDate.toISOString()}`);
            }

            // Map common column variations to our standard format
            const mappedRow = {};
            
            // Hostname mapping - specific to your Cisco CSV format
            mappedRow.hostname = row['asset.name'] || row.hostname || row.asset_name || row.host || row.target || '';
            
            // IP Address mapping - specific to your Cisco CSV format
            mappedRow.ipAddress = row['asset.display_ipv4_address'] || row.ip || row.ip_address || row.target_ip || row.asset_ip || '';
            
            // Vendor mapping - specific to your Cisco CSV format
            mappedRow.vendor = row['definition.family'] || row.vendor || row.family || row.plugin_family || row.scanner || 'Unknown';
            
            // Vulnerability ID mapping - specific to your Cisco CSV format
            mappedRow.definitionId = row['definition.id'] || row.plugin_id || row.vuln_id || row.id || '';
            
            // CVE mapping - specific to your Cisco CSV format
            mappedRow.cve = row['definition.cve'] || row.cve || row.cve_id || '';
            
            // Vulnerability name mapping - specific to your Cisco CSV format
            mappedRow.definitionName = row['definition.name'] || row.title || row.name || row.description || row.plugin_name || '';
            
            // Severity mapping
            let severity = row.severity || row['severity'] || row.risk || row.threat_level || 'Unknown';
            severity = severity.toString().toLowerCase();
            
            // Normalize severity values
            if (severity.includes('critical') || severity.includes('4')) severity = 'critical';
            else if (severity.includes('high') || severity.includes('3')) severity = 'high';
            else if (severity.includes('medium') || severity.includes('2') || severity.includes('med')) severity = 'medium';
            else if (severity.includes('low') || severity.includes('1')) severity = 'low';
            else if (severity.includes('info') || severity.includes('0')) severity = 'info';
            
            mappedRow.severity = severity;
            
            // VPR Score mapping - specific to your Cisco CSV format
            let vprScore = row['definition.vpr.score'] || row.vpr_score || row.vpr || row.cvss_score || row.cvss || 0;
            mappedRow.vprScore = parseFloat(vprScore) || 0;
            
            // State mapping
            mappedRow.state = row.state || row.status || 'ACTIVE';
            
            // Date and source mapping
            mappedRow.scan_date = fileDate.toISOString();
            mappedRow.date = fileDate.toLocaleDateString();
            mappedRow.fileSource = fileSource;
            
            return mappedRow;
        }

        function showUploadProgress(filename, fileSize) {
            const progressHtml = `
                <div id="uploadProgressModal" class="modal fade show" style="display: block;">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-upload me-2"></i>Uploading Large Dataset
                                </h5>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <strong>File:</strong> ${filename}<br>
                                    <strong>Size:</strong> ${(fileSize / 1024 / 1024).toFixed(2)} MB
                                </div>
                                <div class="progress mb-3">
                                    <div id="uploadProgressBar" class="progress-bar" style="width: 0%"></div>
                                </div>
                                <div id="uploadStatus" class="text-muted">Initializing upload...</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-backdrop fade show"></div>
            `;
            document.body.insertAdjacentHTML('beforeend', progressHtml);
        }

        function updateUploadProgress(processed, status = '') {
            const progressBar = document.getElementById('uploadProgressBar');
            const statusDiv = document.getElementById('uploadStatus');
            
            if (progressBar) {
                const percentage = Math.min(100, Math.round((processed / 100000) * 100)); // Estimate
                progressBar.style.width = percentage + '%';
                progressBar.textContent = percentage + '%';
            }
            
            if (statusDiv) {
                statusDiv.textContent = status || `Processed ${processed.toLocaleString()} records...`;
            }
        }

        function hideUploadProgress() {
            const modal = document.getElementById('uploadProgressModal');
            const backdrop = document.querySelector('.modal-backdrop');
            if (modal) modal.remove();
            if (backdrop) backdrop.remove();
        }

        function processVulnData(data, file) {
            console.log('Processing vulnerability data from file:', file.name);
            console.log('Raw CSV data sample:', data.slice(0, 3));
            console.log('CSV Headers found:', Object.keys(data[0] || {}));
            
            if (!data || data.length === 0) {
                alert('No data found in CSV file');
                return;
            }

            // Check if this is a very large file that needs batch processing
            if (data.length > 5000) {
                processBatchVulnData(data, file);
                return;
            }

            // Extract date from filename or use current date
            let fileDate = new Date();
            const dateMatch = file.name.match(/(\d{4}[-_]\d{2}[-_]\d{2})/);
            if (dateMatch) {
                fileDate = new Date(dateMatch[1].replace(/_/g, '-'));
            }

            // Process each row with flexible column mapping
            const processedData = data.map((row, index) => {
                // Map common column variations to our standard format
                const mappedRow = {};
                
                // Hostname mapping - specific to your Cisco CSV format
                mappedRow.hostname = row['asset.name'] || row.hostname || row.asset_name || row.host || row.target || '';
                
                // IP Address mapping - specific to your Cisco CSV format
                mappedRow.ipAddress = row['asset.display_ipv4_address'] || row.ip || row.ip_address || row.target_ip || row.asset_ip || '';
                
                // Vendor mapping - specific to your Cisco CSV format
                mappedRow.vendor = row['definition.family'] || row.vendor || row.family || row.plugin_family || row.scanner || 'Unknown';
                
                // Vulnerability ID mapping - specific to your Cisco CSV format
                mappedRow.definitionId = row['definition.id'] || row.plugin_id || row.vuln_id || row.id || '';
                
                // CVE mapping - specific to your Cisco CSV format
                mappedRow.cve = row['definition.cve'] || row.cve || row.cve_id || '';
                
                // Vulnerability name mapping - specific to your Cisco CSV format
                mappedRow.definitionName = row['definition.name'] || row.title || row.name || row.description || row.plugin_name || '';
                
                // Severity mapping
                let severity = row.severity || row['severity'] || row.risk || row.threat_level || 'Unknown';
                severity = severity.toString().toLowerCase();
                
                // Normalize severity values
                if (severity.includes('critical') || severity.includes('4')) severity = 'critical';
                else if (severity.includes('high') || severity.includes('3')) severity = 'high';
                else if (severity.includes('medium') || severity.includes('2') || severity.includes('med')) severity = 'medium';
                else if (severity.includes('low') || severity.includes('1')) severity = 'low';
                else if (severity.includes('info') || severity.includes('0')) severity = 'info';
                
                mappedRow.severity = severity;
                
                // VPR Score mapping - specific to your Cisco CSV format
                let vprScore = row['definition.vpr.score'] || row.vpr_score || row.vpr || row.cvss_score || row.cvss || 0;
                mappedRow.vprScore = parseFloat(vprScore) || 0;
                
                // State mapping
                mappedRow.state = row.state || row.status || 'ACTIVE';
                
                // Date mapping
                mappedRow.date = fileDate.toLocaleDateString();
                
                // Debug log for first few rows
                if (index < 3) {
                    console.log(`Row ${index} mapping:`, {
                        original: row,
                        mapped: mappedRow
                    });
                }
                
                return mappedRow;
            }).filter(row => row.hostname && row.hostname.trim() !== ''); // Filter out rows without hostnames

            console.log('Processed data sample:', processedData.slice(0, 3));
            console.log('Total processed records:', processedData.length);
            
            if (processedData.length === 0) {
                alert('No valid vulnerability data found in CSV. Please check that the file has hostname data in columns like "asset.name", "hostname", or "host".');
                return;
            }

            // Add to existing data
            vulnData = [...vulnData, ...processedData];
            
            // Remove duplicates based on hostname + definitionId
            vulnData = vulnData.filter((item, index, self) => 
                index === self.findIndex(t => t.hostname === item.hostname && t.definitionId === item.definitionId)
            );

            // Calculate statistics and update displays
            const stats = calculateStatistics(vulnData, fileDate);
            updateStatCards(stats);
            updateCardViews();
            updateLastUploadInfo(file.name, fileDate, processedData.length);
            
            // Save to localStorage
            localStorage.setItem('hextrackr_vuln_data', JSON.stringify(vulnData));
            
            // Save to history
            saveToHistory(file.name, fileDate, stats);
            
            // Show trend chart section if we have data
            if (vulnData.length > 0) {
                document.getElementById('uploadArea').style.display = 'none';
                document.getElementById('trendChartSection').style.display = 'block';
                // Update trend chart after a short delay to ensure DOM is ready
                setTimeout(updateTrendChart, 100);
            }
            
            alert(`Successfully processed ${processedData.length} vulnerability records!`);
        }

        function processBatchVulnData(data, file) {
            console.log(`Processing large CSV file with ${data.length} rows in batches...`);
            
            // SAFEGUARD 1: Maximum record limit (100K records for browser stability)
            const MAX_RECORDS = 100000;
            if (data.length > MAX_RECORDS) {
                if (!confirm(`This file contains ${data.length.toLocaleString()} records. For optimal performance, we recommend processing only the first ${MAX_RECORDS.toLocaleString()} records. This will include the most recent vulnerabilities.\n\nProceed with ${MAX_RECORDS.toLocaleString()} records?`)) {
                    return;
                }
                data = data.slice(0, MAX_RECORDS);
                console.log(`Truncated to ${MAX_RECORDS.toLocaleString()} records for processing`);
            }

            // SAFEGUARD 2: Check available storage space
            function checkStorageQuota() {
                try {
                    // Estimate storage needed (rough calculation: ~500 bytes per record after optimization)
                    const estimatedSize = data.length * 500;
                    const currentUsage = JSON.stringify(localStorage).length;
                    const availableSpace = 5 * 1024 * 1024 - currentUsage; // 5MB typical localStorage limit
                    
                    if (estimatedSize > availableSpace) {
                        console.warn(`Estimated storage needed: ${(estimatedSize/1024/1024).toFixed(1)}MB, Available: ${(availableSpace/1024/1024).toFixed(1)}MB`);
                        return false;
                    }
                    return true;
                } catch (e) {
                    console.warn('Could not check storage quota:', e);
                    return true; // Proceed anyway
                }
            }

            if (!checkStorageQuota()) {
                alert('Warning: This file may exceed browser storage limits. Consider using a smaller dataset or clearing existing data first.');
            }
            
            // Show progress modal
            const progressModal = document.createElement('div');
            progressModal.innerHTML = `
                <div class="modal fade" id="progressModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Processing Large CSV File</h5>
                            </div>
                            <div class="modal-body">
                                <p>Processing ${data.length.toLocaleString()} vulnerability records...</p>
                                <div class="progress mb-3">
                                    <div class="progress-bar" role="progressbar" style="width: 0%" id="progressBar"></div>
                                </div>
                                <p class="text-muted small">This may take a few moments for large files.</p>
                                <div id="progressStatus">Initializing...</div>
                                <div id="memoryStatus" class="text-muted small mt-2"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(progressModal);
            const modal = new bootstrap.Modal(document.getElementById('progressModal'));
            modal.show();

            // Extract date from filename or use current date
            let fileDate = new Date();
            const dateMatch = file.name.match(/(\d{4}[-_]\d{2}[-_]\d{2})/);
            if (dateMatch) {
                fileDate = new Date(dateMatch[1].replace(/_/g, '-'));
            }

            const batchSize = 1000; // Process 1000 rows at a time
            let currentBatch = 0;
            const totalBatches = Math.ceil(data.length / batchSize);
            let allProcessedData = [];

            function processBatch() {
                const startIndex = currentBatch * batchSize;
                const endIndex = Math.min(startIndex + batchSize, data.length);
                const batchData = data.slice(startIndex, endIndex);

                // Update progress
                const progress = Math.round((currentBatch / totalBatches) * 100);
                document.getElementById('progressBar').style.width = progress + '%';
                document.getElementById('progressStatus').textContent = `Processing batch ${currentBatch + 1} of ${totalBatches} (rows ${startIndex + 1}-${endIndex})`;

                // SAFEGUARD 4: Memory monitoring
                if (performance && performance.memory) {
                    const memUsed = (performance.memory.usedJSHeapSize / 1024 / 1024).toFixed(1);
                    const memLimit = (performance.memory.jsHeapSizeLimit / 1024 / 1024).toFixed(1);
                    document.getElementById('memoryStatus').textContent = `Memory: ${memUsed}MB / ${memLimit}MB`;
                    
                    // Warning if memory usage is getting high
                    if (performance.memory.usedJSHeapSize / performance.memory.jsHeapSizeLimit > 0.8) {
                        console.warn('High memory usage detected:', memUsed + 'MB');
                    }
                }

                // Process this batch
                const processedBatch = batchData.map((row, index) => {
                    const mappedRow = {};
                    
                    // Essential fields only - filter out verbose descriptions and unnecessary data
                    mappedRow.hostname = row['asset.name'] || row.hostname || row.asset_name || row.host || row.target || '';
                    mappedRow.ipAddress = row['asset.display_ipv4_address'] || row.ip || row.ip_address || row.target_ip || row.asset_ip || '';
                    mappedRow.vendor = row['definition.family'] || row.vendor || row.family || row.plugin_family || row.scanner || 'Unknown';
                    mappedRow.definitionId = row['definition.id'] || row.plugin_id || row.vuln_id || row.id || '';
                    mappedRow.cve = row['definition.cve'] || row.cve || row.cve_id || '';
                    
                    // Keep vulnerability name short - truncate if too long
                    let vulnName = row['definition.name'] || row.title || row.name || row.plugin_name || '';
                    if (vulnName.length > 100) {
                        vulnName = vulnName.substring(0, 97) + '...';
                    }
                    mappedRow.definitionName = vulnName;
                    
                    // Severity mapping
                    let severity = row.severity || row['severity'] || row.risk || row.threat_level || 'Unknown';
                    severity = severity.toString().toLowerCase();
                    
                    if (severity.includes('critical') || severity.includes('4')) severity = 'critical';
                    else if (severity.includes('high') || severity.includes('3')) severity = 'high';
                    else if (severity.includes('medium') || severity.includes('2') || severity.includes('med')) severity = 'medium';
                    else if (severity.includes('low') || severity.includes('1')) severity = 'low';
                    else if (severity.includes('info') || severity.includes('0')) severity = 'info';
                    
                    mappedRow.severity = severity;
                    
                    // VPR Score - essential for prioritization
                    let vprScore = row['definition.vpr.score'] || row.vpr_score || row.vpr || row.cvss_score || row.cvss || 0;
                    mappedRow.vprScore = parseFloat(vprScore) || 0;
                    
                    // State and date - keep minimal
                    mappedRow.state = row.state || row.status || 'ACTIVE';
                    mappedRow.date = fileDate.toLocaleDateString();
                    
                    // Create unique ID for deduplication
                    mappedRow.vulnId = `${mappedRow.hostname}-${mappedRow.definitionId}-${Date.now()}-${startIndex + index}`;
                    
                    // Skip any verbose description fields, age fields, or other non-essential data
                    // These can be fetched via API when needed for detailed views
                    
                    return mappedRow;
                }).filter(row => row.hostname && row.hostname.trim() !== '');

                allProcessedData = allProcessedData.concat(processedBatch);
                currentBatch++;

                if (currentBatch < totalBatches) {
                    // Process next batch after a small delay to keep UI responsive
                    setTimeout(processBatch, 10);
                } else {
                    // All batches processed
                    finalizeBatchProcessing();
                }
            }

            function finalizeBatchProcessing() {
                document.getElementById('progressStatus').textContent = 'Finalizing data...';
                document.getElementById('progressBar').style.width = '100%';

                console.log(`Processed ${allProcessedData.length} records from ${data.length} rows`);

                try {
                    // Use Map for efficient deduplication
                    const uniqueData = new Map();
                    
                    // Add existing data first
                    vulnData.forEach(item => {
                        const key = `${item.hostname}-${item.definitionId}`;
                        uniqueData.set(key, item);
                    });
                    
                    // Add new data, replacing older entries
                    allProcessedData.forEach(item => {
                        const key = `${item.hostname}-${item.definitionId}`;
                        const existing = uniqueData.get(key);
                        
                        if (!existing || new Date(existing.date) < new Date(item.date)) {
                            uniqueData.set(key, item);
                        }
                    });

                    vulnData = Array.from(uniqueData.values());
                    console.log(`Final dataset: ${vulnData.length} unique vulnerabilities`);

                    // Calculate statistics and update displays
                    const stats = calculateStatistics(vulnData, fileDate);
                    updateStatCards(stats);
                    filterAndDisplayData(); // Use filterAndDisplayData instead of updateCardViews
                    updateLastUploadInfo(file.name, fileDate, allProcessedData.length);
                    
                    // SAFEGUARD 3: Try to save to localStorage with quota error handling
                    document.getElementById('progressStatus').textContent = 'Saving data...';
                    try {
                        localStorage.setItem('hextrackr_vuln_data', JSON.stringify(vulnData));
                        console.log('Data saved successfully to localStorage');
                    } catch (storageError) {
                        console.error('Storage quota exceeded:', storageError);
                        
                        // Try to free up space by removing old data
                        try {
                            localStorage.removeItem('hextrackr_vuln_history');
                            localStorage.setItem('hextrackr_vuln_data', JSON.stringify(vulnData));
                            console.log('Saved after clearing history data');
                        } catch (secondError) {
                            console.error('Still unable to save:', secondError);
                            
                            // Last resort: Save only the most critical/recent data
                            try {
                                const reducedData = vulnData
                                    .filter(item => item.severity === 'Critical' || item.severity === 'High')
                                    .slice(0, 50000); // Limit to 50K most critical vulnerabilities
                                
                                localStorage.setItem('hextrackr_vuln_data', JSON.stringify(reducedData));
                                
                                alert(`Storage quota exceeded! Saved only ${reducedData.length} Critical/High severity vulnerabilities out of ${vulnData.length} total records. Consider exporting data or using a smaller dataset.`);
                                vulnData = reducedData; // Update in-memory data to match saved data
                            } catch (finalError) {
                                console.error('Unable to save any data:', finalError);
                                alert('Storage quota exceeded and unable to save data. Please clear browser storage or use a smaller dataset.');
                                throw finalError;
                            }
                        }
                    }
                    
                    // Save to history (skip if storage issues)
                    try {
                        saveToHistory(file.name, fileDate, stats);
                    } catch (historyError) {
                        console.warn('Could not save to history:', historyError);
                    }
                    
                    // Show trend chart section
                    if (vulnData.length > 0) {
                        document.getElementById('uploadArea').style.display = 'none';
                        document.getElementById('trendChartSection').style.display = 'block';
                        setTimeout(updateTrendChart, 100);
                    }

                    // Close progress modal
                    modal.hide();
                    setTimeout(() => {
                        try {
                            document.body.removeChild(progressModal);
                        } catch (e) {
                            console.log('Modal already removed');
                        }
                    }, 300);
                    
                    alert(`Successfully processed ${allProcessedData.length} vulnerability records!\nFinal dataset: ${vulnData.length} unique vulnerabilities`);
                    
                } catch (error) {
                    console.error('Error during finalization:', error);
                    modal.hide();
                    setTimeout(() => {
                        try {
                            document.body.removeChild(progressModal);
                        } catch (e) {
                            console.log('Modal already removed');
                        }
                    }, 300);
                    
                    // More specific error messages
                    if (error.message.includes('quota') || error.name === 'QuotaExceededError') {
                        alert(`Storage quota exceeded! The dataset is too large for browser storage. Try:\n1. Using a smaller CSV file\n2. Clearing existing data first\n3. Processing only Critical/High severity vulnerabilities`);
                    } else {
                        alert(`Processing completed but with errors: ${error.message}`);
                    }
                }
            }

            // Start processing
            setTimeout(processBatch, 100);
        }

        function calculateStatistics(data, date) {
            // Handle undefined or null data
            if (!data || !Array.isArray(data)) {
                console.warn('calculateStatistics called with invalid data:', data);
                return {
                    severityVPR: { critical: 0, high: 0, medium: 0, low: 0, info: 0 },
                    vendor: {},
                    total: 0,
                    date: date || new Date()
                };
            }

            const stats = {
                severityVPR: { critical: 0, high: 0, medium: 0, low: 0, info: 0 },
                vendor: {},
                total: data.length,
                date: date
            };

            data.forEach(item => {
                // Sum VPR scores by severity (simple approach)
                if (item.severity && stats.severityVPR.hasOwnProperty(item.severity)) {
                    stats.severityVPR[item.severity] += item.vprScore || 0;
                }
                
                // Count by vendor
                const vendor = item.vendor || 'Unknown';
                stats.vendor[vendor] = (stats.vendor[vendor] || 0) + 1;
            });

            return stats;
        }

        function updateStatCards(stats) {
            // Store current stats for comparison next time
            const currentStats = {
                critical: stats.severityVPR.critical,
                high: stats.severityVPR.high,
                medium: stats.severityVPR.medium,
                low: stats.severityVPR.low
            };

            // Update severity cards with VPR sums (rounded to 1 decimal)
            document.getElementById('criticalValue').textContent = stats.severityVPR.critical.toFixed(1);
            document.getElementById('highValue').textContent = stats.severityVPR.high.toFixed(1);
            document.getElementById('mediumValue').textContent = stats.severityVPR.medium.toFixed(1);
            document.getElementById('lowValue').textContent = stats.severityVPR.low.toFixed(1);
            document.getElementById('highValue').textContent = stats.severityVPR.high.toFixed(1);
            document.getElementById('mediumValue').textContent = stats.severityVPR.medium.toFixed(1);
            document.getElementById('lowValue').textContent = stats.severityVPR.low.toFixed(1);

            // Update change indicators if we have previous data
            if (previousStats) {
                updateChangeIndicator('critical', currentStats.critical, previousStats.critical);
                updateChangeIndicator('high', currentStats.high, previousStats.high);
                updateChangeIndicator('medium', currentStats.medium, previousStats.medium);
                updateChangeIndicator('low', currentStats.low, previousStats.low);
            }

            // Store current stats for next comparison
            previousStats = currentStats;
            
            // Create sparklines if we have historical data
            if (historyData.length > 1) {
                console.log(`üìä Creating sparklines with ${historyData.length} data points`);
                
                // Get current scoring preference (default to VPR)
                const scoreType = document.getElementById('scoreTypeSelect')?.value || 'VPR';
                const metricType = 'sum'; // Sparklines always show totals for now
                
                // Extract trend data based on scoring system
                let criticalTrend, highTrend, mediumTrend, lowTrend;
                
                if (scoreType === 'VPR') {
                    criticalTrend = historyData.slice(-7).map(h => h.stats.severityVPR ? h.stats.severityVPR.critical : 0);
                    highTrend = historyData.slice(-7).map(h => h.stats.severityVPR ? h.stats.severityVPR.high : 0);
                    mediumTrend = historyData.slice(-7).map(h => h.stats.severityVPR ? h.stats.severityVPR.medium : 0);
                    lowTrend = historyData.slice(-7).map(h => h.stats.severityVPR ? h.stats.severityVPR.low : 0);
                } else {
                    // CVSS trends (will be available once we have data with CVSS calculations)
                    criticalTrend = historyData.slice(-7).map(h => h.stats.severityCVSS ? h.stats.severityCVSS.critical : 0);
                    highTrend = historyData.slice(-7).map(h => h.stats.severityCVSS ? h.stats.severityCVSS.high : 0);
                    mediumTrend = historyData.slice(-7).map(h => h.stats.severityCVSS ? h.stats.severityCVSS.medium : 0);
                    lowTrend = historyData.slice(-7).map(h => h.stats.severityCVSS ? h.stats.severityCVSS.low : 0);
                }
                
                // Clear existing sparklines
                ['#criticalSparkline', '#highSparkline', '#mediumSparkline', '#lowSparkline'].forEach(id => {
                    const container = document.querySelector(id);
                    if (container) {
                        container.innerHTML = '';
                        console.log(`üßπ Cleared sparkline container ${id}`);
                    } else {
                        console.warn(`‚ö†Ô∏è Sparkline container ${id} not found`);
                    }
                });
                
                // Create new sparklines with error handling
                try {
                    createSeveritySparkline('#criticalSparkline', criticalTrend, '#ff6b6b', 'Critical');
                    createSeveritySparkline('#highSparkline', highTrend, '#ffa726', 'High');
                    createSeveritySparkline('#mediumSparkline', mediumTrend, '#42a5f5', 'Medium');
                    createSeveritySparkline('#lowSparkline', lowTrend, '#66bb6a', 'Low');
                } catch (error) {
                    console.error('‚ùå Error creating sparklines:', error);
                }
            } else {
                console.log(`üìä Not enough historical data for sparklines (${historyData.length} points)`);
            }
        }

        // Pagination functions
        function createPagination(containerId, currentPage, totalItems, itemsPerPage, onPageChange) {
            const container = document.getElementById(containerId);
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            
            if (totalPages <= 1) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = '';
            const pagination = container.querySelector('.pagination');
            pagination.innerHTML = '';
            
            // Previous button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = '<a class="page-link" href="#" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a>';
            if (currentPage > 1) {
                prevLi.querySelector('a').onclick = (e) => { e.preventDefault(); onPageChange(currentPage - 1); };
            }
            pagination.appendChild(prevLi);
            
            // Page numbers
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);
            
            if (startPage > 1) {
                const firstLi = document.createElement('li');
                firstLi.className = 'page-item';
                firstLi.innerHTML = '<a class="page-link" href="#">1</a>';
                firstLi.querySelector('a').onclick = (e) => { e.preventDefault(); onPageChange(1); };
                pagination.appendChild(firstLi);
                
                if (startPage > 2) {
                    const ellipsisLi = document.createElement('li');
                    ellipsisLi.className = 'page-item disabled';
                    ellipsisLi.innerHTML = '<span class="page-link">...</span>';
                    pagination.appendChild(ellipsisLi);
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                if (i !== currentPage) {
                    li.querySelector('a').onclick = (e) => { e.preventDefault(); onPageChange(i); };
                }
                pagination.appendChild(li);
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsisLi = document.createElement('li');
                    ellipsisLi.className = 'page-item disabled';
                    ellipsisLi.innerHTML = '<span class="page-link">...</span>';
                    pagination.appendChild(ellipsisLi);
                }
                
                const lastLi = document.createElement('li');
                lastLi.className = 'page-item';
                lastLi.innerHTML = `<a class="page-link" href="#">${totalPages}</a>`;
                lastLi.querySelector('a').onclick = (e) => { e.preventDefault(); onPageChange(totalPages); };
                pagination.appendChild(lastLi);
            }
            
            // Next button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = '<a class="page-link" href="#" aria-label="Next"><span aria-hidden="true">&raquo;</span></a>';
            if (currentPage < totalPages) {
                nextLi.querySelector('a').onclick = (e) => { e.preventDefault(); onPageChange(currentPage + 1); };
            }
            pagination.appendChild(nextLi);
        }
        
        function goToAssetPage(page) {
            currentAssetPage = page;
            updateAssetCards();
        }
        
        function goToVulnPage(page) {
            currentVulnPage = page;
            updateVulnCards();
        }

        function updateCardViews() {
            const currentView = document.querySelector('input[name="viewMode"]:checked').value;
            
            // Hide all containers first
            document.getElementById('assetCardsContainer').style.display = 'none';
            document.getElementById('vulnCardsContainer').style.display = 'none';
            document.getElementById('tableContainer').style.display = 'none';
            document.getElementById('assetPaginationContainer').style.display = 'none';
            document.getElementById('vulnPaginationContainer').style.display = 'none';
            document.getElementById('tablePaginationContainer').style.display = 'none';
            
            if (currentView === 'asset') {
                updateAssetCards();
                document.getElementById('assetCardsContainer').style.display = '';
                document.getElementById('assetPaginationContainer').style.display = '';
            } else if (currentView === 'vuln') {
                updateVulnCards();
                document.getElementById('vulnCardsContainer').style.display = '';
                document.getElementById('vulnPaginationContainer').style.display = '';
            } else if (currentView === 'table') {
                updateTableView();
                document.getElementById('tableContainer').style.display = '';
                document.getElementById('tablePaginationContainer').style.display = '';
            }
        }

        function filterAndDisplayData() {
            searchTerm = document.getElementById('searchInput').value.toLowerCase();
            severityFilter = document.getElementById('severityFilter').value;
            
            // Get ticket filter value
            const ticketFilterElement = document.getElementById('ticketFilter');
            const ticketFilter = ticketFilterElement ? ticketFilterElement.value : '';
            
            // Apply filters to window.vulnData (use real data instead of sample data)
            filteredData = (window.vulnData || []).filter(item => {
                const matchesSearch = !searchTerm || 
                    (item.hostname && item.hostname.toLowerCase().includes(searchTerm)) ||
                    (item.cve && item.cve.toLowerCase().includes(searchTerm)) ||
                    (item.definitionName && item.definitionName.toLowerCase().includes(searchTerm)) ||
                    (item.ipAddress && item.ipAddress.toLowerCase().includes(searchTerm)) ||
                    (item.vendor && item.vendor.toLowerCase().includes(searchTerm));
                
                const matchesSeverity = !severityFilter || (item.severity && item.severity.toLowerCase() === severityFilter);
                
                // Check ticket filter
                let matchesTickets = true;
                if (ticketFilter) {
                    const ticketStatus = getAssetTicketStatus(item.hostname);
                    switch (ticketFilter) {
                        case 'open':
                            matchesTickets = ticketStatus.status === 'open';
                            break;
                        case 'closed':
                            matchesTickets = ticketStatus.status === 'closed';
                            break;
                        case 'none':
                            matchesTickets = ticketStatus.status === 'none';
                            break;
                        default:
                            matchesTickets = true;
                    }
                }
                
                return matchesSearch && matchesSeverity && matchesTickets;
            });
            
            // Update the current view
            updateCardViews();
        }

        // Helper functions for CSV processing

        function updateDataStatus(message) {
            const statusElement = document.querySelector('[data-status="status"]');
            if (statusElement) {
                statusElement.textContent = message;
            } else {
                // Try to find any element that shows data status
                const dataStatusElements = document.querySelectorAll('*');
                for (let element of dataStatusElements) {
                    if (element.textContent && element.textContent.includes('No data uploaded yet')) {
                        element.textContent = message;
                        break;
                    }
                }
            }
            console.log(`üìä Data status updated: ${message}`);
        }

        function showToast(message, type = 'info') {
            // Simple toast implementation
            const toastContainer = document.getElementById('toastContainer') || document.body;
            const toast = document.createElement('div');
            toast.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} toast-message`;
            toast.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            toast.innerHTML = `
                <div class="d-flex align-items-center">
                    <span>${message}</span>
                    <button type="button" class="btn-close ms-auto" onclick="this.parentElement.parentElement.remove()"></button>
                </div>
            `;
            toastContainer.appendChild(toast);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 5000);
            
            console.log(`üçû Toast: ${message}`);
        }

        function saveHistoricalData(stats) {
            try {
                const historyKey = 'hextrackr_vulnerability_history';
                const existingHistory = JSON.parse(localStorage.getItem(historyKey) || '[]');
                
                const historyEntry = {
                    date: new Date().toISOString(),
                    stats: stats,
                    timestamp: Date.now()
                };
                
                existingHistory.push(historyEntry);
                
                // Keep only last 30 days of history
                const thirtyDaysAgo = Date.now() - (30 * 24 * 60 * 60 * 1000);
                const recentHistory = existingHistory.filter(entry => entry.timestamp > thirtyDaysAgo);
                
                localStorage.setItem(historyKey, JSON.stringify(recentHistory));
                console.log(`üìà Saved historical data point, ${recentHistory.length} total entries`);
                
            } catch (error) {
                console.error('‚ùå Failed to save historical data:', error);
            }
        }

        function updateAssetCards() {
            const container = document.getElementById('assetCardsContainer');
            
            if (!window.vulnData || window.vulnData.length === 0) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="card asset-card text-center py-5">
                            <div class="card-body">
                                <i class="fas fa-server fa-3x text-muted mb-3"></i>
                                <h4>No vulnerability data available</h4>
                                <p class="text-muted">Upload a CSV file to get started.</p>
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('assetPaginationContainer').style.display = 'none';
                return;
            }

            // Use filtered data if search/filter is active, otherwise use all data
            const dataToShow = searchTerm || severityFilter ? filteredData : window.vulnData;

            if (dataToShow.length === 0) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-info">
                            <i class="fas fa-search me-2"></i>No assets match your search criteria.
                        </div>
                    </div>
                `;
                document.getElementById('assetPaginationContainer').style.display = 'none';
                return;
            }

            // Group data by asset
            const assetGroups = {};
            dataToShow.forEach(item => {
                if (!assetGroups[item.hostname]) {
                    assetGroups[item.hostname] = {
                        hostname: item.hostname,
                        ipAddress: item.ip_address || item.ipAddress,
                        vendor: item.vendor || 'Unknown',
                        severityCounts: { critical: 0, high: 0, medium: 0, low: 0, info: 0 },
                        vulnerabilities: []
                    };
                }
                
                const severity = (item.severity || '').toLowerCase();
                if (assetGroups[item.hostname].severityCounts[severity] !== undefined) {
                    assetGroups[item.hostname].severityCounts[severity]++;
                }
                assetGroups[item.hostname].vulnerabilities.push(item);
            });

            const sortSelect = document.getElementById('sortSelect');
            const sortBy = sortSelect ? sortSelect.value : 'hostname-asc';
            
            // Parse the sort value (which now includes direction)
            let sortField, sortDirection;
            if (sortBy.includes('-')) {
                const parts = sortBy.split('-');
                sortField = parts[0];
                sortDirection = parts[1];
            } else {
                sortField = sortBy;
                sortDirection = 'asc';
            }
            
            const sortedAssets = Object.values(assetGroups).sort((a, b) => {
                let comparison = 0;
                
                if (sortField === 'hostname') {
                    comparison = a.hostname.localeCompare(b.hostname);
                } else if (sortField === 'total') {
                    comparison = (b.vulnerabilities.length) - (a.vulnerabilities.length);
                } else {
                    comparison = b.severityCounts[sortField] - a.severityCounts[sortField];
                }
                
                return sortDirection === 'desc' ? -comparison : comparison;
            });

            // Store current data for pagination
            currentAssetData = sortedAssets;
            
            // Calculate pagination
            const totalItems = sortedAssets.length;
            const startIndex = (currentAssetPage - 1) * assetItemsPerPage;
            const endIndex = startIndex + assetItemsPerPage;
            const paginatedAssets = sortedAssets.slice(startIndex, endIndex);

            container.innerHTML = paginatedAssets.map(asset => createAssetCard(asset)).join('');
            
            // Create pagination controls
            createPagination('assetPaginationContainer', currentAssetPage, totalItems, assetItemsPerPage, goToAssetPage);
        }

        function updateVulnCards() {
            const container = document.getElementById('vulnCardsContainer');
            
            if (!window.vulnData || window.vulnData.length === 0) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="card vuln-card text-center py-5">
                            <div class="card-body">
                                <i class="fas fa-bug fa-3x text-muted mb-3"></i>
                                <h4>No vulnerability data available</h4>
                                <p class="text-muted">Upload a CSV file to get started.</p>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            // Use filtered data if search/filter is active, otherwise use all data
            const dataToShow = searchTerm || severityFilter ? filteredData : vulnData;

            if (dataToShow.length === 0) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-info">
                            <i class="fas fa-search me-2"></i>No vulnerabilities match your search criteria.
                        </div>
                    </div>
                `;
                return;
            }

            // Group vulnerabilities by CVE/Definition ID
            const vulnGroups = {};
            dataToShow.forEach(item => {
                // Use CVE as primary key, fallback to definition ID
                const key = item.cve || item.definitionId || item.definitionName;
                if (!vulnGroups[key]) {
                    vulnGroups[key] = {
                        cve: item.cve,
                        definitionId: item.definitionId,
                        definitionName: item.definitionName,
                        severity: item.severity,
                        vprScore: item.vprScore,
                        vendor: item.vendor,
                        affectedAssets: [],
                        count: 0
                    };
                }
                
                vulnGroups[key].affectedAssets.push({
                    hostname: item.hostname,
                    ipAddress: item.ipAddress,
                    state: item.state,
                    date: item.date
                });
                vulnGroups[key].count++;
                
                // Use highest VPR score if multiple instances
                if (item.vprScore > vulnGroups[key].vprScore) {
                    vulnGroups[key].vprScore = item.vprScore;
                }
            });

            const sortSelect = document.getElementById('sortSelect');
            const sortBy = sortSelect ? sortSelect.value : 'severity-high';
            
            // Parse the sort value 
            let sortField, sortDirection;
            if (sortBy.includes('-')) {
                const parts = sortBy.split('-');
                sortField = parts[0];
                sortDirection = parts[1];
            } else {
                sortField = sortBy;
                sortDirection = 'desc';
            }
            
            let sortedVulns = Object.values(vulnGroups);
            
            if (sortBy === 'hostname') {
                sortedVulns.sort((a, b) => a.affectedAssets[0].hostname.localeCompare(b.affectedAssets[0].hostname));
            } else if (sortBy === 'critical' || sortBy === 'high' || sortBy === 'medium' || sortBy === 'low') {
                sortedVulns.sort((a, b) => {
                    if (a.severity === sortBy && b.severity !== sortBy) return -1;
                    if (a.severity !== sortBy && b.severity === sortBy) return 1;
                    return b.vprScore - a.vprScore;
                });
            } else {
                sortedVulns.sort((a, b) => b.vprScore - a.vprScore);
            }

            // Store current data for pagination
            currentVulnGroupData = sortedVulns;
            
            // Calculate pagination
            const totalItems = sortedVulns.length;
            const startIndex = (currentVulnPage - 1) * vulnItemsPerPage;
            const endIndex = startIndex + vulnItemsPerPage;
            const paginatedVulns = sortedVulns.slice(startIndex, endIndex);

            container.innerHTML = paginatedVulns.map(vuln => createVulnCard(vuln)).join('');
            
            // Create pagination controls
            createPagination('vulnPaginationContainer', currentVulnPage, totalItems, vulnItemsPerPage, goToVulnPage);
        }

        // Utility Functions
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        function applySorting(sortValue) {
            if (!window.vulnData || window.vulnData.length === 0) return;
            
            let dataToSort = filteredData && filteredData.length > 0 ? filteredData : window.vulnData;
            
            switch (sortValue) {
                case 'hostname-asc':
                    dataToSort.sort((a, b) => (a.hostname || '').localeCompare(b.hostname || ''));
                    break;
                case 'hostname-desc':
                    dataToSort.sort((a, b) => (b.hostname || '').localeCompare(a.hostname || ''));
                    break;
                case 'severity-high':
                    dataToSort.sort((a, b) => {
                        const severityOrder = { 'critical': 4, 'high': 3, 'medium': 2, 'low': 1, 'info': 0 };
                        return (severityOrder[b.severity?.toLowerCase()] || 0) - (severityOrder[a.severity?.toLowerCase()] || 0);
                    });
                    break;
                case 'severity-low':
                    dataToSort.sort((a, b) => {
                        const severityOrder = { 'critical': 4, 'high': 3, 'medium': 2, 'low': 1, 'info': 0 };
                        return (severityOrder[a.severity?.toLowerCase()] || 0) - (severityOrder[b.severity?.toLowerCase()] || 0);
                    });
                    break;
                case 'tickets-open':
                    dataToSort.sort((a, b) => {
                        const aTickets = getAssetTicketStatus(a.hostname);
                        const bTickets = getAssetTicketStatus(b.hostname);
                        return (bTickets.status === 'open' ? 1 : 0) - (aTickets.status === 'open' ? 1 : 0);
                    });
                    break;
                default:
                    // Default sort by hostname
                    dataToSort.sort((a, b) => (a.hostname || '').localeCompare(b.hostname || ''));
            }
            
            // Update the array references
            if (filteredData && filteredData.length > 0) {
                filteredData = [...dataToSort];
            } else {
                vulnData = [...dataToSort];
            }
        }
        
        function showToast(message, type = 'info') {
            // Create toast if it doesn't exist
            let toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toastContainer';
                toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
                toastContainer.style.zIndex = '9999';
                document.body.appendChild(toastContainer);
            }
            
            const toastId = 'toast-' + Date.now();
            const toast = document.createElement('div');
            toast.id = toastId;
            toast.className = 'toast show';
            toast.setAttribute('role', 'alert');
            
            const bgClass = type === 'success' ? 'bg-success' : type === 'error' ? 'bg-danger' : 'bg-primary';
            
            toast.innerHTML = `
                <div class="toast-header ${bgClass} text-white">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                    <strong class="me-auto">HexTrackr</strong>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            `;
            
            toastContainer.appendChild(toast);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (document.getElementById(toastId)) {
                    toast.remove();
                }
            }, 5000);
        }

        // Ticket Status Functions
        function getAssetTicketStatus(hostname) {
            // Check localStorage for ticket data from tickets page
            const ticketData = JSON.parse(localStorage.getItem('hextrackr_tickets') || '[]');
            const assetTickets = ticketData.filter(ticket => 
                ticket.device === hostname || ticket.hostname === hostname
            );
            
            if (assetTickets.length === 0) {
                return { status: 'none', count: 0, indicator: '' };
            }
            
            const openTickets = assetTickets.filter(ticket => 
                ticket.status === 'Open' || ticket.status === 'In Progress'
            ).length;
            
            const closedTickets = assetTickets.filter(ticket => 
                ticket.status === 'Closed' || ticket.status === 'Resolved'
            ).length;
            
            if (openTickets > 0) {
                return { 
                    status: 'open', 
                    count: openTickets, 
                    total: assetTickets.length,
                    indicator: `<span class="badge bg-warning text-dark me-2" title="${openTickets} open ticket(s)">
                        <i class="fas fa-ticket-alt me-1"></i>${openTickets}
                    </span>`
                };
            } else if (closedTickets > 0) {
                return { 
                    status: 'closed', 
                    count: closedTickets, 
                    total: assetTickets.length,
                    indicator: `<span class="badge bg-success me-2" title="${closedTickets} closed ticket(s)">
                        <i class="fas fa-check-circle me-1"></i>${closedTickets}
                    </span>`
                };
            }
            
            return { status: 'none', count: 0, indicator: '' };
        }
        
        function getTicketIndicator(ticketStatus) {
            if (ticketStatus.status === 'open') {
                return `<span class="badge bg-warning text-dark ms-2" title="Has ${ticketStatus.count} open ticket(s)">
                    <i class="fas fa-exclamation-triangle me-1"></i>Tickets
                </span>`;
            } else if (ticketStatus.status === 'closed') {
                return `<span class="badge bg-success ms-2" title="Has ${ticketStatus.count} closed ticket(s)">
                    <i class="fas fa-check-circle me-1"></i>Resolved
                </span>`;
            }
            return '';
        }
        
        // Filter Functions
        function applyTicketFilter(assets, filterValue) {
            if (!filterValue) return assets;
            
            return assets.filter(asset => {
                const ticketStatus = getAssetTicketStatus(asset.hostname);
                
                switch (filterValue) {
                    case 'open':
                        return ticketStatus.status === 'open';
                    case 'closed':
                        return ticketStatus.status === 'closed';
                    case 'none':
                        return ticketStatus.status === 'none';
                    default:
                        return true;
                }
            });
        }
        
        function refreshData() {
            // Refresh data and apply current filters
            console.log('üîÑ Refreshing data...');
            loadExistingData();
            updateCardViews();
            showToast('Data refreshed successfully!', 'success');
        }
        
        function exportData() {
            // Export current filtered data as CSV
            const data = currentAssetGroupData || vulnData;
            if (data.length === 0) {
                alert('No data to export');
                return;
            }
            
            // Convert to CSV
            const headers = ['Hostname', 'IP Address', 'Vendor', 'Critical', 'High', 'Medium', 'Low', 'Total', 'Ticket Status'];
            const csvData = data.map(asset => [
                asset.hostname,
                asset.ipAddress || '',
                asset.vendor || '',
                asset.severityCounts?.critical || 0,
                asset.severityCounts?.high || 0,
                asset.severityCounts?.medium || 0,
                asset.severityCounts?.low || 0,
                asset.vulnerabilities?.length || 0,
                getAssetTicketStatus(asset.hostname).status
            ]);
            
            const csv = [headers, ...csvData].map(row => row.map(field => `"${field}"`).join(',')).join('\n');
            
            // Download CSV file
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `hextrackr-export-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('Data exported successfully!', 'success');
        }

        function createAssetCard(asset) {
            const totalVulns = asset.vulnerabilities.length;
            const criticalCount = asset.severityCounts.critical;
            const highCount = asset.severityCounts.high;
            const mediumCount = asset.severityCounts.medium;
            const lowCount = asset.severityCounts.low;
            
            // Check for ticket status
            const ticketStatus = getAssetTicketStatus(asset.hostname);
            const ticketIndicator = getTicketIndicator(ticketStatus);
            
            return `
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card asset-card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0 asset-header" data-asset-hostname="${asset.hostname}" style="cursor: pointer;">
                                <i class="fas fa-server me-2"></i>${asset.hostname}
                                ${ticketIndicator}
                            </h6>
                            <div class="card-actions">
                                <button class="btn btn-sm btn-outline-primary me-1 asset-edit-btn" data-asset-hostname="${asset.hostname}" title="Edit Asset">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger asset-delete-btn" data-asset-hostname="${asset.hostname}" title="Delete Asset">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body asset-card-body" data-asset-hostname="${asset.hostname}" style="cursor: pointer;">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span class="vendor-badge">${asset.vendor}</span>
                                <p class="text-muted small mb-0">
                                    <i class="fas fa-network-wired me-1"></i>${asset.ipAddress || 'N/A'}
                                </p>
                            </div>
                            
                            <div class="row text-center">
                                <div class="col-3">
                                    <div class="severity-critical">
                                        <span class="severity-indicator"></span>
                                        <strong>${criticalCount}</strong>
                                    </div>
                                    <small class="text-muted">Critical</small>
                                </div>
                                <div class="col-3">
                                    <div class="severity-high">
                                        <span class="severity-indicator"></span>
                                        <strong>${highCount}</strong>
                                    </div>
                                    <small class="text-muted">High</small>
                                </div>
                                <div class="col-3">
                                    <div class="severity-medium">
                                        <span class="severity-indicator"></span>
                                        <strong>${mediumCount}</strong>
                                    </div>
                                    <small class="text-muted">Medium</small>
                                </div>
                                <div class="col-3">
                                    <div class="severity-low">
                                        <span class="severity-indicator"></span>
                                        <strong>${lowCount}</strong>
                                    </div>
                                    <small class="text-muted">Low</small>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer text-center">
                            <small class="text-muted">Total: ${totalVulns} vulnerabilities</small>
                        </div>
                    </div>
                </div>
            `;
        }

        function createVulnCard(vuln) {
            const severityColor = {
                critical: '#ff6b6b',
                high: '#ffa726', 
                medium: '#42a5f5',
                low: '#66bb6a',
                info: '#9e9e9e'
            };

            // Show first few affected assets
            const maxAssetsToShow = 3;
            const assetList = vuln.affectedAssets.slice(0, maxAssetsToShow)
                .map(asset => asset.hostname).join(', ');
            const remainingAssets = vuln.affectedAssets.length - maxAssetsToShow;

            return `
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card vuln-card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <small class="text-muted">${vuln.cve || vuln.definitionId}</small>
                            <div class="d-flex align-items-center">
                                <span class="badge me-2" style="background-color: ${severityColor[vuln.severity]}; color: white;">
                                    ${vuln.severity.toUpperCase()}
                                </span>
                                <div class="card-actions">
                                    <button class="btn btn-sm btn-outline-primary me-1 vuln-edit-btn" data-vuln-id="${vuln.definitionId}" title="Edit Vulnerability">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger vuln-delete-btn" data-vuln-id="${vuln.definitionId}" title="Delete Vulnerability">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body vuln-card-body" data-vuln-id="${vuln.definitionId}" data-vuln-name="${vuln.definitionName}" style="cursor: pointer;">
                            <h6 class="card-title">${vuln.definitionName.substring(0, 60)}${vuln.definitionName.length > 60 ? '...' : ''}</h6>
                            
                            <p class="card-text">
                                <strong>VPR Score:</strong> ${vuln.vprScore}<br>
                                <strong>Vendor:</strong> ${vuln.vendor}<br>
                                <strong>Affected Assets:</strong> ${vuln.count}
                            </p>
                            
                            <div class="small text-muted mt-2">
                                <strong>Assets:</strong> ${assetList}${remainingAssets > 0 ? ` +${remainingAssets} more` : ''}
                            </div>
                        </div>
                        <div class="card-footer">
                            <small class="text-muted">Total instances: ${vuln.count}</small>
                        </div>
                    </div>
                </div>
            `;
        }

        function updateTableView() {
            const tableBody = document.getElementById('tableBody');
            
            if (!window.vulnData || window.vulnData.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-5">
                            <i class="fas fa-bug fa-3x text-muted mb-3"></i>
                            <h5>No vulnerability data available</h5>
                            <p class="text-muted">Upload a CSV file to get started.</p>
                        </td>
                    </tr>
                `;
                return;
            }

            // Use filtered data if search/filter is active, otherwise use all data
            const dataToShow = searchTerm || severityFilter ? filteredData : vulnData;
            
            // Sort data
            const sortSelect = document.getElementById('sortSelect');
            const sortBy = sortSelect ? sortSelect.value : 'hostname-asc';
            let sortedData = [...dataToShow];
            
            // Parse the sort value
            let sortField, sortDirection;
            if (sortBy.includes('-')) {
                const parts = sortBy.split('-');
                sortField = parts[0];
                sortDirection = parts[1];
            } else {
                sortField = sortBy;
                sortDirection = 'asc';
            }
            
            if (sortField === 'hostname') {
                sortedData.sort((a, b) => {
                    const comparison = (a.hostname || '').localeCompare(b.hostname || '');
                    return sortDirection === 'desc' ? -comparison : comparison;
                });
            } else if (sortField === 'severity') {
                sortedData.sort((a, b) => {
                    const severityOrder = { 'critical': 4, 'high': 3, 'medium': 2, 'low': 1, 'info': 0 };
                    const aScore = severityOrder[a.severity?.toLowerCase()] || 0;
                    const bScore = severityOrder[b.severity?.toLowerCase()] || 0;
                    const comparison = bScore - aScore;
                    return sortDirection === 'low' ? -comparison : comparison;
                });
            } else {
                sortedData.sort((a, b) => (b.vprScore || 0) - (a.vprScore || 0));
            }

            // Pagination for table
            const totalItems = sortedData.length;
            const startIndex = (currentTablePage - 1) * tableItemsPerPage;
            const endIndex = startIndex + tableItemsPerPage;
            const paginatedData = sortedData.slice(startIndex, endIndex);

            // Create table rows
            tableBody.innerHTML = paginatedData.map(item => createTableRow(item)).join('');
            
            // Update pagination
            createPagination('tablePaginationContainer', currentTablePage, totalItems, tableItemsPerPage, goToTablePage);
        }

        function createTableRow(item) {
            const severityColors = {
                critical: '#dc3545',
                high: '#fd7e14', 
                medium: '#0d6efd',
                low: '#198754',
                info: '#6c757d'
            };

            const severityColor = severityColors[item.severity?.toLowerCase()] || '#6c757d';

            return `
                <tr>
                    <td>
                        <div class="d-flex align-items-center">
                            <i class="fas fa-server text-muted me-2"></i>
                            <span>${item.hostname || 'N/A'}</span>
                        </div>
                    </td>
                    <td>
                        <small class="text-muted">${item.ipAddress || 'N/A'}</small>
                    </td>
                    <td>
                        <code class="small">${item.cve || 'N/A'}</code>
                    </td>
                    <td>
                        <div class="text-truncate" style="max-width: 200px;" title="${item.definitionName || 'N/A'}">
                            ${(item.definitionName || 'N/A').substring(0, 50)}${(item.definitionName || '').length > 50 ? '...' : ''}
                        </div>
                    </td>
                    <td>
                        <span class="badge" style="background-color: ${severityColor}; color: white;">
                            ${(item.severity || 'Unknown').toUpperCase()}
                        </span>
                    </td>
                    <td>
                        <strong>${item.vprScore || 'N/A'}</strong>
                    </td>
                    <td>
                        <small class="text-muted">${item.vendor || 'Unknown'}</small>
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-outline-primary btn-sm table-edit-btn" data-vuln-id="${item.definitionId}" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-info btn-sm table-view-btn" data-vuln-id="${item.definitionId}" data-vuln-name="${item.definitionName}" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-outline-danger btn-sm table-delete-btn" data-vuln-id="${item.definitionId}" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }

        function goToTablePage(page) {
            currentTablePage = page;
            updateTableView();
        }

        function updateChangeIndicator(severity, currentValue, previousValue) {
            const changeElement = document.getElementById(`${severity}Change`);
            if (!changeElement) return;

            const difference = currentValue - previousValue;
            const percentChange = previousValue > 0 ? ((difference / previousValue) * 100) : 0;
            
            // Only show indicator if there's a significant change (>0.1)
            if (Math.abs(difference) < 0.1) {
                changeElement.style.display = 'none';
                return;
            }

            changeElement.style.display = 'flex';
            
            const icon = changeElement.querySelector('i');
            const valueSpan = changeElement.querySelector('.change-value');
            
            // Remove previous classes
            changeElement.classList.remove('increase', 'decrease', 'no-change');
            
            if (difference > 0) {
                // Increase is bad for vulnerabilities
                changeElement.classList.add('increase');
                icon.className = 'fas fa-arrow-up';
                valueSpan.textContent = `+${difference.toFixed(1)}`;
                valueSpan.title = `Increased by ${percentChange.toFixed(1)}%`;
            } else if (difference < 0) {
                // Decrease is good for vulnerabilities
                changeElement.classList.add('decrease');
                icon.className = 'fas fa-arrow-down';
                valueSpan.textContent = `${difference.toFixed(1)}`; // Already negative
                valueSpan.title = `Decreased by ${Math.abs(percentChange).toFixed(1)}%`;
            } else {
                changeElement.classList.add('no-change');
                icon.className = 'fas fa-minus';
                valueSpan.textContent = '0.0';
                valueSpan.title = 'No change';
            }
        }

        // Create small sparkline charts for severity indicators
        function createSeveritySparkline(containerId, data, color, title) {
            // Check if container exists before creating chart
            const container = document.querySelector(containerId);
            if (!container) {
                console.warn(`üö´ Sparkline container ${containerId} not found`);
                return null;
            }

            // Don't create chart if no data
            if (!data || data.length === 0) {
                console.warn(`üìä No data provided for sparkline ${containerId}`);
                return null;
            }

            const options = {
                series: [{
                    data: data
                }],
                chart: {
                    type: 'line',
                    width: '100%',
                    height: 50,
                    sparkline: {
                        enabled: true
                    }
                },
                stroke: {
                    curve: 'smooth',
                    width: 2
                },
                colors: [color],
                tooltip: {
                    fixed: {
                        enabled: false
                    },
                    x: {
                        show: false
                    },
                    y: {
                        title: {
                            formatter: function() {
                                return title + ': ';
                            }
                        }
                    },
                    marker: {
                        show: false
                    }
                }
            };

            try {
                const chart = new ApexCharts(container, options);
                chart.render();
                console.log(`‚úÖ Sparkline created for ${containerId}`);
                return chart;
            } catch (error) {
                console.error(`‚ùå Error creating sparkline for ${containerId}:`, error);
                return null;
            }
        }

        function showAssetDetails(hostname) {
            const asset = (window.vulnData || []).filter(v => v.hostname === hostname);
            if (asset.length === 0) return;

            const assetInfo = asset[0];
            const vulnerabilities = asset;

            const modalBody = document.getElementById('assetModalBody');
            modalBody.innerHTML = `
                <div class="row mb-3">
                    <div class="col-md-6">
                        <h6>Asset Information</h6>
                        <p><strong>Hostname:</strong> ${assetInfo.hostname}</p>
                        <p><strong>IP Address:</strong> ${assetInfo.ipAddress || 'N/A'}</p>
                        <p><strong>Vendor:</strong> ${assetInfo.vendor}</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Vulnerability Summary</h6>
                        <p><strong>Total Vulnerabilities:</strong> ${vulnerabilities.length}</p>
                        <p><strong>Critical:</strong> ${vulnerabilities.filter(v => v.severity === 'critical').length}</p>
                        <p><strong>High:</strong> ${vulnerabilities.filter(v => v.severity === 'high').length}</p>
                        <p><strong>Medium:</strong> ${vulnerabilities.filter(v => v.severity === 'medium').length}</p>
                        <p><strong>Low:</strong> ${vulnerabilities.filter(v => v.severity === 'low').length}</p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <h6>Vulnerabilities</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>CVE</th>
                                        <th>Name</th>
                                        <th>Severity</th>
                                        <th>VPR Score</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${vulnerabilities.map(v => `
                                        <tr>
                                            <td>${v.cve || v.definitionId}</td>
                                            <td>${v.definitionName.substring(0, 50)}${v.definitionName.length > 50 ? '...' : ''}</td>
                                            <td><span class="badge bg-${v.severity === 'critical' ? 'danger' : v.severity === 'high' ? 'warning' : v.severity === 'medium' ? 'info' : 'success'}">${v.severity.toUpperCase()}</span></td>
                                            <td>${v.vprScore}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;

            const modal = new bootstrap.Modal(document.getElementById('assetModal'));
            modal.show();
        }

        function showVulnDetails(definitionId, definitionName) {
            // Find all instances of this vulnerability across assets
            const vulnInstances = (window.vulnData || []).filter(v => 
                v.definitionId === definitionId || v.definitionName === definitionName
            );
            
            if (vulnInstances.length === 0) return;

            const vuln = vulnInstances[0]; // Use first instance for main details
            
            const modalBody = document.getElementById('vulnModalBody');
            modalBody.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Vulnerability Information</h6>
                        <p><strong>CVE:</strong> ${vuln.cve || 'N/A'}</p>
                        <p><strong>Definition ID:</strong> ${vuln.definitionId}</p>
                        <p><strong>Name:</strong> ${vuln.definitionName}</p>
                        <p><strong>Severity:</strong> <span class="badge bg-${vuln.severity === 'critical' ? 'danger' : vuln.severity === 'high' ? 'warning' : vuln.severity === 'medium' ? 'info' : 'success'}">${vuln.severity.toUpperCase()}</span></p>
                        <p><strong>VPR Score:</strong> ${vuln.vprScore}</p>
                        <p><strong>Vendor:</strong> ${vuln.vendor}</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Affected Assets (${vulnInstances.length})</h6>
                        <div class="table-responsive" style="max-height: 300px;">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Hostname</th>
                                        <th>IP Address</th>
                                        <th>State</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${vulnInstances.map(instance => `
                                        <tr>
                                            <td>${instance.hostname}</td>
                                            <td>${instance.ipAddress || 'N/A'}</td>
                                            <td><span class="badge bg-${instance.state === 'ACTIVE' ? 'warning' : 'success'}">${instance.state}</span></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;

            const modal = new bootstrap.Modal(document.getElementById('vulnModal'));
            modal.show();
        }

        function updateLastUploadInfo(filename, date, count) {
            const info = document.getElementById('lastUploadInfo');
            info.innerHTML = `
                <strong>File:</strong> ${filename} | 
                <strong>Date:</strong> ${date.toLocaleDateString()} | 
                <strong>Records:</strong> ${count}
            `;
        }

        function saveToHistory(filename, date, stats) {
            const historyEntry = {
                date: date.toISOString(),
                filename: filename,
                stats: stats
            };
            
            historyData.push(historyEntry);
            
            // Keep only last 30 entries
            if (historyData.length > 30) {
                historyData = historyData.slice(-30);
            }
            
            localStorage.setItem('vulnHistory', JSON.stringify(historyData));
        }

        function initializeSortable() {
            // Initialize sortable for both containers
            if (typeof Sortable !== 'undefined') {
                new Sortable(document.getElementById('assetCardsContainer'), {
                    animation: 150,
                    ghostClass: 'sortable-ghost'
                });
                
                new Sortable(document.getElementById('vulnCardsContainer'), {
                    animation: 150,
                    ghostClass: 'sortable-ghost'
                });
            }
        }

        function loadExistingData() {
            const savedData = localStorage.getItem('hextrackr_vuln_data');
            const savedHistory = localStorage.getItem('vulnHistory');
            
            if (savedHistory) {
                try {
                    historyData = JSON.parse(savedHistory);
                } catch (error) {
                    console.error('Error loading history data:', error);
                    historyData = [];
                }
            }
            
            if (savedData) {
                try {
                    vulnData = JSON.parse(savedData);
                    if (vulnData && Array.isArray(vulnData) && vulnData.length > 0) {
                        const stats = calculateStatistics(vulnData, new Date());
                        updateStatCards(stats);
                        updateCardViews();
                        
                        // Show trend chart instead of upload area if data exists
                        document.getElementById('uploadArea').style.display = 'none';
                        document.getElementById('trendChartSection').style.display = 'block';
                        // Update trend chart after a short delay to ensure DOM is ready
                        setTimeout(updateTrendChart, 100);
                    } else {
                        // Initialize empty data
                        vulnData = [];
                        updateStatCards({
                            severityVPR: { critical: 0, high: 0, medium: 0, low: 0, info: 0 },
                            vendor: {},
                            total: 0,
                            date: new Date()
                        });
                    }
                } catch (error) {
                    console.error('Error loading saved data:', error);
                    vulnData = []; // Reset to empty array on error
                }
            }
        }

        function showToast(message, type = 'info', duration = 3000) {
            // Create toast element
            const toast = document.createElement('div');
            toast.className = `alert alert-${type === 'info' ? 'primary' : type} alert-dismissible fade show position-fixed`;
            toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            toast.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // Add to page
            document.body.appendChild(toast);
            
            // Auto-remove after duration
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.classList.remove('show');
                    setTimeout(() => {
                        if (toast.parentNode) {
                            document.body.removeChild(toast);
                        }
                    }, 150);
                }
            }, duration);
        }

        function checkForDeviceFilter() {
            const urlParams = new URLSearchParams(window.location.search);
            const deviceName = urlParams.get('device');
            
            if (deviceName) {
                // Filter vulnerabilities by device
                searchTerm = deviceName;
                document.getElementById('searchInput').value = deviceName;
                
                // Apply the search filter
                applyFilters();
                
                // Show notification
                showToast(`Filtered to show vulnerabilities for device: ${deviceName}`, 'info', 5000);
                
                // Highlight the device filter in the UI
                setTimeout(() => {
                    const searchInput = document.getElementById('searchInput');
                    if (searchInput) {
                        searchInput.focus();
                        searchInput.select();
                    }
                }, 500);
                
                // Remove the parameter from URL to clean it up
                const url = new URL(window.location);
                url.searchParams.delete('device');
                window.history.replaceState({}, '', url);
            }
        }

        function loadSampleData() {
            // Sample data completely disabled - using real database data only
            vulnData = [];
            console.log('üö´ Sample data loading disabled - using real database data only');
            // const stats = calculateStatistics(vulnData, new Date());
            // updateStatCards(stats);
            // updateCardViews();
            
            // Add sample history for sparklines
            for (let i = 6; i >= 1; i--) {
                const pastDate = new Date();
                pastDate.setDate(pastDate.getDate() - i);
                
                historyData.push({
                    date: pastDate.toISOString(),
                    filename: `sample_data_${i}.csv`,
                    stats: {
                        severityVPR: {
                            critical: Math.max(0, 9.8 + (Math.random() - 0.5) * 3),
                            high: Math.max(0, 8.5 + (Math.random() - 0.5) * 2),
                            medium: Math.max(0, 5.2 + (Math.random() - 0.5) * 2),
                            low: Math.max(0, 2.1 + (Math.random() - 0.5) * 1)
                        }
                    }
                });
            }
            
            localStorage.setItem('vulnHistory', JSON.stringify(historyData));
            localStorage.setItem('hextrackr_vuln_data', JSON.stringify(vulnData));
        }

        // Fix the clear data function to work with SQLite
        async function clearVulnData() {
            if (!confirm('üóëÔ∏è Are you sure you want to clear ALL vulnerability data?\n\nThis action cannot be undone!')) {
                return;
            }
            
            try {
                // Clear database via API
                const response = await fetch('/api/vulnerabilities', {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to clear database: ${response.statusText}`);
                }
                
                console.log('‚úÖ Database cleared via API');
                
                // Clear localStorage as well
                localStorage.removeItem('hextrackr_vuln_data');
                localStorage.removeItem('hextrackr_vuln_history');
                localStorage.removeItem('vulnHistory');
                
                // Reset global variables
                vulnData = [];
                historyData = [];
                
                // Clear displays
                updateStatCards({
                    severityVPR: { critical: 0, high: 0, medium: 0, low: 0 },
                    vendor: {},
                    total: 0
                });
                
                // Clear card containers
                document.getElementById('assetCardsContainer').innerHTML = '<div class="col-12"><div class="alert alert-info text-center p-4"><h5 class="mb-2"><i class="fas fa-database me-2"></i>No Data Available</h5><p class="mb-0 text-muted">Upload vulnerability data to get started</p></div></div>';
                document.getElementById('vulnCardsContainer').innerHTML = '<div class="col-12"><div class="alert alert-info text-center p-4"><h5 class="mb-2"><i class="fas fa-shield-alt me-2"></i>No Vulnerabilities</h5><p class="mb-0 text-muted">Upload data to view vulnerabilities</p></div></div>';
                
                // Clear table view
                const tableContainer = document.getElementById('tableContainer');
                if (tableContainer) {
                    tableContainer.innerHTML = '<div class="alert alert-info text-center p-4"><h5 class="mb-2"><i class="fas fa-table me-2"></i>No Data Available</h5><p class="mb-0 text-muted">Upload vulnerability data to view in table format</p></div>';
                }
                
                // Hide trend chart and show upload area
                document.getElementById('trendChartSection').style.display = 'none';
                document.getElementById('uploadArea').style.display = 'block';
                
                // Clear upload info and show "No data uploaded"
                const uploadInfo = document.getElementById('lastUploadInfo');
                if (uploadInfo) {
                    uploadInfo.innerHTML = '<span class="text-muted">No data uploaded yet</span>';
                }
                
                // Clear sparklines
                ['criticalSparkline', 'highSparkline', 'mediumSparkline', 'lowSparkline'].forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.innerHTML = '';
                    }
                });
                
                alert('‚úÖ All vulnerability data has been cleared successfully!');
                
            } catch (error) {
                console.error('‚ùå Error clearing data:', error);
                alert('‚ö†Ô∏è Error clearing database: ' + error.message);
            }
        }

        // Edit and Delete Functions
        function editAsset(hostname) {
            const asset = vulnData.find(item => item.hostname === hostname);
            if (!asset) return;

            // Populate the edit form
            document.getElementById('editAssetOriginalHostname').value = hostname;
            document.getElementById('editAssetHostname').value = asset.hostname;
            document.getElementById('editAssetIP').value = asset.ipAddress || '';
            document.getElementById('editAssetVendor').value = asset.vendor || '';
            
            // Load risk level and notes if available
            document.getElementById('editAssetRiskLevel').value = asset.riskLevel || 'medium';
            document.getElementById('editAssetNotes').value = asset.notes || '';

            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('editAssetModal'));
            modal.show();
        }

        function saveAssetChanges() {
            const originalHostname = document.getElementById('editAssetOriginalHostname').value;
            const newHostname = document.getElementById('editAssetHostname').value;
            const newIP = document.getElementById('editAssetIP').value;
            const newVendor = document.getElementById('editAssetVendor').value;
            const riskLevel = document.getElementById('editAssetRiskLevel').value;
            const notes = document.getElementById('editAssetNotes').value;

            if (!newHostname.trim()) {
                alert('Hostname is required');
                return;
            }

            // Check if hostname changed and new hostname already exists
            if (originalHostname !== newHostname && vulnData.some(item => item.hostname === newHostname)) {
                alert('Hostname already exists');
                return;
            }

            // Update all vulnerabilities for this asset
            vulnData.forEach(item => {
                if (item.hostname === originalHostname) {
                    item.hostname = newHostname;
                    item.ipAddress = newIP;
                    item.vendor = newVendor;
                    item.riskLevel = riskLevel;
                    item.notes = notes;
                }
            });

            // Save to localStorage
            saveVulnData();

            // Refresh the display
            updateCardViews();

            // Close the modal
            bootstrap.Modal.getInstance(document.getElementById('editAssetModal')).hide();

            alert('Asset updated successfully');
        }

        // Add asset to ticket tracker with vulnerability analysis
        function addAssetToTicketTracker() {
            // Show immediate feedback that function was called
            alert('üé´ Add to Ticket Tracker function called! Check console for details.');
            console.log('üé´ addAssetToTicketTracker function called');
            
            const hostname = document.getElementById('editAssetHostname').value;
            const ipAddress = document.getElementById('editAssetIP').value;
            const vendor = document.getElementById('editAssetVendor').value;
            const riskLevel = document.getElementById('editAssetRiskLevel').value;
            const notes = document.getElementById('editAssetNotes').value;

            console.log('üìù Form values:', { hostname, ipAddress, vendor, riskLevel, notes });

            if (!hostname.trim()) {
                alert('Hostname is required');
                return;
            }

            // Get all vulnerabilities for this asset
            const assetVulns = vulnData.filter(v => v.hostname === hostname);
            const criticalCount = assetVulns.filter(v => v.severity === 'critical').length;
            const highCount = assetVulns.filter(v => v.severity === 'high').length;
            const totalVulns = assetVulns.length;

            console.log('üîç Vulnerability analysis:', { assetVulns: assetVulns.length, criticalCount, highCount, totalVulns });

            // Calculate risk score
            const riskScore = (criticalCount * 10) + (highCount * 5) + (assetVulns.filter(v => v.severity === 'medium').length * 2);

            // Create ticket data
            const ticketData = {
                id: 'TKT-' + Date.now(),
                title: `Security Remediation - ${hostname}`,
                description: `Asset: ${hostname} (${ipAddress})\nVendor: ${vendor}\n\nVulnerability Summary:\n- Critical: ${criticalCount}\n- High: ${highCount}\n- Total: ${totalVulns}\n\nRisk Score: ${riskScore}\n\nNotes: ${notes}`,
                priority: criticalCount > 0 ? 'critical' : highCount > 0 ? 'high' : 'medium',
                status: 'open',
                assignee: '',
                assetHostname: hostname,
                assetIP: ipAddress,
                vulnerabilityCount: totalVulns,
                riskScore: riskScore,
                createdDate: new Date().toISOString(),
                notes: notes
            };

            console.log('üé´ Created ticket data:', ticketData);

            // Store in localStorage for ticket tracker
            let tickets = JSON.parse(localStorage.getItem('hextrackr_tickets') || '[]');
            tickets.push(ticketData);
            localStorage.setItem('hextrackr_tickets', JSON.stringify(tickets));

            console.log('üíæ Ticket saved to localStorage. Total tickets:', tickets.length);

            // Show success message with option to open ticket tracker
            const confirmOpen = confirm(`‚úÖ Asset "${hostname}" added to ticket tracker!\n\nTicket ID: ${ticketData.id}\nPriority: ${ticketData.priority.toUpperCase()}\nRisk Score: ${riskScore}\n\nWould you like to open the Ticket Tracker to manage this work order?`);
            
            if (confirmOpen) {
                console.log('üîó Opening ticket tracker');
                window.open('tickets.html', '_blank');
            } else {
                console.log('‚ÑπÔ∏è User chose not to open ticket tracker');
            }

            // Close the edit modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('editAssetModal'));
            if (modal) {
                modal.hide();
                console.log('‚úÖ Closed edit asset modal');
            }
        }

        function deleteAsset(hostname) {
            const asset = vulnData.filter(item => item.hostname === hostname);
            if (!asset.length) return;

            const vulnCount = asset.length;
            if (confirm(`Are you sure you want to delete asset "${hostname}" and all ${vulnCount} associated vulnerabilities?`)) {
                // Remove all vulnerabilities for this asset
                vulnData = vulnData.filter(item => item.hostname !== hostname);

                // Save to localStorage
                saveVulnData();

                // Refresh the display
                updateCardViews();

                alert(`Asset "${hostname}" and ${vulnCount} vulnerabilities deleted successfully`);
            }
        }

        function editVulnerability(vulnId) {
            const vuln = vulnData.find(item => item.vulnId === vulnId);
            if (!vuln) return;

            // Populate the edit form
            document.getElementById('editVulnOriginalId').value = vulnId;
            document.getElementById('editVulnName').value = vuln.name || '';
            document.getElementById('editVulnCVE').value = vuln.cve || '';
            document.getElementById('editVulnSeverity').value = vuln.severity || '';
            document.getElementById('editVulnVPR').value = vuln.vprScore || '';
            document.getElementById('editVulnVendor').value = vuln.vendor || '';

            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('editVulnModal'));
            modal.show();
        }

        function saveVulnChanges() {
            const vulnId = document.getElementById('editVulnOriginalId').value;
            const newName = document.getElementById('editVulnName').value;
            const newCVE = document.getElementById('editVulnCVE').value;
            const newSeverity = document.getElementById('editVulnSeverity').value;
            const newVPR = document.getElementById('editVulnVPR').value;
            const newVendor = document.getElementById('editVulnVendor').value;

            if (!newName.trim()) {
                alert('Vulnerability name is required');
                return;
            }

            // Find and update the vulnerability
            const vulnIndex = vulnData.findIndex(item => item.vulnId === vulnId);
            if (vulnIndex !== -1) {
                vulnData[vulnIndex].name = newName;
                vulnData[vulnIndex].cve = newCVE;
                vulnData[vulnIndex].severity = newSeverity;
                vulnData[vulnIndex].vprScore = parseFloat(newVPR) || 0;
                vulnData[vulnIndex].vendor = newVendor;

                // Save to localStorage
                saveVulnData();

                // Refresh the display
                updateCardViews();

                // Close the modal
                bootstrap.Modal.getInstance(document.getElementById('editVulnModal')).hide();

                alert('Vulnerability updated successfully');
            }
        }

        function openHexagonTicket() {
            const vulnId = document.getElementById('editVulnOriginalId').value;
            const vuln = vulnData.find(item => item.vulnId === vulnId);
            
            if (!vuln) {
                alert('Vulnerability data not found');
                return;
            }

            // Use integration service to create ticket from vulnerability
            const ticket = window.integrationService.createTicketFromVulnerability({
                id: vulnId,
                cve_id: vuln.cve,
                severity: vuln.severity,
                vpr_score: vuln.vprScore,
                hostname: vuln.hostname,
                plugin_name: vuln.name,
                description: vuln.description || `Vulnerability: ${vuln.name}`,
                solution: vuln.solution || 'Refer to vendor documentation',
                location: vuln.location || 'Network Infrastructure',
                notes: vuln.notes
            });

            // Generate remediation template for easy copying
            const template = window.integrationService.generateRemediationTemplate({
                cve_id: vuln.cve,
                severity: vuln.severity,
                vpr_score: vuln.vprScore,
                hostname: vuln.hostname,
                plugin_name: vuln.name,
                description: vuln.description,
                solution: vuln.solution,
                notes: vuln.notes
            });

            // Show success message with options
            const result = confirm(`Hexagon Ticket Created Successfully!

Ticket ID: ${ticket.hexagonTicketNumber}
Device: ${vuln.hostname}
Severity: ${vuln.severity}

Would you like to:
- OK: Navigate to Ticket Management page
- Cancel: Copy remediation template to clipboard`);

            if (result) {
                // Navigate to tickets page with the new ticket highlighted
                window.location.href = `tickets.html?highlight=${ticket.id}`;
            } else {
                // Copy template to clipboard
                navigator.clipboard.writeText(template).then(() => {
                    alert('Remediation template copied to clipboard!');
                }).catch(() => {
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = template;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    alert('Remediation template copied to clipboard!');
                });
            }

            // Close the edit modal
            bootstrap.Modal.getInstance(document.getElementById('editVulnModal')).hide();
        }

        function deleteVulnerability(vulnId) {
            const vuln = vulnData.find(item => item.vulnId === vulnId);
            if (!vuln) return;

            if (confirm(`Are you sure you want to delete vulnerability "${vuln.name || vuln.cve}"?`)) {
                // Remove the vulnerability
                vulnData = vulnData.filter(item => item.vulnId !== vulnId);

                // Save to localStorage
                saveVulnData();

                // Refresh the display
                updateCardViews();

                alert('Vulnerability deleted successfully');
            }
        }

        // API Integration Functions - DISABLED
        function testCiscoAPI() {
            alert('Cisco API integration has been disabled for standalone operation.');
            return;
        }

        function testPaloAPI() {
            const apiKey = document.getElementById('paloApiKey').value;
            const host = document.getElementById('paloHost').value;

            if (!apiKey || !host) {
                alert('Please enter both API key and host');
                return;
            }

            // TODO: Implement actual Palo Alto API test
            alert('Palo Alto API test functionality will be implemented in a future version');
        }

        function testTenableAPI() {
            const accessKey = document.getElementById('tenableApiKey').value;
            const secretKey = document.getElementById('tenableSecret').value;

            if (!accessKey || !secretKey) {
                alert('Please enter both access key and secret key');
                return;
            }

            // TODO: Implement actual Tenable API test
            alert('Tenable API test functionality will be implemented in a future version');
        }

        function testQualysAPI() {
            const username = document.getElementById('qualysUsername').value;
            const password = document.getElementById('qualysPassword').value;

            if (!username || !password) {
                alert('Please enter both username and password');
                return;
            }

            // TODO: Implement actual Qualys API test
            alert('Qualys API test functionality will be implemented in a future version');
        }

        function syncFromAPIs() {
            alert('API synchronization functionality will be implemented in a future version');
        }

        // Show Tools & Settings Modal
        function showToolsModal() {
            console.log('üîß showToolsModal() called');
            
            try {
                const modalElement = document.getElementById('toolsModal');
                console.log('üìã Modal element found:', modalElement);
                
                if (!modalElement) {
                    console.error('‚ùå toolsModal element not found');
                    return;
                }
                
                const modal = new bootstrap.Modal(modalElement);
                console.log('üöÄ Bootstrap modal created:', modal);
                
                // Only load configurations that have corresponding form elements
                try {
                    if (document.getElementById('ciscoApiKey')) {
                        loadCiscoCredentials();
                        console.log('‚úÖ Cisco credentials loaded');
                    }
                } catch (error) {
                    console.error('‚ùå Error loading Cisco credentials:', error);
                }
                
                try {
                    if (document.getElementById('tursoUrl')) {
                        loadDatabaseConfig();
                        console.log('‚úÖ Database config loaded');
                    }
                } catch (error) {
                    console.error('‚ùå Error loading database config:', error);
                }
                
                modal.show();
                console.log('‚úÖ Modal.show() called - should be visible now');
            } catch (error) {
                console.error('‚ùå Error in showToolsModal():', error);
            }
        }

        // Load database configuration
        function loadDatabaseConfig() {
            const config = localStorage.getItem('hextrackr_turso_config');
            if (config) {
                try {
                    const parsed = JSON.parse(config);
                    document.getElementById('tursoUrl').value = parsed.url || '';
                    document.getElementById('tursoAuthToken').value = parsed.authToken || '';
                } catch (e) {
                    console.error('Error loading database config:', e);
                }
            }
        }

        // Test database connection
        function testDatabaseConnection() {
            const url = document.getElementById('tursoUrl').value.trim();
            const token = document.getElementById('tursoAuthToken').value.trim();
            
            if (!url && !token) {
                alert('‚úÖ Using local SQLite storage - no configuration needed!');
                return;
            }
            
            if (url && token) {
                // Test Turso connection if credentials provided
                if (window.tursoConfigManager) {
                    window.tursoConfigManager.testConnection(url, token);
                } else {
                    alert('‚ö†Ô∏è Turso service not available. Using local SQLite storage.');
                }
            } else {
                alert('‚ö†Ô∏è Please provide both URL and token for Turso cloud, or leave both empty for local SQLite.');
            }
        }

        // Initialize database
        function initializeDatabase() {
            const url = document.getElementById('tursoUrl').value.trim();
            const token = document.getElementById('tursoAuthToken').value.trim();
            
            if (url && token) {
                // Save Turso config and initialize
                const config = { url, authToken: token };
                localStorage.setItem('hextrackr_turso_config', JSON.stringify(config));
                
                if (window.tursoConfigManager) {
                    window.tursoConfigManager.connect(config);
                    alert('‚úÖ Turso cloud database configured successfully!');
                } else {
                    alert('‚ö†Ô∏è Turso service not available. Configuration saved for later.');
                }
            } else {
                alert('‚úÖ Local SQLite database is already initialized and ready to use!');
            }
        }

        // DEPRECATED: Turso backup/restore functions moved to /deprecated folder
        /*
        function backupToTurso() {
            if (window.syncVulnToTurso) {
                window.syncVulnToTurso();
                alert('üì§ Backup initiated - check console for progress.');
            } else {
                alert('‚ö†Ô∏è Backup service not available.');
            }
        }

        function restoreFromTurso() {
            if (window.restoreVulnFromTurso) {
                window.restoreVulnFromTurso();
                alert('üì• Restore initiated - check console for progress.');
            } else {
                alert('‚ö†Ô∏è Restore service not available.');
            }
        }
        */

        // Add Connect to APIs button functionality (legacy support)
        function showAPIModal() {
            showToolsModal(); // Redirect to new consolidated modal
        }

        function toggleUploadArea() {
            const uploadArea = document.getElementById('uploadArea');
            const trendSection = document.getElementById('trendChartSection');
            
            if (uploadArea.style.display === 'none') {
                uploadArea.style.display = 'block';
                trendSection.style.display = 'none';
            } else {
                uploadArea.style.display = 'none';
                trendSection.style.display = 'block';
                updateTrendChart();
            }
        }

        function updateTrendChart(scoreType = 'VPR', metricType = 'sum') {
            if (!historyData || historyData.length === 0) {
                document.getElementById('trendChart').innerHTML = '<div class="text-center text-muted py-5">No historical data available</div>';
                return;
            }

            // Prepare data for the chart based on scoreType and metricType
            const chartData = historyData.map(entry => {
                const stats = calculateStatistics(entry.data, entry.date);
                let dataSource;
                
                if (scoreType === 'VPR' && metricType === 'sum') {
                    dataSource = stats.severityVPR;
                } else if (scoreType === 'VPR' && metricType === 'avg') {
                    dataSource = stats.severityVPRAvg;
                } else if (scoreType === 'CVSS' && metricType === 'sum') {
                    dataSource = stats.severityCVSS;
                } else if (scoreType === 'CVSS' && metricType === 'avg') {
                    dataSource = stats.severityCVSSAvg;
                } else {
                    dataSource = stats.severityVPR; // default fallback
                }
                
                return {
                    date: new Date(entry.date).toLocaleDateString(),
                    critical: dataSource.critical || 0,
                    high: dataSource.high || 0,
                    medium: dataSource.medium || 0,
                    low: dataSource.low || 0
                };
            });

            const chartTitle = `Vulnerability ${scoreType} ${metricType === 'sum' ? 'Totals' : 'Averages'} Over Time`;
            const yAxisTitle = `${scoreType} Score ${metricType === 'sum' ? 'Sum' : 'Average'}`;

            const options = {
                series: [
                    {
                        name: 'Critical',
                        data: chartData.map(d => ({ x: d.date, y: d.critical }))
                    },
                    {
                        name: 'High',
                        data: chartData.map(d => ({ x: d.date, y: d.high }))
                    },
                    {
                        name: 'Medium',
                        data: chartData.map(d => ({ x: d.date, y: d.medium }))
                    },
                    {
                        name: 'Low',
                        data: chartData.map(d => ({ x: d.date, y: d.low }))
                    }
                ],
                chart: {
                    height: 300,
                    type: 'line',
                    zoom: {
                        enabled: false
                    },
                    toolbar: {
                        show: true
                    }
                },
                colors: ['#ff6b6b', '#ffa726', '#42a5f5', '#66bb6a'],
                dataLabels: {
                    enabled: false
                },
                stroke: {
                    curve: 'smooth',
                    width: 3
                },
                title: {
                    text: chartTitle,
                    align: 'left'
                },
                grid: {
                    borderColor: '#e7e7e7',
                    row: {
                        colors: ['#f3f3f3', 'transparent'],
                        opacity: 0.5
                    }
                },
                markers: {
                    size: 6
                },
                xaxis: {
                    type: 'category',
                    title: {
                        text: 'Upload Date'
                    }
                },
                yaxis: {
                    title: {
                        text: yAxisTitle
                    },
                    min: 0
                },
                legend: {
                    position: 'top',
                    horizontalAlign: 'right',
                    floating: true,
                    offsetY: -25,
                    offsetX: -5
                }
            };

            const chart = new ApexCharts(document.querySelector("#trendChart"), options);
            chart.render();
        }

        // UTILITY: Storage management functions
        function clearStorageData() {
            if (confirm('This will clear all stored vulnerability data. Are you sure?')) {
                localStorage.removeItem('hextrackr_vuln_data');
                localStorage.removeItem('hextrackr_vuln_history');
                alert('Storage cleared successfully. You can now upload a new large CSV file.');
                location.reload();
            }
        }

        function getStorageInfo() {
            try {
                const vulnData = localStorage.getItem('hextrackr_vuln_data');
                const historyData = localStorage.getItem('hextrackr_vuln_history');
                const totalUsage = JSON.stringify(localStorage).length;
                
                console.log('Storage Usage:');
                console.log(`- Vulnerability Data: ${vulnData ? (vulnData.length / 1024 / 1024).toFixed(2) : 0}MB`);
                console.log(`- History Data: ${historyData ? (historyData.length / 1024 / 1024).toFixed(2) : 0}MB`);
                console.log(`- Total Storage: ${(totalUsage / 1024 / 1024).toFixed(2)}MB`);
                console.log('Run clearStorageData() to free up space');
            } catch (e) {
                console.error('Could not check storage:', e);
            }
        }

        // Add storage info to console on load
        setTimeout(getStorageInfo, 1000);

        // ================================
        // üîê ENCRYPTION & API FUNCTIONS
        // ================================

        // Generate a device-specific encryption key (stays in browser only)
        function getEncryptionKey() {
            let key = localStorage.getItem('hextrackr_encryption_key');
            if (!key) {
                // Generate a new key based on device characteristics
                const deviceData = navigator.userAgent + navigator.language + screen.width + screen.height;
                key = CryptoJS.SHA256(deviceData + Date.now()).toString();
                localStorage.setItem('hextrackr_encryption_key', key);
            }
            return key;
        }

        // Encrypt sensitive data
        function encryptData(data) {
            try {
                const key = getEncryptionKey();
                return CryptoJS.AES.encrypt(JSON.stringify(data), key).toString();
            } catch (e) {
                console.error('Encryption failed:', e);
                return null;
            }
        }

        // Decrypt sensitive data
        function decryptData(encryptedData) {
            try {
                const key = getEncryptionKey();
                const bytes = CryptoJS.AES.decrypt(encryptedData, key);
                return JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
            } catch (e) {
                console.error('Decryption failed:', e);
                return null;
            }
        }

        // Show API Configuration Modal (legacy - redirects to Tools modal)
        function showAPIModal() {
            showToolsModal();
        }

        // Save Cisco credentials with encryption
        function saveCiscoCredentials() {
            const clientId = document.getElementById('ciscoApiKey').value.trim();
            const clientSecret = document.getElementById('ciscoSecret').value.trim();

            if (!clientId || !clientSecret) {
                alert('Please enter both Client ID and Client Secret');
                return;
            }

            const credentials = {
                clientId: clientId,
                clientSecret: clientSecret,
                savedAt: new Date().toISOString()
            };

            const encrypted = encryptData(credentials);
            if (encrypted) {
                localStorage.setItem('hextrackr_cisco_credentials', encrypted);
                const statusElement = document.getElementById('ciscoStatus');
                if (statusElement) {
                    statusElement.textContent = 'Configured';
                    statusElement.className = 'badge bg-success ms-2';
                }
                
                // Clear the input fields for security
                document.getElementById('ciscoApiKey').value = '';
                document.getElementById('ciscoSecret').value = '';
                
                alert('‚úÖ Cisco API credentials encrypted and saved securely!');
            } else {
                alert('‚ùå Failed to encrypt credentials. Please try again.');
            }
        }

        // Load Cisco credentials (decrypt and populate form)
        function loadCiscoCredentials() {
            const encrypted = localStorage.getItem('hextrackr_cisco_credentials');
            if (encrypted) {
                const credentials = decryptData(encrypted);
                if (credentials) {
                    // Use correct element IDs from the modal
                    const clientIdElement = document.getElementById('ciscoApiKey');
                    const clientSecretElement = document.getElementById('ciscoSecret');
                    const statusElement = document.getElementById('ciscoStatus');
                    
                    if (clientIdElement) clientIdElement.value = credentials.clientId;
                    if (clientSecretElement) clientSecretElement.value = credentials.clientSecret;
                    if (statusElement) {
                        statusElement.textContent = 'Configured';
                        statusElement.className = 'badge bg-success ms-2';
                    }
                } else {
                    const statusElement = document.getElementById('ciscoStatus');
                    if (statusElement) {
                        statusElement.textContent = 'Decryption Failed';
                        statusElement.className = 'badge bg-danger ms-2';
                    }
                }
            } else {
                const statusElement = document.getElementById('ciscoStatus');
                if (statusElement) {
                    statusElement.textContent = 'Not Configured';
                    statusElement.className = 'badge bg-secondary ms-2';
                }
            }
        }

        // Test Enhanced Cisco API connection
        async function testCiscoAPIEnhanced() {
            const clientId = document.getElementById('ciscoApiKey').value.trim();
            const clientSecret = document.getElementById('ciscoSecret').value.trim();

            if (!clientId || !clientSecret) {
                alert('Please enter credentials first');
                return;
            }

            const resultDiv = document.getElementById('ciscoTestResult');
            if (resultDiv) {
                resultDiv.style.display = 'block';
                resultDiv.className = 'alert alert-info';
                resultDiv.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Testing enhanced connection...';
            }

            try {
                // Initialize the enhanced API service
                if (typeof CiscoAPIServiceEnhanced !== 'undefined') {
                    const apiService = new CiscoAPIServiceEnhanced(clientId, clientSecret);
                    
                    // Test authentication
                    const token = await apiService.authenticate();
                    
                    if (token) {
                        if (resultDiv) {
                            resultDiv.className = 'alert alert-success';
                            resultDiv.innerHTML = `
                                <i class="fas fa-check-circle me-2"></i>
                                <strong>‚úÖ Enhanced Connection Successful!</strong><br>
                            <div class="mt-2">
                                <span class="badge bg-success me-1">Authentication</span>
                                <span class="badge bg-info me-1">Rate Limiting Active</span>
                                <span class="badge bg-warning">VPR Scoring Ready</span>
                            </div>
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="fas fa-link me-1"></i>
                                    <a href="https://developer.cisco.com/docs/security-advisories/" target="_blank">View API Documentation</a>
                                </small>
                            </div>
                            `;
                        }
                    } else {
                        throw new Error('Authentication failed');
                    }
                } else {
                    // Fallback to basic test
                    const tokenResponse = await fetch('https://cloudsso.cisco.com/as/token.oauth2', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'Accept': 'application/json'
                        },
                        body: `client_id=${encodeURIComponent(clientId)}&client_secret=${encodeURIComponent(clientSecret)}&grant_type=client_credentials`
                    });

                    if (tokenResponse.ok) {
                        const tokenData = await tokenResponse.json();
                        if (resultDiv) {
                            resultDiv.className = 'alert alert-success';
                            resultDiv.innerHTML = `
                                <i class="fas fa-check-circle me-2"></i>
                                <strong>‚úÖ Basic Connection Successful!</strong><br>
                                <small class="text-warning">Note: Load cisco-api-service-enhanced.js for full features</small>
                            `;
                        }
                    } else {
                        throw new Error(`Authentication failed: ${tokenResponse.status}`);
                    }
                }
            } catch (error) {
                if (resultDiv) {
                    resultDiv.className = 'alert alert-danger';
                    resultDiv.innerHTML = `
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>‚ùå Connection Failed!</strong><br>
                        Error: ${error.message}
                    `;
                }
            }
        }

        // Enhanced vulnerability sync - DISABLED
        async function syncCiscoVulnerabilitiesEnhanced() {
            alert('API integrations have been disabled for standalone operation. Please use CSV upload instead.');
            return;
        }

        // Quick login function - DISABLED
        async function quickLogin() {
            alert('Authentication functions have been disabled for standalone operation.');
            return false;
        }

        // Test Cisco API connection (via server proxy)
        async function testCiscoAPI() {
            // Use provided test credentials (swapped - Client ID is typically longer)
            const clientId = 'FScXCaVYjRJ6nxdSfpTd7Gu6';
            const clientSecret = 'na6st3rkeyddn7u3t8guavtj';

            console.log('üîß Testing Cisco API via server proxy...');
            
            const resultDiv = document.getElementById('ciscoTestResult');
            if (resultDiv) {
                resultDiv.style.display = 'block';
                resultDiv.className = 'alert alert-info';
                resultDiv.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Testing connection via server proxy...';
            }

            try {
                console.log('üì° Requesting OAuth token via server proxy...');
                
                // Get JWT token for API authentication
                let jwtToken = localStorage.getItem('hextrackr_jwt_token');
                if (!jwtToken) {
                    console.log('üîê No JWT token found, logging in as admin...');
                    const loginSuccess = await quickLogin();
                    if (!loginSuccess) {
                        throw new Error('Failed to login. Please check server connection.');
                    }
                    jwtToken = localStorage.getItem('hextrackr_jwt_token');
                }
                
                // Use server proxy to avoid CORS issues
                const tokenResponse = await fetch('/api/cisco/oauth/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${jwtToken}`
                    },
                    body: JSON.stringify({
                        client_id: clientId,
                        client_secret: clientSecret
                    })
                });

                console.log('üìä Proxy token response status:', tokenResponse.status);

                if (tokenResponse.ok) {
                    const tokenData = await tokenResponse.json();
                    console.log('‚úÖ Token obtained successfully via proxy!');
                    console.log('üîë Token type:', tokenData.token_type);
                    console.log('‚è∞ Expires in:', tokenData.expires_in, 'seconds');
                    
                    // Test API call with the token via proxy
                    const advisoryResponse = await fetch(`/api/cisco/advisories?access_token=${tokenData.access_token}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${jwtToken}`
                        }
                    });
                    
                    console.log('üìã Advisory API response status:', advisoryResponse.status);
                    
                    if (advisoryResponse.ok) {
                        const advisoryData = await advisoryResponse.json();
                        console.log('‚úÖ Successfully retrieved advisories via proxy!');
                        console.log('üìä Advisory count:', advisoryData.advisories?.length || 0);
                        
                        if (resultDiv) {
                            resultDiv.className = 'alert alert-success';
                            resultDiv.innerHTML = `
                                <i class="fas fa-check-circle me-2"></i>
                                <strong>‚úÖ Connection Successful!</strong><br>
                                <div class="mt-2">
                                    <span class="badge bg-success me-1">Authentication ‚úì</span>
                                    <span class="badge bg-info me-1">Server Proxy ‚úì</span>
                                    <span class="badge bg-primary me-1">API Access ‚úì</span>
                                    <span class="badge bg-warning">Advisories: ${advisoryData.advisories?.length || 0}</span>
                                </div>
                                <div class="mt-2">
                                    <small class="text-success">
                                        üéâ CORS issue resolved! Using server-side proxy.<br>
                                        Token expires in ${tokenData.expires_in} seconds
                                    </small>
                                </div>
                            `;
                        }
                        
                        // Store the token temporarily for potential additional testing
                        window.ciscoAccessToken = tokenData.access_token;
                        console.log('üéâ Cisco API test completed successfully via proxy!');
                        
                    } else {
                        const errorData = await advisoryResponse.json().catch(() => ({ error: 'Unknown error' }));
                        console.error('‚ùå Advisory API failed:', errorData);
                        throw new Error(`Advisory API failed: ${advisoryResponse.status} - ${errorData.error || 'Unknown error'}`);
                    }
                } else {
                    const errorData = await tokenResponse.json().catch(() => ({ error: 'Unknown error' }));
                    console.error('‚ùå Token request failed:', errorData);
                    throw new Error(`Authentication failed: ${tokenResponse.status} - ${errorData.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('‚ùå Test failed with error:', error);
                
                if (resultDiv) {
                    resultDiv.className = 'alert alert-danger';
                    resultDiv.innerHTML = `
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>‚ùå Connection Failed!</strong><br>
                        ${error.message}
                        <div class="mt-2">
                            <small class="text-muted">
                                Check console for detailed error information.<br>
                                Make sure the server is running and you're logged in.
                            </small>
                        </div>
                    `;
                }
            }
        }

        // Sync Cisco vulnerabilities using API
        async function syncCiscoVulnerabilities() {
            const encrypted = localStorage.getItem('hextrackr_cisco_credentials');
            if (!encrypted) {
                alert('Please configure Cisco API credentials first');
                return;
            }

            const credentials = decryptData(encrypted);
            if (!credentials) {
                alert('Failed to decrypt credentials. Please reconfigure.');
                return;
            }

            const progressDiv = document.getElementById('syncProgress');
            const statusDiv = document.getElementById('syncStatus');
            const progressBar = progressDiv.querySelector('.progress-bar');

            progressDiv.style.display = 'block';
            statusDiv.textContent = 'Authenticating with Cisco API...';
            progressBar.style.width = '10%';

            try {
                // Step 1: Get OAuth token
                const tokenResponse = await fetch('https://cloudsso.cisco.com/as/token.oauth2', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'Accept': 'application/json'
                    },
                    body: `client_id=${encodeURIComponent(credentials.clientId)}&client_secret=${encodeURIComponent(credentials.clientSecret)}&grant_type=client_credentials`
                });

                if (!tokenResponse.ok) {
                    throw new Error('Authentication failed');
                }

                const tokenData = await tokenResponse.json();
                progressBar.style.width = '30%';
                statusDiv.textContent = 'Fetching vulnerability data...';

                // Step 2: Get recent CVEs (last 30 days)
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                const startDate = thirtyDaysAgo.toISOString().split('T')[0];
                const endDate = new Date().toISOString().split('T')[0];

                const vulnResponse = await fetch(`https://api.cisco.com/security/advisories/v2/advisories?startDate=${startDate}&endDate=${endDate}&limit=100`, {
                    headers: {
                        'Authorization': `Bearer ${tokenData.access_token}`,
                        'Accept': 'application/json'
                    }
                });

                if (!vulnResponse.ok) {
                    throw new Error('Failed to fetch vulnerabilities');
                }

                const vulnData = await vulnResponse.json();
                progressBar.style.width = '70%';
                statusDiv.textContent = 'Processing vulnerability data...';

                // Step 3: Transform API data to our format (only the 8 fields we care about)
                const transformedData = vulnData.advisories?.map(advisory => {
                    return {
                        hostname: 'Unknown Asset', // This would come from your asset inventory
                        ipAddress: 'Unknown IP', // This would come from your asset inventory
                        cve: advisory.cves?.length > 0 ? advisory.cves[0] : advisory.advisoryId,
                        definitionName: advisory.advisoryTitle || advisory.summary,
                        severity: mapCiscoSeverity(advisory.sir),
                        vprScore: mapSeverityToScore(advisory.sir),
                        vendor: 'Cisco',
                        date: new Date(advisory.publicationUrl || advisory.lastUpdated).toLocaleDateString(),
                        definitionId: advisory.advisoryId,
                        state: 'ACTIVE'
                    };
                }) || [];

                progressBar.style.width = '90%';
                statusDiv.textContent = 'Updating local database...';

                // Step 4: Merge with existing data
                const existingData = JSON.parse(localStorage.getItem('hextrackr_vuln_data') || '[]');
                const mergedData = [...existingData, ...transformedData];
                
                // Remove duplicates
                const uniqueData = mergedData.filter((item, index, array) => 
                    array.findIndex(other => other.cve === item.cve && other.hostname === item.hostname) === index
                );

                // Save to localStorage
                localStorage.setItem('hextrackr_vuln_data', JSON.stringify(uniqueData));
                window.vulnData = uniqueData;

                progressBar.style.width = '100%';
                statusDiv.textContent = `‚úÖ Successfully synced ${transformedData.length} vulnerabilities from Cisco API`;

                // Refresh the display
                filterAndDisplayData();

                // Hide progress after 3 seconds
                setTimeout(() => {
                    progressDiv.style.display = 'none';
                    statusDiv.textContent = '';
                }, 3000);

                alert(`‚úÖ Successfully synced ${transformedData.length} Cisco vulnerabilities!\nOnly essential fields were imported to optimize performance.`);

            } catch (error) {
                progressBar.style.width = '0%';
                statusDiv.textContent = `‚ùå Sync failed: ${error.message}`;
                progressDiv.style.display = 'none';
                alert(`‚ùå Sync failed: ${error.message}`);
            }
        }

        // Map Cisco severity to our format
        function mapCiscoSeverity(sir) {
            if (!sir) return 'info';
            const severity = sir.toLowerCase();
            if (severity.includes('critical')) return 'critical';
            if (severity.includes('high')) return 'high';
            if (severity.includes('medium')) return 'medium';
            if (severity.includes('low')) return 'low';
            return 'info';
        }

        // Map severity to numeric score
        function mapSeverityToScore(sir) {
            const severity = mapCiscoSeverity(sir);
            switch (severity) {
                case 'critical': return 9.5;
                case 'high': return 7.5;
                case 'medium': return 5.0;
                case 'low': return 2.5;
                default: return 1.0;
            }
        }

        // Sync Cisco Security Advisories
        async function syncCiscoAdvisories() {
            alert('Security Advisories sync feature coming soon! This will pull detailed advisory information.');
        }

        // Clear all encrypted API credentials
        function clearAPICredentials() {
            if (confirm('‚ö†Ô∏è Are you sure you want to clear all API credentials? This cannot be undone.')) {
                localStorage.removeItem('hextrackr_cisco_credentials');
                localStorage.removeItem('hextrackr_encryption_key');
                
                const clientIdElement = document.getElementById('ciscoApiKey');
                const clientSecretElement = document.getElementById('ciscoSecret');
                const statusElement = document.getElementById('ciscoStatus');
                
                if (clientIdElement) clientIdElement.value = '';
                if (clientSecretElement) clientSecretElement.value = '';
                if (statusElement) {
                    statusElement.textContent = 'Not Configured';
                    statusElement.className = 'badge bg-secondary ms-2';
                }
                alert('‚úÖ All API credentials have been cleared.');
            }
        }

        // Check API configuration on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Check if Cisco credentials are configured
            const encrypted = localStorage.getItem('hextrackr_cisco_credentials');
            if (encrypted) {
                const credentials = decryptData(encrypted);
                if (credentials) {
                    document.getElementById('ciscoStatus').textContent = 'Configured';
                    document.getElementById('ciscoStatus').className = 'badge bg-success ms-2';
                }
            }

            // Add event listeners for new navigation controls
            const searchInput = document.getElementById('searchInput');
            const severityFilter = document.getElementById('severityFilter');
            const ticketFilter = document.getElementById('ticketFilter');
            const sortSelect = document.getElementById('sortSelect');
            const clearSearchBtn = document.getElementById('clearSearch');
            
            if (searchInput) {
                searchInput.addEventListener('input', debounce(filterAndDisplayData, 300));
            }
            
            if (clearSearchBtn) {
                clearSearchBtn.addEventListener('click', function() {
                    searchInput.value = '';
                    filterAndDisplayData();
                });
            }
            
            if (severityFilter) {
                severityFilter.addEventListener('change', filterAndDisplayData);
            }
            
            if (ticketFilter) {
                ticketFilter.addEventListener('change', filterAndDisplayData);
            }
            
            if (sortSelect) {
                sortSelect.addEventListener('change', function() {
                    applySorting(this.value);
                    updateCardViews();
                });
            }
            
            // View mode change handlers (if radio buttons exist)
            const viewModeRadios = document.querySelectorAll('input[name="viewMode"]');
            viewModeRadios.forEach(radio => {
                radio.addEventListener('change', updateCardViews);
            });

            // Initialize Turso integration
            setTimeout(async () => {
                try {
                    const storedConfig = localStorage.getItem('hextrackr_turso_config');
                    if (storedConfig) {
                        const config = JSON.parse(storedConfig);
                        if (config.url && config.authToken) {
                            await window.tursoService.initialize(config);
                            console.log('‚úÖ Turso initialized for vulnerabilities');
                        }
                    }
                } catch (error) {
                    console.log('‚ÑπÔ∏è Turso auto-initialization failed for vulnerabilities:', error.message);
                }
            }, 1000);
        });

        // DEPRECATED: Turso Database Integration moved to /deprecated folder
        /*
        // Turso Database Integration for Vulnerabilities
        // Auto-sync vulnerability data to Turso when data changes
        window.syncVulnToTurso = async function() {
            if (!window.tursoService || !window.tursoService.isConnected) {
                console.log('Turso not connected - skipping vulnerability sync');
                return;
            }

            try {
                console.log('üîÑ Syncing vulnerability data to Turso...');
                
                // Prepare vulnerability data for backup
                const vulnDataToSync = vulnData.map(vuln => ({
                    ...vuln,
                    type: 'vulnerability',
                    source: 'vulnerabilities_page',
                    synced_at: new Date().toISOString()
                }));

                await window.tursoService.backup('vulnerabilities', vulnDataToSync, {
                    compress: true,
                    encrypt: true,
                    onProgress: (progress) => {
                        console.log(`Vulnerability sync progress: ${progress.percentage}%`);
                    }
                });

                console.log('‚úÖ Vulnerability data synced to Turso successfully');
                
            } catch (error) {
                console.error('‚ùå Failed to sync vulnerabilities to Turso:', error);
            }
        };

        // Restore vulnerability data from Turso
        window.restoreVulnFromTurso = async function() {
            if (!window.tursoService || !window.tursoService.isConnected) {
                console.log('Turso not connected - cannot restore vulnerabilities');
                return;
            }

            try {
                console.log('üîÑ Restoring vulnerability data from Turso...');
                
                const result = await window.tursoService.restore('vulnerabilities');
                
                if (result.success && result.data) {
                    // Filter vulnerability data from this page
                    const restoredVulns = result.data.filter(item => 
                        item.type === 'vulnerability' && 
                        (item.source === 'vulnerabilities_page' || !item.source)
                    );
                    
                    if (restoredVulns.length > 0) {
                        vulnData = restoredVulns;
                        localStorage.setItem('hextrackr_vuln_data', JSON.stringify(vulnData));
                        
                        // Refresh the display
                        updateCardViews();
                        updateStatistics();
                        
                        console.log(`‚úÖ Restored ${restoredVulns.length} vulnerabilities from Turso`);
                        alert(`Successfully restored ${restoredVulns.length} vulnerabilities from Turso database`);
                    } else {
                        console.log('‚ÑπÔ∏è No vulnerability data found in backup');
                        alert('No vulnerability data found in the latest backup');
                    }
                } else {
                    console.log('‚ÑπÔ∏è No backup data found');
                    alert('No backup data found in Turso database');
                }
                
            } catch (error) {
                console.error('‚ùå Failed to restore vulnerabilities from Turso:', error);
                alert('Failed to restore vulnerability data from Turso: ' + error.message);
            }
        };

        // Auto-sync vulnerability data when it changes
        window.autoSyncVulnData = function() {
            if (window.tursoService && window.tursoService.isConnected) {
                setTimeout(() => {
                    window.syncVulnToTurso();
                }, 1000);
            }
        };

        // Override data modification functions to trigger auto-sync
        const originalProcessVulnData = window.processVulnData;
        if (originalProcessVulnData) {
            window.processVulnData = function(data, file) {
                const result = originalProcessVulnData(data, file);
                window.autoSyncVulnData();
                return result;
            };
        }

        // Expose Turso functions globally for vulnerabilities page
        window.syncVulnToTurso = window.syncVulnToTurso;
        window.restoreVulnFromTurso = window.restoreVulnFromTurso;
    </script>
</body>
</html>
