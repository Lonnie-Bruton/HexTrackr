#!/bin/sh
# Pre-commit: run markdownlint only on staged Markdown files

# Get staged Markdown files (Added, Copied, Modified)
STAGED_MD_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.md$' || true)

if [ -z "$STAGED_MD_FILES" ]; then
  echo "[pre-commit] No staged Markdown files. Skipping markdownlint."
  exit 0
fi

# Respect ignore file and config
CONFIG_FILE=".markdownlint.json"
IGNORE_FILE=".markdownlintignore"

if [ ! -f "$CONFIG_FILE" ]; then
  echo "[pre-commit] Warning: $CONFIG_FILE not found; using markdownlint defaults."
fi

if [ ! -f "$IGNORE_FILE" ]; then
  echo "[pre-commit] Note: $IGNORE_FILE not found; no extra ignores applied."
fi

# Run markdownlint against staged files only
./node_modules/.bin/markdownlint --config "$CONFIG_FILE" --ignore-path "$IGNORE_FILE" $STAGED_MD_FILES
STATUS=$?

if [ $STATUS -ne 0 ]; then
  echo "\n[pre-commit] markdownlint failed. Please fix issues or run: npm run lint:md"
  exit $STATUS
fi

echo "[pre-commit] markdownlint passed."
exit 0
