#!/bin/sh
# Enhanced pre-commit: run quality checks on staged files

echo "[pre-commit] Running code quality checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Track overall status
OVERALL_STATUS=0

# ============================================================================
# MARKDOWN LINTING with Auto-fix
# ============================================================================
STAGED_MD_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.md$' || true)

if [ -n "$STAGED_MD_FILES" ]; then
  echo "\n${YELLOW}[pre-commit]${NC} Checking Markdown files..."
  
  # Run auto-fix first using official markdownlint
  echo "${YELLOW}[pre-commit]${NC} Auto-fixing Markdown issues..."
  npx markdownlint --fix --disable MD013 MD046 -- $STAGED_MD_FILES
  
  # Re-stage auto-fixed files
  git add $STAGED_MD_FILES
  
  # Run validation (disable MD013 line-length and MD046 code-block-style)
  npx markdownlint --disable MD013 MD046 -- $STAGED_MD_FILES
  MD_STATUS=$?
  
  if [ $MD_STATUS -ne 0 ]; then
    echo "${RED}[pre-commit]${NC} Markdownlint validation failed after auto-fix"
    OVERALL_STATUS=1
  else
    echo "${GREEN}[pre-commit]${NC} Markdown validation passed"
  fi
fi

# ============================================================================
# CSS/SCSS LINTING with Auto-fix
# ============================================================================
STAGED_CSS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(css|scss)$' || true)

if [ -n "$STAGED_CSS_FILES" ]; then
  echo "\n${YELLOW}[pre-commit]${NC} Checking CSS/SCSS files..."
  
  # Run auto-fix first
  echo "${YELLOW}[pre-commit]${NC} Auto-fixing CSS issues..."
  ./node_modules/.bin/stylelint --fix $STAGED_CSS_FILES
  
  # Re-stage auto-fixed files
  git add $STAGED_CSS_FILES
  
  # Run validation
  ./node_modules/.bin/stylelint $STAGED_CSS_FILES
  CSS_STATUS=$?
  
  if [ $CSS_STATUS -ne 0 ]; then
    echo "${RED}[pre-commit]${NC} Stylelint validation failed after auto-fix"
    OVERALL_STATUS=1
  else
    echo "${GREEN}[pre-commit]${NC} CSS validation passed"
  fi
fi

# ============================================================================
# JAVASCRIPT LINTING with Selective Auto-fix
# ============================================================================
STAGED_JS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.js$' | grep -v '\.min\.js$' || true)

if [ -n "$STAGED_JS_FILES" ]; then
  echo "\n${YELLOW}[pre-commit]${NC} Checking JavaScript files..."
  
  # Run auto-fix for safe issues only
  echo "${YELLOW}[pre-commit]${NC} Auto-fixing safe JavaScript issues..."
  ./node_modules/.bin/eslint --fix --fix-type suggestion,layout --config eslint.config.mjs $STAGED_JS_FILES
  
  # Re-stage auto-fixed files
  git add $STAGED_JS_FILES
  
  # Run full validation
  ./node_modules/.bin/eslint --config eslint.config.mjs $STAGED_JS_FILES
  JS_STATUS=$?
  
  if [ $JS_STATUS -ne 0 ]; then
    echo "${RED}[pre-commit]${NC} ESLint validation failed"
    echo "${YELLOW}[pre-commit]${NC} Run 'npm run eslint' to see details"
    OVERALL_STATUS=1
  else
    echo "${GREEN}[pre-commit]${NC} JavaScript validation passed"
  fi
fi

# ============================================================================
# FINAL RESULT
# ============================================================================
if [ $OVERALL_STATUS -ne 0 ]; then
  echo "\n${RED}[pre-commit]${NC} Code quality checks failed. Please fix issues before committing."
  echo "${YELLOW}[pre-commit]${NC} Tip: Some issues were auto-fixed and staged. Review changes with 'git diff --cached'"
  exit $OVERALL_STATUS
fi

echo "\n${GREEN}[pre-commit]${NC} All code quality checks passed! âœ…"
exit 0
